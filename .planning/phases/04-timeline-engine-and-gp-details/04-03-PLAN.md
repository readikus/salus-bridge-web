---
phase: 04-timeline-engine-and-gp-details
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - providers/repositories/employee.repository.ts
  - providers/repositories/medical-consent.repository.ts
  - providers/services/gp.service.ts
  - app/api/employees/[id]/gp-details/route.ts
  - app/api/employees/[id]/consent/route.ts
  - app/api/organisations/[slug]/consent/route.ts
  - actions/gp-details.ts
  - components/gp-details-form/index.tsx
  - components/consent-form/index.tsx
  - components/consent-status-badge/index.tsx
  - app/(authenticated)/my-profile/page.tsx
autonomous: true

must_haves:
  truths:
    - "Employee can add their GP name and address to their profile"
    - "Employee can complete a consent form granting permission for medical records access"
    - "HR can see the consent status for employees in their organisation"
  artifacts:
    - path: "providers/repositories/medical-consent.repository.ts"
      provides: "CRUD for medical_records_consent table"
      exports: ["MedicalConsentRepository"]
    - path: "providers/services/gp.service.ts"
      provides: "GP details update and consent management logic"
      exports: ["GpService"]
    - path: "app/api/employees/[id]/gp-details/route.ts"
      provides: "GET and PUT endpoints for employee GP details"
      exports: ["GET", "PUT"]
    - path: "app/api/employees/[id]/consent/route.ts"
      provides: "GET and POST endpoints for employee consent"
      exports: ["GET", "POST"]
    - path: "app/api/organisations/[slug]/consent/route.ts"
      provides: "GET endpoint listing all employee consent statuses for HR"
      exports: ["GET"]
    - path: "components/gp-details-form/index.tsx"
      provides: "Form for employee to enter GP name, address, phone"
      exports: ["GpDetailsForm"]
    - path: "components/consent-form/index.tsx"
      provides: "Consent form with explanation and grant/revoke actions"
      exports: ["ConsentForm"]
  key_links:
    - from: "app/api/employees/[id]/gp-details/route.ts"
      to: "providers/repositories/employee.repository.ts"
      via: "updateGpDetails method"
      pattern: "updateGpDetails"
    - from: "app/api/employees/[id]/consent/route.ts"
      to: "providers/services/gp.service.ts"
      via: "grantConsent/revokeConsent methods"
      pattern: "grantConsent|revokeConsent"
    - from: "app/api/organisations/[slug]/consent/route.ts"
      to: "providers/repositories/medical-consent.repository.ts"
      via: "findByOrganisation with employee details"
      pattern: "findByOrganisation"
---

<objective>
Build the GP details storage and medical records consent workflow: employee can store GP info, grant/revoke medical records consent, and HR can view consent status across the organisation.

Purpose: Implements GP-01 (store GP details), GP-02 (consent form), and GP-03 (consent status visible to HR).
Output: GP details form on employee profile, consent form with grant/revoke, and HR consent overview.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-timeline-engine-and-gp-details/04-01-SUMMARY.md

@providers/repositories/employee.repository.ts
@providers/repositories/trigger-config.repository.ts
@app/api/employees/[id]/route.ts
@schemas/gp-details.ts
@types/database.ts
@constants/permissions.ts
@providers/services/tenant.service.ts
@app/(authenticated)/my-profile/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create repositories, service, and API routes for GP details and consent</name>
  <files>
    providers/repositories/employee.repository.ts
    providers/repositories/medical-consent.repository.ts
    providers/services/gp.service.ts
    app/api/employees/[id]/gp-details/route.ts
    app/api/employees/[id]/consent/route.ts
    app/api/organisations/[slug]/consent/route.ts
    actions/gp-details.ts
  </files>
  <action>
**providers/repositories/employee.repository.ts** -- Add method to existing class (do NOT rewrite existing methods):

Add `updateGpDetails` static method:
```typescript
static async updateGpDetails(
  employeeId: string,
  data: { gpName?: string | null; gpAddress?: string | null; gpPhone?: string | null },
  client?: PoolClient
): Promise<void>
```
Build dynamic SET clauses like TriggerConfigRepository.update does. Update gp_name, gp_address, gp_phone columns. Always SET updated_at = NOW().

Add `getGpDetails` static method:
```typescript
static async getGpDetails(employeeId: string, client?: PoolClient): Promise<{ gpName: string | null; gpAddress: string | null; gpPhone: string | null } | null>
```
SELECT gp_name AS "gpName", gp_address AS "gpAddress", gp_phone AS "gpPhone" FROM employees WHERE id = $1.

**providers/repositories/medical-consent.repository.ts** -- New file following TriggerConfigRepository pattern:

Static class with SELECT_COLUMNS alias pattern. Methods:
- `findByEmployee(employeeId, client?)` -- SELECT WHERE employee_id = $1 (returns single row or null due to UNIQUE constraint)
- `findByOrganisation(orgId, client?)` -- SELECT with JOIN to employees and users to get employee name and email. Returns `MedicalRecordsConsentWithEmployee[]`. JOIN: `LEFT JOIN employees e ON mc.employee_id = e.id LEFT JOIN users u ON e.user_id = u.id`. Select employee first_name, last_name from users, email from users.
- `upsert(data: { organisationId, employeeId, consentedBy, consentStatus, notes? }, client?)` -- Use INSERT ... ON CONFLICT (employee_id) DO UPDATE. Set consent_date = NOW() when status is 'GRANTED', set revoked_date = NOW() when status is 'REVOKED'. RETURNING all columns.
- `findById(id, client?)` -- SELECT WHERE id = $1

**providers/services/gp.service.ts** -- Business logic:

```typescript
export class GpService {
  /**
   * Update GP details for an employee.
   * Only the employee themselves (matched via userId on employee record) can update.
   */
  static async updateGpDetails(
    employeeId: string,
    data: GpDetailsInput,
    userId: string,
    organisationId: string,
    client?: PoolClient
  ): Promise<void>

  /**
   * Grant medical records consent for an employee.
   * Creates or updates the consent record with status GRANTED.
   */
  static async grantConsent(
    employeeId: string,
    userId: string,
    organisationId: string,
    notes?: string,
    client?: PoolClient
  ): Promise<MedicalRecordsConsent>

  /**
   * Revoke medical records consent.
   */
  static async revokeConsent(
    employeeId: string,
    userId: string,
    organisationId: string,
    notes?: string,
    client?: PoolClient
  ): Promise<MedicalRecordsConsent>
}
```

Each method should:
1. Perform the repository operation
2. Create an audit log entry (GP_DETAILS for GP updates, MEDICAL_CONSENT for consent changes)
3. Use appropriate AuditActions (UPDATE for GP details, CONSENT for granting, REVOKE for revoking)

**app/api/employees/[id]/gp-details/route.ts** -- Follow existing employees/[id]/route.ts pattern:

GET: Auth check -> employee must be the requesting user (match employee.userId === sessionUser.id) OR user has VIEW_GP_DETAILS permission -> TenantService.withTenant -> EmployeeRepository.getGpDetails -> return { gpDetails }

PUT: Auth check -> employee must be the requesting user (own data only, per MANAGE_GP_DETAILS which is granted to EMPLOYEE role) OR user has MANAGE_GP_DETAILS permission -> validate body with gpDetailsSchema -> TenantService.withTenant -> GpService.updateGpDetails -> return { success: true }

For the ownership check: load the employee, verify employee.userId === sessionUser.id. This ensures employees can only edit their own GP details.

**app/api/employees/[id]/consent/route.ts** -- Consent endpoint:

GET: Auth check -> own employee OR VIEW_CONSENT permission -> TenantService.withTenant -> MedicalConsentRepository.findByEmployee -> return { consent } (or null if no consent record)

POST: Auth check -> own employee OR MANAGE_CONSENT permission -> validate body with medicalConsentSchema -> TenantService.withTenant -> call GpService.grantConsent or GpService.revokeConsent based on consentStatus -> return { consent }

**app/api/organisations/[slug]/consent/route.ts** -- HR consent overview:

GET: Auth check -> VIEW_CONSENT permission on org -> TenantService.withTenant -> MedicalConsentRepository.findByOrganisation -> return { consents }

This gives HR a list of all employees with their consent status.

**actions/gp-details.ts** -- Client-side fetch wrappers:
- `fetchGpDetails(employeeId)` -- GET /api/employees/{id}/gp-details -> { gpDetails }
- `updateGpDetails(employeeId, data)` -- PUT /api/employees/{id}/gp-details -> { success }
- `fetchConsent(employeeId)` -- GET /api/employees/{id}/consent -> { consent }
- `submitConsent(employeeId, data)` -- POST /api/employees/{id}/consent -> { consent }
- `fetchOrgConsents(slug)` -- GET /api/organisations/{slug}/consent -> { consents }
  </action>
  <verify>
Run TypeScript type check:
```bash
npx tsc --noEmit
```
Verify all new files exist and compile. Verify employee.repository.ts still compiles with existing methods intact.
  </verify>
  <done>MedicalConsentRepository has upsert and query methods. GpService handles GP detail updates and consent grant/revoke with audit logging. API routes enforce ownership checks (employees edit own data) and permission checks (HR can view). Actions provide client-side wrappers. TypeScript compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Create GP details form, consent form, consent badge, and integrate into profile page</name>
  <files>
    components/gp-details-form/index.tsx
    components/consent-form/index.tsx
    components/consent-status-badge/index.tsx
    app/(authenticated)/my-profile/page.tsx
  </files>
  <action>
**components/gp-details-form/index.tsx** -- GP details form component:

"use client" component. Props: `{ employeeId: string; onSaved?: () => void }`

Uses React Hook Form + zodResolver with gpDetailsSchema. Fields:
- gpName: text Input, label "GP Name / Practice Name"
- gpAddress: Textarea, label "GP Address", placeholder "Enter GP surgery address"
- gpPhone: text Input, label "GP Phone Number"

On mount, fetches existing GP details via fetchGpDetails(employeeId) and populates form with reset(). On submit, calls updateGpDetails action. Shows success message or error. Uses shadcn Card wrapping with heading "GP Details" and description "Your registered GP information. This is used if we need to request medical records."

Save button with loading state (isSaving). Success feedback via a green banner or toast.

**components/consent-form/index.tsx** -- Medical records consent form:

"use client" component. Props: `{ employeeId: string; onChanged?: () => void }`

On mount, fetches current consent status via fetchConsent(employeeId).

Display states:
1. **No consent record (null)**: Show explanation text about medical records consent, what it means, why it's needed. Prominent "Grant Consent" button.
2. **GRANTED**: Show green badge "Consent Granted" with date. Show revoke option with confirmation. Text: "You have granted permission for your employer to request medical records from your GP on your behalf." Show "Revoke Consent" button (red variant, with confirmation dialog).
3. **REVOKED**: Show amber/yellow badge "Consent Revoked" with date. Show "Re-grant Consent" button.

Consent explanation text (required for informed consent):
"By granting consent, you authorise your employer to request relevant medical records from your GP in relation to your absence from work. This consent can be revoked at any time. Your GP details must be provided before consent can be granted."

On grant: validate that GP details exist (gpName must be set). If not, show message "Please add your GP details above before granting consent." Call submitConsent with { consentStatus: "GRANTED" }.

On revoke: show confirmation dialog ("Are you sure you want to revoke consent?"). Call submitConsent with { consentStatus: "REVOKED" }.

Optional notes field (Textarea) for the employee to add notes when granting/revoking.

Use shadcn Card, Button, Badge, AlertDialog (for revoke confirmation), Textarea.

**components/consent-status-badge/index.tsx** -- Small badge component for consent status:

Props: `{ status: string | null | undefined }`

Returns a shadcn Badge with:
- null/undefined: `<Badge variant="outline">No Consent</Badge>` (gray)
- "PENDING": `<Badge variant="outline">Pending</Badge>` (gray)
- "GRANTED": `<Badge variant="default" className="bg-green-100 text-green-800">Granted</Badge>`
- "REVOKED": `<Badge variant="destructive">Revoked</Badge>`

Named export: `ConsentStatusBadge`.

**app/(authenticated)/my-profile/page.tsx** -- Modify existing profile page:

Read the existing page first. Add two new sections below existing profile content:

1. **GP Details section**: Render `<GpDetailsForm employeeId={employeeId} />`. The employeeId should come from the current user's employee record (fetched from the existing profile data or via a new fetch).

2. **Medical Records Consent section**: Render `<ConsentForm employeeId={employeeId} />`.

If the current user is not linked to an employee record (e.g. platform admin), do not show these sections. Show them only when the user has an associated employee.

Wrap each section with spacing (e.g. `<div className="mt-8 space-y-8">`).
  </action>
  <verify>
Run TypeScript type check:
```bash
npx tsc --noEmit
```
Verify all 4 component files exist and compile.
  </verify>
  <done>GP details form allows employee to enter GP name, address, phone on their profile. Consent form shows explanation, grant/revoke buttons with confirmation. ConsentStatusBadge renders colour-coded status. My Profile page includes both GP and consent sections for employees. TypeScript compiles.</done>
</task>

</tasks>

<verification>
1. Employee can update GP details via PUT /api/employees/{id}/gp-details (ownership enforced)
2. Employee can grant/revoke consent via POST /api/employees/{id}/consent (ownership enforced)
3. HR can view all consent statuses via GET /api/organisations/{slug}/consent
4. GP details form loads existing data and saves updates
5. Consent form shows explanation, allows grant with notes, allows revoke with confirmation
6. My Profile page shows GP details and consent sections for employees
7. ConsentStatusBadge renders correct colours for all states
8. Audit logs created for GP detail updates and consent changes
9. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Employee can enter GP name, address, phone on their profile page
- Employee can read consent explanation and click "Grant Consent"
- Employee can revoke consent with confirmation
- Consent status is stored and retrievable
- HR can see consent statuses for all employees in their organisation
- All operations are audit logged
</success_criteria>

<output>
After completion, create `.planning/phases/04-timeline-engine-and-gp-details/04-03-SUMMARY.md`
</output>
