---
phase: 04-timeline-engine-and-gp-details
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/migrations/20260218000001_create_milestone_configs.ts
  - database/migrations/20260218000002_add_gp_details_and_consent.ts
  - types/database.ts
  - types/enums.ts
  - constants/permissions.ts
  - constants/milestone-defaults.ts
  - schemas/milestone-config.ts
  - schemas/gp-details.ts
autonomous: true

must_haves:
  truths:
    - "Milestone config table exists with default milestone definitions and org-level overrides"
    - "GP details columns exist on employees table"
    - "Medical records consent table exists with status tracking"
    - "New audit entities and permissions are registered for milestone configs, GP details, and consent"
  artifacts:
    - path: "database/migrations/20260218000001_create_milestone_configs.ts"
      provides: "milestone_configs table with defaults and org overrides"
      contains: "CREATE TABLE milestone_configs"
    - path: "database/migrations/20260218000002_add_gp_details_and_consent.ts"
      provides: "GP columns on employees and medical_records_consent table"
      contains: "medical_records_consent"
    - path: "constants/milestone-defaults.ts"
      provides: "Default milestone definitions with day offsets and labels"
      exports: ["DEFAULT_MILESTONES"]
    - path: "schemas/milestone-config.ts"
      provides: "Zod validation for milestone config create/update"
      exports: ["createMilestoneConfigSchema", "updateMilestoneConfigSchema"]
    - path: "schemas/gp-details.ts"
      provides: "Zod validation for GP details and consent"
      exports: ["gpDetailsSchema", "medicalConsentSchema"]
  key_links:
    - from: "constants/milestone-defaults.ts"
      to: "types/database.ts"
      via: "MilestoneConfig interface"
      pattern: "MilestoneConfig"
    - from: "constants/permissions.ts"
      to: "types/enums.ts"
      via: "New audit entities for MILESTONE_CONFIG and MEDICAL_CONSENT"
      pattern: "MILESTONE_CONFIG|MEDICAL_CONSENT"
---

<objective>
Create the database schema, types, constants, permissions, and validation schemas for the milestone timeline engine and GP details/consent features.

Purpose: Establish the data foundation that Plan 02 (timeline engine) and Plan 03 (GP/consent UI) will build on.
Output: Two migrations, updated types/enums/permissions, default milestone constants, and Zod schemas.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@database/migrations/20260216000001_create_trigger_configs.ts
@types/database.ts
@types/enums.ts
@constants/permissions.ts
@schemas/trigger-config.ts
@database/migrations/20260214000003_create_employees.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create milestone configs migration and GP details/consent migration</name>
  <files>
    database/migrations/20260218000001_create_milestone_configs.ts
    database/migrations/20260218000002_add_gp_details_and_consent.ts
  </files>
  <action>
**Migration 1: `20260218000001_create_milestone_configs.ts`**

Create `milestone_configs` table following the trigger_configs pattern (see @database/migrations/20260216000001_create_trigger_configs.ts):

```sql
CREATE TABLE milestone_configs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organisation_id UUID REFERENCES organisations(id) ON DELETE CASCADE,
  milestone_key VARCHAR(50) NOT NULL,
  label VARCHAR(100) NOT NULL,
  day_offset INTEGER NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  is_default BOOLEAN DEFAULT false,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
)
```

Key design:
- `organisation_id` is NULLABLE. Rows with NULL org_id are system defaults (seeded). Rows with an org_id are org-level overrides.
- `milestone_key` is a stable identifier like `DAY_1`, `DAY_3`, `DAY_7`, `WEEK_2`, `WEEK_3`, `WEEK_4`, `WEEK_6`, `WEEK_10`, `WEEK_14` (repeating), `WEEK_52`. Used to match defaults with overrides.
- `day_offset` is the number of calendar days from absence start (1, 3, 7, 14, 21, 28, 42, 70, 98, 364).
- `is_default` = true for the system-seeded rows (where organisation_id IS NULL).
- `is_active` allows org admins to disable specific milestones.

Add indexes:
- `idx_milestone_configs_org ON milestone_configs(organisation_id)`
- `idx_milestone_configs_key ON milestone_configs(milestone_key)`
- Unique constraint: `UNIQUE(organisation_id, milestone_key)` to prevent duplicate overrides per org. For defaults (org_id IS NULL), use a partial unique index: `CREATE UNIQUE INDEX idx_milestone_configs_default_key ON milestone_configs(milestone_key) WHERE organisation_id IS NULL`.

Enable RLS following trigger_configs pattern:
```sql
ALTER TABLE milestone_configs ENABLE ROW LEVEL SECURITY;

CREATE POLICY milestone_configs_org_isolation ON milestone_configs
FOR ALL
USING (
  organisation_id IS NULL
  OR organisation_id::text = current_setting('app.current_organisation_id', true)
  OR current_setting('app.is_platform_admin', true) = 'true'
)
```

Seed default milestones in the migration (INSERT with is_default=true, organisation_id=NULL):
- DAY_1 (1): "Day 1 - Absence Reported"
- DAY_3 (3): "Day 3 - GP Visit Reminder"
- DAY_7 (7): "Day 7 - Long-Term Transition"
- WEEK_2 (14): "Week 2 - Check-in"
- WEEK_3 (21): "Week 3 - Fit Note Renewal"
- WEEK_4 (28): "Week 4 - GP/OH Report Request"
- WEEK_6 (42): "Week 6 - Plan of Action"
- WEEK_10 (70): "Week 10 - First Evaluation"
- WEEK_14 (98): "Week 14 - Evaluation"
- WEEK_18 (126): "Week 18 - Evaluation"
- WEEK_22 (154): "Week 22 - Evaluation"
- WEEK_26 (182): "Week 26 - Evaluation"
- WEEK_30 (210): "Week 30 - Evaluation"
- WEEK_34 (238): "Week 34 - Evaluation"
- WEEK_38 (266): "Week 38 - Evaluation"
- WEEK_42 (294): "Week 42 - Evaluation"
- WEEK_46 (322): "Week 46 - Evaluation"
- WEEK_50 (350): "Week 50 - Evaluation"
- WEEK_52 (364): "Week 52 - Capability Review"

The `down()` should delete seed data and drop the table.

**Migration 2: `20260218000002_add_gp_details_and_consent.ts`**

Add GP detail columns to existing employees table:
```sql
ALTER TABLE employees ADD COLUMN gp_name VARCHAR(255);
ALTER TABLE employees ADD COLUMN gp_address TEXT;
ALTER TABLE employees ADD COLUMN gp_phone VARCHAR(50);
```

Create `medical_records_consent` table:
```sql
CREATE TABLE medical_records_consent (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organisation_id UUID NOT NULL REFERENCES organisations(id) ON DELETE CASCADE,
  employee_id UUID NOT NULL REFERENCES employees(id) ON DELETE CASCADE,
  consented_by UUID NOT NULL REFERENCES users(id),
  consent_status VARCHAR(30) NOT NULL DEFAULT 'PENDING',
  consent_date TIMESTAMPTZ,
  revoked_date TIMESTAMPTZ,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
)
```

- consent_status values: 'PENDING', 'GRANTED', 'REVOKED'
- consent_date set when status moves to GRANTED
- revoked_date set when status moves to REVOKED

Indexes:
- `idx_medical_consent_org ON medical_records_consent(organisation_id)`
- `idx_medical_consent_employee ON medical_records_consent(employee_id)`
- `UNIQUE(employee_id)` -- one consent record per employee (upsert pattern)

RLS:
```sql
ALTER TABLE medical_records_consent ENABLE ROW LEVEL SECURITY;

CREATE POLICY medical_consent_org_isolation ON medical_records_consent
FOR ALL
USING (
  organisation_id::text = current_setting('app.current_organisation_id', true)
  OR current_setting('app.is_platform_admin', true) = 'true'
)
```

The `down()` should drop the consent table, then ALTER TABLE employees DROP COLUMN for each GP column.
  </action>
  <verify>
Check both migration files exist and have valid TypeScript syntax:
```bash
npx tsc --noEmit database/migrations/20260218000001_create_milestone_configs.ts database/migrations/20260218000002_add_gp_details_and_consent.ts
```
  </verify>
  <done>Both migrations exist with correct SQL, RLS policies, indexes, and seed data for default milestones. Down migrations reverse all changes cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Add types, enums, permissions, constants, and Zod schemas</name>
  <files>
    types/database.ts
    types/enums.ts
    constants/permissions.ts
    constants/milestone-defaults.ts
    schemas/milestone-config.ts
    schemas/gp-details.ts
  </files>
  <action>
**types/database.ts** -- Add interfaces (follow existing patterns, camelCase fields):

```typescript
export interface MilestoneConfig {
  id: string;
  organisationId: string | null;
  milestoneKey: string;
  label: string;
  dayOffset: number;
  description: string | null;
  isActive: boolean;
  isDefault: boolean;
  createdBy: string | null;
  createdAt: Date;
  updatedAt: Date;
}

export interface MedicalRecordsConsent {
  id: string;
  organisationId: string;
  employeeId: string;
  consentedBy: string;
  consentStatus: string;
  consentDate: Date | null;
  revokedDate: Date | null;
  notes: string | null;
  createdAt: Date;
  updatedAt: Date;
}

export interface MedicalRecordsConsentWithEmployee extends MedicalRecordsConsent {
  employeeFirstName: string | null;
  employeeLastName: string | null;
  employeeEmail: string | null;
}
```

Also extend the `Employee` interface to include the new GP fields:
```typescript
// Add to existing Employee interface:
gpName: string | null;
gpAddress: string | null;
gpPhone: string | null;
```

**types/enums.ts** -- Add to AuditEntity enum:
```typescript
MILESTONE_CONFIG = "MILESTONE_CONFIG",
MEDICAL_CONSENT = "MEDICAL_CONSENT",
GP_DETAILS = "GP_DETAILS",
```

Add to AuditAction enum:
```typescript
CONSENT = "CONSENT",
REVOKE = "REVOKE",
```

**constants/permissions.ts** -- Add permission constants:
```typescript
MANAGE_MILESTONES: "manage:milestones",
VIEW_MILESTONES: "view:milestones",
MANAGE_GP_DETAILS: "manage:gp_details",
VIEW_GP_DETAILS: "view:gp_details",
MANAGE_CONSENT: "manage:consent",
VIEW_CONSENT: "view:consent",
```

Add to ROLE_PERMISSIONS:
- PLATFORM_ADMIN: all 6 new permissions
- ORG_ADMIN: all 6 new permissions
- HR: VIEW_MILESTONES, VIEW_GP_DETAILS, VIEW_CONSENT
- MANAGER: VIEW_MILESTONES
- EMPLOYEE: MANAGE_GP_DETAILS (own GP details), MANAGE_CONSENT (own consent)

**constants/milestone-defaults.ts** -- Create new file:
```typescript
export interface MilestoneDefault {
  key: string;
  label: string;
  dayOffset: number;
  description: string;
}

export const DEFAULT_MILESTONES: MilestoneDefault[] = [
  { key: "DAY_1", label: "Day 1 - Absence Reported", dayOffset: 1, description: "Initial absence notification to employee, manager, and HR" },
  { key: "DAY_3", label: "Day 3 - GP Visit Reminder", dayOffset: 3, description: "Remind employee about GP visit and fit note requirements" },
  { key: "DAY_7", label: "Day 7 - Long-Term Transition", dayOffset: 7, description: "Case transitions to long-term; prompt for fit note upload and expected return date" },
  { key: "WEEK_2", label: "Week 2 - Check-in", dayOffset: 14, description: "Check-in prompt and fit note renewal reminder" },
  { key: "WEEK_3", label: "Week 3 - Fit Note Renewal", dayOffset: 21, description: "Fit note renewal reminder" },
  { key: "WEEK_4", label: "Week 4 - GP/OH Report Request", dayOffset: 28, description: "Prompt HR/manager to request GP or occupational health report" },
  { key: "WEEK_6", label: "Week 6 - Plan of Action", dayOffset: 42, description: "Prompt creation of a Plan of Action" },
  { key: "WEEK_10", label: "Week 10 - First Evaluation", dayOffset: 70, description: "First evaluation meeting" },
  { key: "WEEK_14", label: "Week 14 - Evaluation", dayOffset: 98, description: "Scheduled evaluation meeting" },
  { key: "WEEK_18", label: "Week 18 - Evaluation", dayOffset: 126, description: "Scheduled evaluation meeting" },
  { key: "WEEK_22", label: "Week 22 - Evaluation", dayOffset: 154, description: "Scheduled evaluation meeting" },
  { key: "WEEK_26", label: "Week 26 - Evaluation", dayOffset: 182, description: "Scheduled evaluation meeting" },
  { key: "WEEK_30", label: "Week 30 - Evaluation", dayOffset: 210, description: "Scheduled evaluation meeting" },
  { key: "WEEK_34", label: "Week 34 - Evaluation", dayOffset: 238, description: "Scheduled evaluation meeting" },
  { key: "WEEK_38", label: "Week 38 - Evaluation", dayOffset: 266, description: "Scheduled evaluation meeting" },
  { key: "WEEK_42", label: "Week 42 - Evaluation", dayOffset: 294, description: "Scheduled evaluation meeting" },
  { key: "WEEK_46", label: "Week 46 - Evaluation", dayOffset: 322, description: "Scheduled evaluation meeting" },
  { key: "WEEK_50", label: "Week 50 - Evaluation", dayOffset: 350, description: "Scheduled evaluation meeting" },
  { key: "WEEK_52", label: "Week 52 - Capability Review", dayOffset: 364, description: "Formal capability review trigger" },
];
```

**schemas/milestone-config.ts** -- Create Zod schemas (follow trigger-config.ts pattern):
```typescript
import { z } from "zod";

export const createMilestoneConfigSchema = z.object({
  milestoneKey: z.string().min(1).max(50),
  label: z.string().min(3).max(100),
  dayOffset: z.number().int().min(1, "Day offset must be at least 1"),
  description: z.string().max(500).optional(),
  isActive: z.boolean().optional(),
});

export const updateMilestoneConfigSchema = z.object({
  label: z.string().min(3).max(100).optional(),
  dayOffset: z.number().int().min(1).optional(),
  description: z.string().max(500).nullish(),
  isActive: z.boolean().optional(),
});

export type CreateMilestoneConfigInput = z.infer<typeof createMilestoneConfigSchema>;
export type UpdateMilestoneConfigInput = z.infer<typeof updateMilestoneConfigSchema>;
```

**schemas/gp-details.ts** -- Create Zod schemas:
```typescript
import { z } from "zod";

export const gpDetailsSchema = z.object({
  gpName: z.string().min(2, "GP name must be at least 2 characters").max(255).optional().nullable(),
  gpAddress: z.string().max(1000).optional().nullable(),
  gpPhone: z.string().max(50).optional().nullable(),
});

export const medicalConsentSchema = z.object({
  consentStatus: z.enum(["GRANTED", "REVOKED"]),
  notes: z.string().max(1000).optional(),
});

export type GpDetailsInput = z.infer<typeof gpDetailsSchema>;
export type MedicalConsentInput = z.infer<typeof medicalConsentSchema>;
```
  </action>
  <verify>
Run TypeScript type check on the full project:
```bash
npx tsc --noEmit
```
Confirm no type errors related to the new types, enums, or schemas.
  </verify>
  <done>All new interfaces, enums, permissions, constants, and schemas exist. Employee interface includes gpName/gpAddress/gpPhone. MilestoneConfig and MedicalRecordsConsent interfaces match migration schemas. DEFAULT_MILESTONES array has 19 entries matching the seeded data. TypeScript compiles without errors.</done>
</task>

</tasks>

<verification>
1. Both migration files have valid SQL with proper up() and down() functions
2. RLS policies follow existing pattern (org_isolation + platform admin bypass)
3. types/database.ts has MilestoneConfig, MedicalRecordsConsent, MedicalRecordsConsentWithEmployee interfaces
4. Employee interface has gpName, gpAddress, gpPhone fields
5. types/enums.ts has MILESTONE_CONFIG, MEDICAL_CONSENT, GP_DETAILS in AuditEntity; CONSENT, REVOKE in AuditAction
6. constants/permissions.ts has 6 new permissions with correct role mappings
7. constants/milestone-defaults.ts exports DEFAULT_MILESTONES with 19 entries
8. schemas/milestone-config.ts and schemas/gp-details.ts export correct Zod schemas
9. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- All files listed in files_modified exist with correct content
- TypeScript compiles without errors
- Migration SQL is syntactically valid with proper indexes and RLS
- Default milestones match the specification (Day 1, 3, 7, Week 2, 3, 4, 6, every 4 weeks from 10, Week 52)
</success_criteria>

<output>
After completion, create `.planning/phases/04-timeline-engine-and-gp-details/04-01-SUMMARY.md`
</output>
