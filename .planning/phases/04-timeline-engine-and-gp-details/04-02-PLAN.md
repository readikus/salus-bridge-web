---
phase: 04-timeline-engine-and-gp-details
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - providers/repositories/milestone-config.repository.ts
  - providers/services/milestone.service.ts
  - app/api/organisations/[slug]/milestones/route.ts
  - app/api/organisations/[slug]/milestones/[id]/route.ts
  - app/api/sickness-cases/[id]/timeline/route.ts
  - actions/milestones.ts
  - actions/sickness-cases.ts
  - components/milestone-config-form/index.tsx
  - components/case-timeline/index.tsx
  - app/(authenticated)/organisations/[slug]/milestones/page.tsx
autonomous: true

must_haves:
  truths:
    - "Each active sickness case displays a timeline showing upcoming and past milestone points based on absence duration"
    - "Org admin can override default milestone timings for their organisation, and new cases use the custom timings"
    - "Default milestones are shown when org has no overrides"
  artifacts:
    - path: "providers/repositories/milestone-config.repository.ts"
      provides: "CRUD for milestone configs with default/override resolution"
      exports: ["MilestoneConfigRepository"]
    - path: "providers/services/milestone.service.ts"
      provides: "Milestone resolution logic: merge defaults with org overrides, compute timeline for a case"
      exports: ["MilestoneService"]
    - path: "app/api/organisations/[slug]/milestones/route.ts"
      provides: "GET (list milestones) and POST (create override) endpoints"
      exports: ["GET", "POST"]
    - path: "app/api/sickness-cases/[id]/timeline/route.ts"
      provides: "GET timeline for a specific sickness case"
      exports: ["GET"]
    - path: "components/case-timeline/index.tsx"
      provides: "Visual timeline component showing past/current/future milestones"
      exports: ["CaseTimeline"]
    - path: "app/(authenticated)/organisations/[slug]/milestones/page.tsx"
      provides: "Org admin page to view and customise milestone timings"
  key_links:
    - from: "providers/services/milestone.service.ts"
      to: "providers/repositories/milestone-config.repository.ts"
      via: "getEffectiveMilestones merges defaults with org overrides"
      pattern: "getEffectiveMilestones"
    - from: "app/api/sickness-cases/[id]/timeline/route.ts"
      to: "providers/services/milestone.service.ts"
      via: "getCaseTimeline computes milestone statuses from absence start date"
      pattern: "getCaseTimeline"
    - from: "components/case-timeline/index.tsx"
      to: "actions/sickness-cases.ts"
      via: "fetchCaseTimeline action"
      pattern: "fetchCaseTimeline"
---

<objective>
Build the milestone timeline engine: repository, service with default/override merge logic, API endpoints for org admin config and case timeline, and UI for both config management and case timeline display.

Purpose: Enables TIME-01 (auto-tracking of absence milestones) and TIME-02 (org-level customisation of milestone timings).
Output: Working milestone config CRUD for org admins, and a timeline view on each sickness case showing past/upcoming milestones.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-timeline-engine-and-gp-details/04-01-SUMMARY.md

@providers/repositories/trigger-config.repository.ts
@providers/services/trigger.service.ts
@app/api/organisations/[slug]/triggers/route.ts
@actions/triggers.ts
@schemas/milestone-config.ts
@constants/milestone-defaults.ts
@types/database.ts
@providers/services/tenant.service.ts
@app/(authenticated)/sickness/[id]/page.tsx
@components/sidebar/nav-items.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create milestone config repository, service, and API routes</name>
  <files>
    providers/repositories/milestone-config.repository.ts
    providers/services/milestone.service.ts
    app/api/organisations/[slug]/milestones/route.ts
    app/api/organisations/[slug]/milestones/[id]/route.ts
    app/api/sickness-cases/[id]/timeline/route.ts
    actions/milestones.ts
  </files>
  <action>
**providers/repositories/milestone-config.repository.ts** -- Follow TriggerConfigRepository pattern exactly:

Static class with SELECT_COLUMNS using snake_case AS "camelCase". Methods:
- `findDefaults(client?)` -- SELECT WHERE organisation_id IS NULL AND is_default = true ORDER BY day_offset ASC
- `findByOrganisation(orgId, client?)` -- SELECT WHERE organisation_id = $1 ORDER BY day_offset ASC
- `findById(id, client?)` -- SELECT WHERE id = $1
- `create(data, client?)` -- INSERT with organisationId, milestoneKey, label, dayOffset, description, isActive, createdBy. RETURNING all columns.
- `update(id, data, client?)` -- Dynamic SET clauses for label, dayOffset, description, isActive. Always SET updated_at = NOW(). RETURNING.
- `delete(id, client?)` -- DELETE WHERE id = $1
- `findByOrgAndKey(orgId, milestoneKey, client?)` -- SELECT WHERE organisation_id = $1 AND milestone_key = $2

**providers/services/milestone.service.ts** -- Business logic:

```typescript
export class MilestoneService {
  /**
   * Get effective milestones for an organisation.
   * Merges system defaults with org overrides.
   * If org has an override for a milestone_key, use the override.
   * If org has no override, use the default.
   * Returns sorted by dayOffset ascending.
   */
  static async getEffectiveMilestones(organisationId: string, client?: PoolClient): Promise<MilestoneConfig[]>

  /**
   * Get the timeline for a specific sickness case.
   * Computes the status of each milestone based on:
   * - absenceStartDate + dayOffset = milestone due date
   * - If due date is in the past: status = "PASSED"
   * - If due date is today: status = "DUE_TODAY"
   * - If due date is in the future: status = "UPCOMING"
   * Returns array of { milestone, dueDate, status, daysSinceStart }
   */
  static async getCaseTimeline(
    sicknessCaseId: string,
    organisationId: string,
    client?: PoolClient
  ): Promise<CaseTimelineEntry[]>

  /**
   * Create or update an org-level milestone override.
   * If the org already has a config for this milestone_key, update it.
   * Otherwise create a new override row.
   */
  static async upsertOrgMilestone(
    organisationId: string,
    data: CreateMilestoneConfigInput,
    userId: string,
    client?: PoolClient
  ): Promise<MilestoneConfig>

  /**
   * Reset an org milestone override back to default (delete the override row).
   */
  static async resetToDefault(
    configId: string,
    organisationId: string,
    userId: string,
    client?: PoolClient
  ): Promise<void>
}
```

Define the CaseTimelineEntry type in the service file (or in types/database.ts):
```typescript
export interface CaseTimelineEntry {
  milestone: MilestoneConfig;
  dueDate: string; // ISO date string
  status: "PASSED" | "DUE_TODAY" | "UPCOMING";
  daysSinceStart: number;
}
```

For `getEffectiveMilestones`: fetch both defaults and org overrides. Create a Map keyed by milestone_key. Start with defaults, override with org configs. Filter only isActive=true. Sort by dayOffset. Only include milestones where dayOffset <= current absence duration OR all milestones (for config view).

For `getCaseTimeline`: fetch the sickness case to get absenceStartDate. Call getEffectiveMilestones. For each milestone, compute dueDate = absenceStartDate + dayOffset days. Compute status based on today's date vs dueDate.

**app/api/organisations/[slug]/milestones/route.ts** -- Follow triggers/route.ts pattern exactly:

GET: Auth check -> permission VIEW_MILESTONES -> TenantService.withTenant -> MilestoneService.getEffectiveMilestones -> return JSON { milestones }

POST: Auth check -> permission MANAGE_MILESTONES -> validate body with createMilestoneConfigSchema -> TenantService.withTenant -> MilestoneService.upsertOrgMilestone -> audit log (AuditEntity.MILESTONE_CONFIG, AuditAction.CREATE or UPDATE) -> return JSON { config } with 201

**app/api/organisations/[slug]/milestones/[id]/route.ts** -- Individual milestone operations:

PUT: Auth check -> MANAGE_MILESTONES -> validate with updateMilestoneConfigSchema -> TenantService.withTenant -> MilestoneConfigRepository.update -> audit log -> return { config }

DELETE: Auth check -> MANAGE_MILESTONES -> TenantService.withTenant -> MilestoneService.resetToDefault -> audit log -> return { success: true }

**app/api/sickness-cases/[id]/timeline/route.ts** -- Timeline for a specific case:

GET: Auth check -> VIEW_SICKNESS_CASES permission -> load case to get organisationId -> TenantService.withTenant -> MilestoneService.getCaseTimeline -> return JSON { timeline }

**actions/milestones.ts** -- Client-side fetch wrappers following actions/triggers.ts pattern:
- `fetchMilestones(slug)` -- GET /api/organisations/{slug}/milestones -> { milestones }
- `createMilestoneOverride(slug, data)` -- POST -> { config }
- `updateMilestoneOverride(slug, id, data)` -- PUT -> { config }
- `deleteMilestoneOverride(slug, id)` -- DELETE -> { success }

Also add to **actions/sickness-cases.ts** (append, do not replace):
- `fetchCaseTimeline(caseId)` -- GET /api/sickness-cases/{caseId}/timeline -> { timeline }
  </action>
  <verify>
Run TypeScript type check:
```bash
npx tsc --noEmit
```
Verify all 6 files exist and compile without errors.
  </verify>
  <done>Repository has all CRUD methods. Service merges defaults with org overrides and computes case timeline with PASSED/DUE_TODAY/UPCOMING statuses. API routes follow established auth/permission/tenant/audit pattern. Actions provide client-side fetch wrappers. TypeScript compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Create milestone config UI page and case timeline component</name>
  <files>
    components/milestone-config-form/index.tsx
    components/case-timeline/index.tsx
    app/(authenticated)/organisations/[slug]/milestones/page.tsx
    app/(authenticated)/sickness/[id]/page.tsx
    components/sidebar/nav-items.ts
  </files>
  <action>
**components/milestone-config-form/index.tsx** -- Org admin form for editing a milestone override:

Follow components/trigger-config-form pattern. React Hook Form + zodResolver with updateMilestoneConfigSchema. Fields:
- label (text input)
- dayOffset (number input, "Trigger at day X of absence")
- description (textarea)
- isActive (checkbox/switch)

Props: `{ milestone: MilestoneConfig; slug: string; onSave: () => void; onCancel: () => void }`

Use shadcn Card, Input, Label, Button, Textarea components. On submit, call updateMilestoneOverride or createMilestoneOverride action. Show success/error toast.

**app/(authenticated)/organisations/[slug]/milestones/page.tsx** -- Milestone configuration page:

"use client" page. Layout:
- Page heading: "Milestone Timeline Configuration"
- Description: "Configure when milestone actions are triggered during employee absence. Customise timings for your organisation or use the system defaults."
- Table/card list of all effective milestones (from fetchMilestones)
- Each row shows: milestone label, day offset ("Day X"), description, status (Active/Inactive), whether it's a default or custom override
- "Edit" button per row opens the milestone-config-form in a dialog/sheet
- "Reset to Default" button for org overrides (calls deleteMilestoneOverride)
- Badge showing "Default" or "Custom" per row

Use TanStack Table or a simple card-based layout (cards preferred for this use case since there are only ~19 rows). Each card shows the milestone details with an edit action.

**components/case-timeline/index.tsx** -- Timeline display for sickness case detail:

Props: `{ caseId: string }`

Fetches timeline data via fetchCaseTimeline action on mount. Renders a vertical timeline with:
- Each milestone as a node on the timeline
- PASSED milestones: green circle/checkmark icon, muted text
- DUE_TODAY milestones: amber/orange circle with pulse, bold text, "Due Today" badge
- UPCOMING milestones: gray circle/dot, lighter text, shows "Due: {date}" label

Timeline layout: vertical left-aligned with connecting line. Use Tailwind classes (no extra dependencies). Each entry shows:
- Status icon (circle with colour)
- Milestone label
- Due date formatted as "DD MMM YYYY"
- Days from start: "Day {N}"
- Description (if available)

Handle loading and empty states. If case has no milestones (e.g. case is resolved), show appropriate message.

**app/(authenticated)/sickness/[id]/page.tsx** -- Modify existing case detail page:

Import and render `<CaseTimeline caseId={params.id} />` within the case detail page. Place it in a new section below existing case info, with a heading "Absence Timeline". Only show for active cases (status not RESOLVED or CANCELLED).

**components/sidebar/nav-items.ts** -- Add milestone nav item:

Add between "Triggers" and "OH Providers":
```typescript
{
  label: "Milestones",
  href: "/milestones",
  icon: Timer,  // or Clock from lucide-react
  roles: [UserRole.PLATFORM_ADMIN, UserRole.ORG_ADMIN],
},
```

Import `Timer` (or `Clock`) from lucide-react at the top.

Note: The href "/milestones" will resolve to `/organisations/[slug]/milestones` in the org-scoped routing context already established in the app.
  </action>
  <verify>
Run TypeScript type check:
```bash
npx tsc --noEmit
```
Verify all new components and pages render without TypeScript errors.
  </verify>
  <done>Org admin milestones page lists all effective milestones with edit/reset capability. Case timeline component shows vertical timeline with PASSED/DUE_TODAY/UPCOMING states. Sickness case detail page includes timeline section. Sidebar has Milestones nav item for org admins.</done>
</task>

</tasks>

<verification>
1. MilestoneConfigRepository has CRUD methods with parameterised SQL and camelCase aliasing
2. MilestoneService.getEffectiveMilestones merges defaults with org overrides correctly
3. MilestoneService.getCaseTimeline computes correct PASSED/DUE_TODAY/UPCOMING statuses
4. API routes follow auth -> permission -> tenant -> service -> audit pattern
5. Milestone config page shows all milestones with edit/reset actions
6. Case timeline component displays on sickness case detail page
7. Sidebar has "Milestones" nav item for ORG_ADMIN and PLATFORM_ADMIN
8. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- GET /api/organisations/{slug}/milestones returns merged milestones (defaults + overrides)
- POST /api/organisations/{slug}/milestones creates an org-level override
- GET /api/sickness-cases/{id}/timeline returns timeline entries with correct statuses
- Milestones page allows org admin to view, edit, and reset milestone timings
- Case detail page shows a visual timeline of milestones for active cases
</success_criteria>

<output>
After completion, create `.planning/phases/04-timeline-engine-and-gp-details/04-02-SUMMARY.md`
</output>
