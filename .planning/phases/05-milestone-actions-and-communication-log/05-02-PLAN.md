---
phase: 05-milestone-actions-and-communication-log
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - providers/services/milestone-action.service.ts
  - providers/services/communication-log.service.ts
  - app/api/sickness-cases/[id]/milestone-actions/route.ts
  - app/api/sickness-cases/[id]/milestone-actions/[actionId]/route.ts
  - app/api/sickness-cases/[id]/communication-log/route.ts
  - actions/milestone-actions.ts
  - actions/communication-log.ts
  - emails/milestone-notification.tsx
autonomous: true

must_haves:
  truths:
    - "When a sickness case is active, milestone actions can be generated for all due/upcoming milestones"
    - "Manager/HR can complete or skip a milestone action with notes"
    - "Manager/HR can create a communication log entry with date, type, and notes"
    - "Communication log entries cannot be edited or deleted after creation"
    - "Milestone notifications use privacy-validated email templates"
  artifacts:
    - path: "providers/services/milestone-action.service.ts"
      provides: "Business logic for generating, completing, and querying milestone actions"
      exports: ["MilestoneActionService"]
    - path: "providers/services/communication-log.service.ts"
      provides: "Business logic for creating and querying communication log entries"
      exports: ["CommunicationLogService"]
    - path: "app/api/sickness-cases/[id]/milestone-actions/route.ts"
      provides: "GET list + POST generate milestone actions for a case"
      exports: ["GET", "POST"]
    - path: "app/api/sickness-cases/[id]/milestone-actions/[actionId]/route.ts"
      provides: "PATCH to complete/skip a milestone action"
      exports: ["PATCH"]
    - path: "app/api/sickness-cases/[id]/communication-log/route.ts"
      provides: "GET list + POST create communication log entries"
      exports: ["GET", "POST"]
    - path: "emails/milestone-notification.tsx"
      provides: "Email template for milestone notifications"
  key_links:
    - from: "providers/services/milestone-action.service.ts"
      to: "providers/repositories/milestone-action.repository.ts"
      via: "repository method calls"
      pattern: "MilestoneActionRepository"
    - from: "providers/services/milestone-action.service.ts"
      to: "providers/services/milestone.service.ts"
      via: "getCaseTimeline for due date computation"
      pattern: "MilestoneService.getCaseTimeline"
    - from: "app/api/sickness-cases/[id]/communication-log/route.ts"
      to: "providers/services/communication-log.service.ts"
      via: "service method calls"
      pattern: "CommunicationLogService"
---

<objective>
Create the service layer, API routes, client actions, and email template for milestone actions and communication logging.

Purpose: This plan wires the data layer from Plan 01 into usable business logic and API endpoints. MilestoneActionService generates actions for a case (computing due dates from the timeline engine), allows completing/skipping actions, and sends milestone notification emails. CommunicationLogService provides create + read-only access. API routes follow the established auth/permission/tenant pattern.

Output: Two services, four API route files, two client action files, one email template.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-milestone-actions-and-communication-log/05-01-SUMMARY.md

Key existing code to reference:
@providers/services/milestone.service.ts (timeline computation -- getCaseTimeline, getEffectiveMilestones)
@providers/services/notification.service.ts (email sending pattern)
@app/api/sickness-cases/[id]/timeline/route.ts (API route pattern for case sub-resources)
@emails/trigger-alert.tsx (email template pattern)
@constants/milestone-actions.ts (MILESTONE_ACTION_MAP from plan 01)
@schemas/milestone-action.ts (Zod schemas from plan 01)
@schemas/communication-log.ts (Zod schemas from plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create services and email template</name>
  <files>
    providers/services/milestone-action.service.ts
    providers/services/communication-log.service.ts
    emails/milestone-notification.tsx
  </files>
  <action>
**providers/services/milestone-action.service.ts** -- MilestoneActionService:

- `generateActionsForCase(sicknessCaseId, organisationId, client?)`:
  1. Call MilestoneService.getCaseTimeline(sicknessCaseId, organisationId, client) to get timeline entries
  2. For each timeline entry, check if a milestone_action already exists (findBySicknessCase then filter by milestoneKey)
  3. For entries without existing actions, create MilestoneAction with: organisationId, sicknessCaseId, milestoneKey, actionType (from MILESTONE_ACTION_MAP), status='PENDING', dueDate (from timeline entry)
  4. Use MilestoneActionRepository.createMany() for bulk insert of new actions
  5. Return all actions for the case (existing + newly created)

- `completeAction(actionId, userId, notes?, client?)`:
  1. Load action by ID, verify it exists and status is PENDING or OVERDUE
  2. Update status to COMPLETED, set completedBy=userId, completedAt=now(), notes if provided
  3. Audit log the completion
  4. Return updated action

- `skipAction(actionId, userId, notes, client?)`:
  1. Load action by ID, verify exists and status is PENDING or OVERDUE
  2. Validate notes is non-empty (required when skipping per schema)
  3. Update status to SKIPPED, set completedBy=userId, notes
  4. Audit log the skip
  5. Return updated action

- `markOverdueActions(organisationId, client?)`:
  1. Find all PENDING actions where due_date < today for the org
  2. Bulk update status to OVERDUE
  3. Return count of updated actions (for logging)

- `getActionsForCase(sicknessCaseId, client?)`:
  1. Return MilestoneActionRepository.findBySicknessCaseWithDetails(sicknessCaseId, client)

- `sendMilestoneNotification(action, sicknessCase, recipients, organisationName, organisationId)`:
  1. Look up action config from MILESTONE_ACTION_MAP[action.milestoneKey]
  2. For each recipient, render MilestoneNotificationEmail and send via NotificationService.send()
  3. Fire-and-forget (catch errors, log, don't throw)

**providers/services/communication-log.service.ts** -- CommunicationLogService:

- `createEntry(params: { organisationId, sicknessCaseId, authorId, contactDate, contactType, notes }, client?)`:
  1. Validate with createCommunicationLogSchema
  2. Create via CommunicationLogRepository.create()
  3. Audit log the creation (AuditEntity.COMMUNICATION_LOG, AuditAction.CREATE)
  4. Return created entry

- `getEntriesForCase(sicknessCaseId, client?)`:
  1. Return CommunicationLogRepository.findBySicknessCase(sicknessCaseId, client)

- `getEntryCount(sicknessCaseId, client?)`:
  1. Return CommunicationLogRepository.countBySicknessCase(sicknessCaseId, client)

**emails/milestone-notification.tsx** -- MilestoneNotificationEmail:
Follow existing email template pattern (EmailLayout, Text, Button, Section).
Props: { milestoneName: string, milestoneDescription: string, organisationName: string, caseUrl: string }
Generic subject: "Absence Management - Action Required"
Body: "{milestoneName}" heading, description text, "View Case" button linking to caseUrl.
Keep content privacy-compliant: NO employee name, NO condition details, NO specific health info.
  </action>
  <verify>`npx tsc --noEmit --pretty 2>&1 | head -30` passes. Verify MilestoneActionService has generateActionsForCase, completeAction, skipAction methods. Verify CommunicationLogService has NO update or delete methods.</verify>
  <done>MilestoneActionService generates/completes/skips actions with audit logging and notification sending. CommunicationLogService creates and reads entries (immutable). Email template renders privacy-compliant milestone notifications.</done>
</task>

<task type="auto">
  <name>Task 2: Create API routes and client actions</name>
  <files>
    app/api/sickness-cases/[id]/milestone-actions/route.ts
    app/api/sickness-cases/[id]/milestone-actions/[actionId]/route.ts
    app/api/sickness-cases/[id]/communication-log/route.ts
    actions/milestone-actions.ts
    actions/communication-log.ts
  </files>
  <action>
**app/api/sickness-cases/[id]/milestone-actions/route.ts**:
- GET: Auth check (VIEW_MILESTONE_ACTIONS permission), load sickness case, TenantService.withTenant(), call MilestoneActionService.getActionsForCase(). Return { actions: MilestoneActionWithDetails[] }.
- POST: Auth check (MANAGE_MILESTONE_ACTIONS permission), load sickness case, TenantService.withTenant(), call MilestoneActionService.generateActionsForCase(). Return { actions, generated: number } with 201 status.

Follow exact pattern from app/api/sickness-cases/[id]/timeline/route.ts for auth, tenant context, and error handling.

**app/api/sickness-cases/[id]/milestone-actions/[actionId]/route.ts**:
- PATCH: Auth check (MANAGE_MILESTONE_ACTIONS), parse body for { action: 'complete' | 'skip', notes?: string }. Validate with appropriate schema (completeMilestoneActionSchema or skipMilestoneActionSchema). Load sickness case for tenant context. Call completeAction or skipAction on MilestoneActionService. Return { action: MilestoneAction }.

**app/api/sickness-cases/[id]/communication-log/route.ts**:
- GET: Auth check (VIEW_COMMUNICATION_LOG), load case, tenant context. Call CommunicationLogService.getEntriesForCase(). Return { entries: CommunicationLogEntryWithAuthor[], count: number }.
- POST: Auth check (CREATE_COMMUNICATION_LOG), parse and validate body with createCommunicationLogSchema, load case, tenant context. Call CommunicationLogService.createEntry() with authorId = sessionUser.id. Return { entry } with 201 status.

No PUT/PATCH/DELETE on communication-log route -- immutability enforced at API level.

**actions/milestone-actions.ts** -- Client-side fetch wrappers:
- fetchMilestoneActions(caseId: string) -- GET /api/sickness-cases/{caseId}/milestone-actions
- generateMilestoneActions(caseId: string) -- POST /api/sickness-cases/{caseId}/milestone-actions
- completeMilestoneAction(caseId: string, actionId: string, notes?: string) -- PATCH with { action: 'complete', notes }
- skipMilestoneAction(caseId: string, actionId: string, notes: string) -- PATCH with { action: 'skip', notes }

**actions/communication-log.ts** -- Client-side fetch wrappers:
- fetchCommunicationLog(caseId: string) -- GET /api/sickness-cases/{caseId}/communication-log
- createCommunicationLogEntry(caseId: string, data: { contactDate, contactType, notes }) -- POST

All actions follow established pattern: async functions prefixed with fetch*/create*/complete*/skip*, returning typed responses, throwing on non-OK status.
  </action>
  <verify>`npx tsc --noEmit --pretty 2>&1 | head -30` passes. Verify API route files exist at correct paths. Verify communication-log route has only GET and POST exports (no PUT/PATCH/DELETE).</verify>
  <done>API routes serve milestone actions (GET list, POST generate, PATCH complete/skip) and communication log (GET list, POST create). Client actions provide typed fetch wrappers. Communication log immutability enforced at API level (no update/delete endpoints).</done>
</task>

</tasks>

<verification>
- All service methods handle errors with try/catch and audit logging
- API routes follow auth -> permission -> tenant context -> service call pattern
- Communication log has NO update/delete endpoints anywhere in the stack
- Email template passes privacy validation (no employee names or health details)
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
- MilestoneActionService can generate, complete, skip, and query milestone actions
- CommunicationLogService can create and query entries (no mutations)
- API routes expose all operations with proper auth and tenant scoping
- Client actions provide typed wrappers for all API operations
- Milestone notification email is privacy-compliant
</success_criteria>

<output>
After completion, create `.planning/phases/05-milestone-actions-and-communication-log/05-02-SUMMARY.md`
</output>
