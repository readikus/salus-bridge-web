---
phase: 05-milestone-actions-and-communication-log
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - components/milestone-actions/index.tsx
  - components/communication-log/index.tsx
  - components/communication-log-form/index.tsx
  - app/(authenticated)/sickness/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Case detail page shows milestone actions with status indicators (pending, completed, skipped, overdue)"
    - "Manager/HR can complete or skip a milestone action from the case detail page"
    - "Case detail page shows the communication log with all entries in reverse chronological order"
    - "Manager/HR can add a new communication log entry from the case detail page"
    - "Communication log entries show author name, date, type, and notes"
  artifacts:
    - path: "components/milestone-actions/index.tsx"
      provides: "Milestone actions list with complete/skip controls"
      min_lines: 60
    - path: "components/communication-log/index.tsx"
      provides: "Communication log display with entry list"
      min_lines: 40
    - path: "components/communication-log-form/index.tsx"
      provides: "Form for creating new communication log entries"
      min_lines: 40
    - path: "app/(authenticated)/sickness/[id]/page.tsx"
      provides: "Case detail page integrating milestone actions and communication log sections"
  key_links:
    - from: "components/milestone-actions/index.tsx"
      to: "actions/milestone-actions.ts"
      via: "fetch and mutation calls"
      pattern: "fetchMilestoneActions|completeMilestoneAction|skipMilestoneAction"
    - from: "components/communication-log/index.tsx"
      to: "actions/communication-log.ts"
      via: "fetch calls"
      pattern: "fetchCommunicationLog"
    - from: "components/communication-log-form/index.tsx"
      to: "actions/communication-log.ts"
      via: "create mutation"
      pattern: "createCommunicationLogEntry"
    - from: "app/(authenticated)/sickness/[id]/page.tsx"
      to: "components/milestone-actions/index.tsx"
      via: "component import"
      pattern: "MilestoneActions"
---

<objective>
Create the UI components for milestone actions and communication logging, and integrate them into the sickness case detail page.

Purpose: This is the user-facing layer that makes Phase 5 visible. Managers and HR see actionable milestone items on each case (with complete/skip controls), plus the communication log where they can record all employer-employee contact. This completes the full vertical slice for both features.

Output: Three new components (milestone actions list, communication log display, communication log form) and updated case detail page.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-milestone-actions-and-communication-log/05-01-SUMMARY.md
@.planning/phases/05-milestone-actions-and-communication-log/05-02-SUMMARY.md

Key existing code to reference:
@app/(authenticated)/sickness/[id]/page.tsx (case detail page to modify)
@components/case-timeline/index.tsx (existing timeline component pattern)
@actions/milestone-actions.ts (client actions from plan 02)
@actions/communication-log.ts (client actions from plan 02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create milestone actions and communication log components</name>
  <files>
    components/milestone-actions/index.tsx
    components/communication-log/index.tsx
    components/communication-log-form/index.tsx
  </files>
  <action>
**components/milestone-actions/index.tsx** -- MilestoneActions component:
"use client" component. Props: { caseId: string, canManage: boolean }

1. useState for actions array, isLoading, and a refreshKey counter
2. useEffect on [caseId, refreshKey] to fetch milestone actions via fetchMilestoneActions(caseId)
3. "Generate Actions" button (if canManage and no actions yet) calls generateMilestoneActions(caseId) then increments refreshKey
4. Render actions grouped by status: OVERDUE first (red), then PENDING (amber), then COMPLETED (green), then SKIPPED (gray)
5. Each action card shows:
   - Status badge (colour-coded: red=OVERDUE, amber=PENDING, green=COMPLETED, gray=SKIPPED)
   - Milestone label and description (from milestoneLabel field)
   - Due date formatted as "DD MMM YYYY"
   - Action type badge (NOTIFICATION, PROMPT, TRANSITION, ESCALATION, REVIEW)
   - If completed: "Completed by {name} on {date}" with optional notes
   - If skipped: "Skipped by {name}: {notes}"
6. For PENDING/OVERDUE actions (if canManage): Show "Complete" button (primary) and "Skip" button (outline/destructive)
   - Complete: Opens a small inline form or dialog with optional notes textarea, confirm button
   - Skip: Opens dialog with required notes textarea (reason for skipping), confirm button
   - On submit: call completeMilestoneAction or skipMilestoneAction, then increment refreshKey
7. Use Tailwind classes. Card layout with border-l-4 colour accent per status. Use existing shadcn components (Button, Badge, Dialog, Textarea from @/components/ui/).

**components/communication-log/index.tsx** -- CommunicationLog component:
"use client" component. Props: { caseId: string, canCreate: boolean }

1. useState for entries array, isLoading, showForm boolean, refreshKey
2. useEffect on [caseId, refreshKey] to fetch via fetchCommunicationLog(caseId)
3. Display count at top: "{N} communication log entries"
4. If canCreate: "Add Entry" button toggles showForm
5. When showForm is true, render CommunicationLogForm below button. On successful creation, increment refreshKey and set showForm=false
6. Render entries in reverse chronological order (API returns this order). Each entry shows:
   - Contact type badge (colour-coded by type: PHONE_CALL=blue, EMAIL=purple, IN_PERSON=green, VIDEO_CALL=blue, LETTER=gray, OTHER=gray)
   - Contact date formatted as "DD MMM YYYY"
   - Author name: "{firstName} {lastName}" or email if names null
   - Notes text (preserve line breaks with whitespace-pre-wrap)
   - Created timestamp in small text
7. Empty state: "No communication log entries yet" with muted text

**components/communication-log-form/index.tsx** -- CommunicationLogForm component:
"use client" component. Props: { caseId: string, onSuccess: () => void, onCancel: () => void }

1. React Hook Form with Zod resolver using createCommunicationLogSchema
2. Fields:
   - Contact Date: input type="date" defaulting to today
   - Contact Type: Select dropdown with options: Phone Call, Email, In Person, Video Call, Letter, Other
   - Notes: Textarea (required, min 1 char, max 5000)
3. Submit button "Save Entry" with loading state
4. Cancel button calls onCancel
5. On submit: call createCommunicationLogEntry(caseId, data), then onSuccess()
6. Error display for validation failures
7. Use existing shadcn form components (Input, Select, Textarea, Button, Label) and Tailwind styling consistent with existing forms (see gp-details-form or consent-form for pattern)
  </action>
  <verify>`npx tsc --noEmit --pretty 2>&1 | head -30` passes. Verify all three component directories exist with index.tsx files.</verify>
  <done>Three components created: MilestoneActions shows actionable items with complete/skip controls, CommunicationLog displays immutable entries, CommunicationLogForm provides validated entry creation.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate components into sickness case detail page</name>
  <files>app/(authenticated)/sickness/[id]/page.tsx</files>
  <action>
Modify the existing sickness case detail page to add Milestone Actions and Communication Log sections below the existing Absence Timeline section.

1. Import MilestoneActions from "@/components/milestone-actions"
2. Import CommunicationLog from "@/components/communication-log"
3. After the existing CaseTimeline section (inside the isActiveCaseForTimeline conditional), add:

**Milestone Actions section** (only for active cases):
```
<div className="mt-8">
  <h2 className="text-lg font-semibold text-gray-900 mb-4">Milestone Actions</h2>
  <MilestoneActions caseId={params.id} canManage={data.canManage} />
</div>
```

**Communication Log section** (always visible, even for closed cases):
```
<div className="mt-8">
  <h2 className="text-lg font-semibold text-gray-900 mb-4">Communication Log</h2>
  <CommunicationLog caseId={params.id} canCreate={data.canManage} />
</div>
```

Place the Communication Log section OUTSIDE the isActiveCaseForTimeline conditional so it's always visible. Milestone Actions section goes INSIDE (only for active cases, same as timeline).

Keep existing page structure intact -- do NOT modify the SicknessCaseDetail component, CaseTimeline section, or navigation.
  </action>
  <verify>`npx tsc --noEmit --pretty 2>&1 | head -30` passes. Verify the sickness case detail page imports and renders both MilestoneActions and CommunicationLog components.</verify>
  <done>Case detail page shows milestone actions (for active cases) and communication log (for all cases) with proper role-based canManage/canCreate controls.</done>
</task>

</tasks>

<verification>
- All four files compile without TypeScript errors
- MilestoneActions component handles all 4 statuses with correct colour coding
- CommunicationLog renders entries with author details and preserves immutability (no edit/delete UI)
- CommunicationLogForm validates required fields before submission
- Case detail page shows both sections in correct positions
</verification>

<success_criteria>
- Visiting a sickness case detail page shows milestone actions with complete/skip buttons for managers/HR
- Communication log section shows all entries with add-entry form for authorized users
- Communication log entries display author, date, type, and notes
- No edit or delete controls exist for communication log entries (immutability in UI)
- Both sections load independently without blocking the main case detail render
</success_criteria>

<output>
After completion, create `.planning/phases/05-milestone-actions-and-communication-log/05-03-SUMMARY.md`
</output>
