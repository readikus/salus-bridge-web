---
phase: 05-milestone-actions-and-communication-log
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/migrations/20260220000001_create_milestone_actions_and_comm_log.ts
  - types/database.ts
  - types/enums.ts
  - constants/permissions.ts
  - constants/milestone-actions.ts
  - schemas/milestone-action.ts
  - schemas/communication-log.ts
  - providers/repositories/milestone-action.repository.ts
  - providers/repositories/communication-log.repository.ts
autonomous: true

must_haves:
  truths:
    - "Milestone actions are tracked per sickness case with completion status and timestamps"
    - "Communication log entries are immutable and timestamped for audit"
    - "Each milestone key maps to a defined action type (notification, prompt, transition, escalation)"
  artifacts:
    - path: "database/migrations/20260220000001_create_milestone_actions_and_comm_log.ts"
      provides: "milestone_actions and communication_logs tables with RLS"
      contains: "milestone_actions"
    - path: "providers/repositories/milestone-action.repository.ts"
      provides: "CRUD for milestone action tracking"
      exports: ["MilestoneActionRepository"]
    - path: "providers/repositories/communication-log.repository.ts"
      provides: "CRUD for communication log entries"
      exports: ["CommunicationLogRepository"]
    - path: "constants/milestone-actions.ts"
      provides: "Action type mapping per milestone key"
      exports: ["MILESTONE_ACTION_MAP"]
    - path: "schemas/milestone-action.ts"
      provides: "Zod validation for milestone actions"
    - path: "schemas/communication-log.ts"
      provides: "Zod validation for communication log entries"
  key_links:
    - from: "providers/repositories/milestone-action.repository.ts"
      to: "database milestone_actions table"
      via: "parameterised SQL queries"
      pattern: "milestone_actions"
    - from: "providers/repositories/communication-log.repository.ts"
      to: "database communication_logs table"
      via: "parameterised SQL queries"
      pattern: "communication_logs"
---

<objective>
Create the database schema, types, constants, Zod schemas, and repositories for milestone actions tracking and communication logging.

Purpose: Foundation layer for Phase 5 -- milestone_actions table tracks which milestones have been actioned per case (with status, completed_by, completed_at), and communication_logs table provides an immutable audit trail of all employer-employee contact per sickness case. This plan establishes the data layer that Plans 02 and 03 will build services and UI on top of.

Output: Migration, TypeScript interfaces, constants mapping milestone keys to action types, Zod schemas, and repository classes.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-timeline-engine-and-gp-details/04-01-SUMMARY.md
@.planning/phases/04-timeline-engine-and-gp-details/04-02-SUMMARY.md

Key existing code to reference:
@database/migrations/20260218000001_create_milestone_configs.ts (migration pattern)
@types/database.ts (interface pattern)
@types/enums.ts (enum pattern)
@constants/permissions.ts (RBAC pattern)
@constants/milestone-defaults.ts (milestone keys reference)
@providers/repositories/milestone-config.repository.ts (repository pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for milestone_actions and communication_logs tables</name>
  <files>database/migrations/20260220000001_create_milestone_actions_and_comm_log.ts</files>
  <action>
Create a Knex migration with two tables:

**milestone_actions table:**
- id: UUID primary key (gen_random_uuid())
- organisation_id: UUID NOT NULL, FK to organisations(id)
- sickness_case_id: UUID NOT NULL, FK to sickness_cases(id)
- milestone_key: VARCHAR(50) NOT NULL (references milestone_configs.milestone_key conceptually, not FK)
- action_type: VARCHAR(30) NOT NULL (one of: NOTIFICATION, PROMPT, TRANSITION, ESCALATION, REVIEW)
- status: VARCHAR(20) NOT NULL DEFAULT 'PENDING' (PENDING, COMPLETED, SKIPPED, OVERDUE)
- due_date: DATE NOT NULL (computed from case start + dayOffset, stored for query efficiency)
- completed_by: UUID NULL, FK to users(id)
- completed_at: TIMESTAMPTZ NULL
- notes: TEXT NULL
- created_at: TIMESTAMPTZ DEFAULT now()
- updated_at: TIMESTAMPTZ DEFAULT now()
- UNIQUE(sickness_case_id, milestone_key) to prevent duplicate actions per milestone per case
- Index on (organisation_id, status) for compliance dashboard queries
- Index on (sickness_case_id) for case detail queries
- Index on (due_date, status) for overdue detection

**communication_logs table:**
- id: UUID primary key (gen_random_uuid())
- organisation_id: UUID NOT NULL, FK to organisations(id)
- sickness_case_id: UUID NOT NULL, FK to sickness_cases(id)
- author_id: UUID NOT NULL, FK to users(id)
- contact_date: DATE NOT NULL
- contact_type: VARCHAR(30) NOT NULL (PHONE_CALL, EMAIL, IN_PERSON, VIDEO_CALL, LETTER, OTHER)
- notes: TEXT NOT NULL
- created_at: TIMESTAMPTZ DEFAULT now()
- No updated_at -- entries are IMMUTABLE per COMM-02

Index on (sickness_case_id, created_at) for chronological display.
Index on (organisation_id) for org-scoped queries.

Enable RLS on both tables with org isolation policies (same pattern as milestone_configs migration). Grant SELECT/INSERT/UPDATE to authenticated role for milestone_actions; grant SELECT/INSERT only for communication_logs (no UPDATE/DELETE -- immutability).
  </action>
  <verify>Check migration file has correct SQL for both tables, RLS policies, indexes, and immutability constraint (no UPDATE/DELETE grants on communication_logs).</verify>
  <done>Migration file creates milestone_actions and communication_logs tables with proper constraints, indexes, RLS policies, and communication_logs enforces immutability by omitting UPDATE/DELETE grants.</done>
</task>

<task type="auto">
  <name>Task 2: Create types, enums, constants, Zod schemas, and repositories</name>
  <files>
    types/database.ts
    types/enums.ts
    constants/permissions.ts
    constants/milestone-actions.ts
    schemas/milestone-action.ts
    schemas/communication-log.ts
    providers/repositories/milestone-action.repository.ts
    providers/repositories/communication-log.repository.ts
  </files>
  <action>
**types/enums.ts** -- Add to existing enums:
- AuditEntity: add MILESTONE_ACTION, COMMUNICATION_LOG
- (AuditAction already has CREATE, UPDATE which suffice)

**types/database.ts** -- Add interfaces:
```
MilestoneAction { id, organisationId, sicknessCaseId, milestoneKey, actionType, status, dueDate (string), completedBy (string|null), completedAt (Date|null), notes (string|null), createdAt (Date), updatedAt (Date) }

MilestoneActionWithDetails extends MilestoneAction { milestoneLabel (string), employeeFirstName (string|null), employeeLastName (string|null) }

CommunicationLogEntry { id, organisationId, sicknessCaseId, authorId, contactDate (string), contactType, notes, createdAt (Date) }

CommunicationLogEntryWithAuthor extends CommunicationLogEntry { authorFirstName (string|null), authorLastName (string|null), authorEmail (string) }
```

**constants/permissions.ts** -- Add 4 permissions:
- MANAGE_MILESTONE_ACTIONS: "manage:milestone_actions" -- granted to PLATFORM_ADMIN, ORG_ADMIN, HR, MANAGER
- VIEW_MILESTONE_ACTIONS: "view:milestone_actions" -- granted to PLATFORM_ADMIN, ORG_ADMIN, HR, MANAGER
- CREATE_COMMUNICATION_LOG: "create:communication_log" -- granted to PLATFORM_ADMIN, ORG_ADMIN, HR, MANAGER
- VIEW_COMMUNICATION_LOG: "view:communication_log" -- granted to PLATFORM_ADMIN, ORG_ADMIN, HR, MANAGER

**constants/milestone-actions.ts** -- Create MILESTONE_ACTION_MAP mapping each milestone key to its action configuration:
```typescript
export type MilestoneActionType = 'NOTIFICATION' | 'PROMPT' | 'TRANSITION' | 'ESCALATION' | 'REVIEW';

export interface MilestoneActionConfig {
  actionType: MilestoneActionType;
  description: string;
  recipients: ('employee' | 'manager' | 'hr')[];
  autoComplete?: boolean; // true for notifications that are auto-sent
}

export const MILESTONE_ACTION_MAP: Record<string, MilestoneActionConfig> = {
  DAY_1: { actionType: 'NOTIFICATION', description: 'Send responsibility notification to employee, manager, and HR', recipients: ['employee', 'manager', 'hr'], autoComplete: true },
  DAY_3: { actionType: 'NOTIFICATION', description: 'Notify employee about GP visit and fit note requirements', recipients: ['employee'], autoComplete: true },
  DAY_7: { actionType: 'TRANSITION', description: 'Transition case to long-term; prompt fit note upload and expected return date', recipients: ['employee', 'manager', 'hr'] },
  WEEK_2: { actionType: 'PROMPT', description: 'Initiate check-in and fit note renewal reminder', recipients: ['manager', 'hr', 'employee'] },
  WEEK_3: { actionType: 'PROMPT', description: 'Fit note renewal reminder', recipients: ['employee'] },
  WEEK_4: { actionType: 'PROMPT', description: 'Request GP or occupational health report', recipients: ['manager', 'hr'] },
  WEEK_6: { actionType: 'PROMPT', description: 'Create Plan of Action', recipients: ['manager', 'hr'] },
  WEEK_10: { actionType: 'ESCALATION', description: 'First evaluation meeting', recipients: ['manager', 'hr'] },
  WEEK_14: { actionType: 'ESCALATION', description: 'Scheduled evaluation meeting', recipients: ['manager', 'hr'] },
  // ... same pattern for WEEK_18 through WEEK_50
  WEEK_52: { actionType: 'REVIEW', description: 'Formal capability review', recipients: ['manager', 'hr'] },
};
```
Include ALL 19 milestone keys from DEFAULT_MILESTONES.

**schemas/milestone-action.ts** -- Zod schemas:
- completeMilestoneActionSchema: { notes: z.string().optional() }
- skipMilestoneActionSchema: { notes: z.string().min(1, "Reason required when skipping") }

**schemas/communication-log.ts** -- Zod schemas:
- createCommunicationLogSchema: { contactDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/), contactType: z.enum(['PHONE_CALL', 'EMAIL', 'IN_PERSON', 'VIDEO_CALL', 'LETTER', 'OTHER']), notes: z.string().min(1).max(5000) }

**providers/repositories/milestone-action.repository.ts** -- MilestoneActionRepository with static methods:
- findBySicknessCase(sicknessCaseId, client?) -- returns MilestoneAction[] sorted by due_date
- findBySicknessCaseWithDetails(sicknessCaseId, client?) -- JOIN milestone_configs for label, JOIN sickness_cases+employees for names
- findById(id, client?) -- single action
- create(params: { organisationId, sicknessCaseId, milestoneKey, actionType, status, dueDate }, client?) -- INSERT
- createMany(actions: array, client?) -- bulk INSERT for generating all actions at once when case timeline is built
- updateStatus(id, status, completedBy?, notes?, client?) -- UPDATE status, completed_by, completed_at (set to now() if completing)
- findOverdue(organisationId, client?) -- WHERE status = 'PENDING' AND due_date < CURRENT_DATE
- findByOrgAndStatus(organisationId, status, client?) -- for compliance queries

All queries use parameterised SQL via pool.query() with snake_case columns aliased to camelCase. Follow exact pattern from milestone-config.repository.ts.

**providers/repositories/communication-log.repository.ts** -- CommunicationLogRepository:
- findBySicknessCase(sicknessCaseId, client?) -- returns CommunicationLogEntryWithAuthor[] with JOIN to users for author name/email, sorted by contact_date DESC, created_at DESC
- findById(id, client?) -- single entry
- create(params: { organisationId, sicknessCaseId, authorId, contactDate, contactType, notes }, client?) -- INSERT only (no update/delete methods -- immutability)
- countBySicknessCase(sicknessCaseId, client?) -- for display
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit --pretty 2>&1 | head -30`. Check that milestone-action.repository.ts and communication-log.repository.ts exist with correct method signatures.</verify>
  <done>All types, enums, permissions, constants, schemas, and repositories are created. MilestoneActionRepository has CRUD + query methods, CommunicationLogRepository has create + read-only methods (no update/delete for immutability).</done>
</task>

</tasks>

<verification>
- Migration file creates both tables with correct columns, constraints, and RLS
- TypeScript interfaces match table schemas
- MILESTONE_ACTION_MAP has entries for all 19 milestone keys
- CommunicationLogRepository has NO update or delete methods
- All permissions added to appropriate roles
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
- milestone_actions and communication_logs tables defined with proper constraints
- Repository classes provide typed data access for both tables
- MILESTONE_ACTION_MAP defines action configs for every milestone key
- Communication log enforces immutability at both DB (no UPDATE/DELETE grants) and code (no update/delete methods) levels
</success_criteria>

<output>
After completion, create `.planning/phases/05-milestone-actions-and-communication-log/05-01-SUMMARY.md`
</output>
