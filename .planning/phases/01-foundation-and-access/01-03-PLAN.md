---
phase: 01-foundation-and-access
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - app/(authenticated)/organisations/page.tsx
  - app/(authenticated)/organisations/new/page.tsx
  - app/(authenticated)/organisations/[slug]/page.tsx
  - app/(authenticated)/organisations/[slug]/settings/page.tsx
  - app/(authenticated)/dashboard/page.tsx
  - app/api/organisations/route.ts
  - app/api/organisations/[slug]/route.ts
  - app/api/organisations/[slug]/admins/route.ts
  - app/api/organisations/[slug]/settings/route.ts
  - providers/repositories/organisation.repository.ts
  - providers/repositories/department.repository.ts
  - providers/services/organisation.service.ts
  - schemas/organisation.ts
  - actions/organisations.ts
  - components/organisation-list/index.tsx
  - components/organisation-form/index.tsx
autonomous: true

must_haves:
  truths:
    - "Platform admin can create a new organisation with name, slug, and settings (PLAT-01)"
    - "Platform admin can assign org admin(s) to an organisation (PLAT-02)"
    - "Platform admin can view system-wide organisation list with status (PLAT-03)"
    - "Org admin can view org dashboard with employee count and key metrics (ORG-04)"
    - "Org admin can configure organisation settings (ORG-05)"
    - "Employee sees dashboard shell with profile access and placeholders for future features"
  artifacts:
    - path: "providers/repositories/organisation.repository.ts"
      provides: "Organisation CRUD data access"
      exports: ["OrganisationRepository"]
    - path: "providers/services/organisation.service.ts"
      provides: "Organisation business logic"
      exports: ["OrganisationService"]
    - path: "providers/repositories/department.repository.ts"
      provides: "Department data access"
      exports: ["DepartmentRepository"]
    - path: "app/(authenticated)/dashboard/page.tsx"
      provides: "Role-aware dashboard page"
    - path: "components/organisation-list/index.tsx"
      provides: "Organisation list with TanStack Table"
  key_links:
    - from: "app/api/organisations/route.ts"
      to: "providers/services/organisation.service.ts"
      via: "service method calls"
      pattern: "OrganisationService\\."
    - from: "providers/services/organisation.service.ts"
      to: "providers/repositories/organisation.repository.ts"
      via: "repository queries"
      pattern: "OrganisationRepository\\."
    - from: "app/(authenticated)/organisations/page.tsx"
      to: "actions/organisations.ts"
      via: "client fetch wrappers"
      pattern: "fetchOrganisations"
---

<objective>
Build organisation management (platform admin CRUD, admin assignment, dashboard, settings) and role-appropriate dashboard pages.

Purpose: Platform admins need to create and manage organisations before any employee onboarding can happen. This plan delivers the organisational layer that employee management (Plan 04) builds upon.

Output: Full organisation CRUD UI + API, admin assignment, org dashboard with stats, org settings, and role-appropriate dashboard routing.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-access/01-CONTEXT.md
@.planning/phases/01-foundation-and-access/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-access/01-02-SUMMARY.md
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Organisation repositories, services, schemas, and API routes</name>
  <files>
    providers/repositories/organisation.repository.ts
    providers/repositories/department.repository.ts
    providers/services/organisation.service.ts
    schemas/organisation.ts
    actions/organisations.ts
    app/api/organisations/route.ts
    app/api/organisations/[slug]/route.ts
    app/api/organisations/[slug]/admins/route.ts
    app/api/organisations/[slug]/settings/route.ts
  </files>
  <action>
    **Repositories:**

    Create `providers/repositories/organisation.repository.ts`:
    - Static class OrganisationRepository:
      - `findAll(): Promise<Organisation[]>` — for platform admin list (PLAT-03)
      - `findById(id: string): Promise<Organisation | null>`
      - `findBySlug(slug: string): Promise<Organisation | null>`
      - `create(params: CreateOrgParams): Promise<Organisation>` — INSERT with name, slug, settings
      - `update(id: string, params: UpdateOrgParams): Promise<Organisation>`
      - `getStats(id: string): Promise<OrgStats>` — employee count, active count, department count (for dashboard ORG-04)
    - All queries use pool.query() with parameterised SQL, snake_case AS "camelCase"
    - findAll does NOT go through TenantService (platform admin sees all orgs)

    Create `providers/repositories/department.repository.ts`:
    - Static class DepartmentRepository:
      - `findByOrganisation(organisationId: string): Promise<Department[]>`
      - `create(params: { organisationId: string; name: string }): Promise<Department>`
      - `findOrCreate(organisationId: string, name: string): Promise<Department>` — used during CSV import (Plan 05)

    **Services:**

    Create `providers/services/organisation.service.ts`:
    - Static class OrganisationService:
      - `create(params: CreateOrgInput): Promise<Organisation>` — validates slug uniqueness, creates org, audit logs
      - `list(): Promise<Organisation[]>` — delegates to repo
      - `getBySlug(slug: string): Promise<Organisation | null>`
      - `update(id: string, params: UpdateOrgInput): Promise<Organisation>` — audit logs changes
      - `assignAdmin(organisationId: string, userEmail: string): Promise<void>` — find or create user by email, assign ORG_ADMIN role, audit log (PLAT-02). Supports multiple org admins (per user decision).
      - `removeAdmin(organisationId: string, userId: string): Promise<void>`
      - `getAdmins(organisationId: string): Promise<User[]>` — users with ORG_ADMIN role for this org
      - `getDashboardStats(organisationId: string): Promise<OrgDashboardStats>` — employee count, active absences (placeholder 0 for Phase 1), department breakdown (ORG-04)
      - `updateSettings(organisationId: string, settings: OrgSettings): Promise<Organisation>` — update settings JSONB (ORG-05)

    **Schemas:**

    Create `schemas/organisation.ts`:
    - CreateOrganisationSchema: name (3-100 chars), slug (3-50 chars, lowercase alphanumeric + hyphens)
    - UpdateOrganisationSchema: partial of above
    - OrgSettingsSchema: absenceTriggerThresholds (object), notificationPreferences (object) — structure at Claude's discretion
    - AssignAdminSchema: email (valid email)

    **API Routes:**

    Create `app/api/organisations/route.ts`:
    - GET: list all orgs (platform admin only)
    - POST: create org (platform admin only)
    - Both validate permissions, audit log access

    Create `app/api/organisations/[slug]/route.ts`:
    - GET: get org by slug (platform admin or org member)
    - PATCH: update org (platform admin or org admin)

    Create `app/api/organisations/[slug]/admins/route.ts`:
    - GET: list org admins
    - POST: assign admin by email (platform admin only) — { email: string }
    - DELETE: remove admin (platform admin only) — { userId: string }

    Create `app/api/organisations/[slug]/settings/route.ts`:
    - GET: get org settings
    - PATCH: update settings (org admin only)

    **Actions (client fetch wrappers):**

    Create `actions/organisations.ts`:
    - `fetchOrganisations(): Promise<Organisation[]>`
    - `fetchOrganisation(slug: string): Promise<Organisation>`
    - `fetchCreateOrganisation(data: CreateOrgInput): Promise<Organisation>`
    - `fetchUpdateOrganisation(slug: string, data: UpdateOrgInput): Promise<Organisation>`
    - `fetchAssignAdmin(slug: string, email: string): Promise<void>`
    - `fetchOrgDashboard(slug: string): Promise<OrgDashboardStats>`
  </action>
  <verify>
    - `yarn tsc --noEmit` passes
    - GET /api/organisations returns empty list for platform admin
    - POST /api/organisations with valid data creates org and returns it
    - GET /api/organisations then returns the new org
    - POST /api/organisations/[slug]/admins with email assigns admin role
    - PATCH /api/organisations/[slug]/settings updates settings
  </verify>
  <done>
    Organisation CRUD API works end-to-end. Platform admin can create orgs (PLAT-01), assign admins (PLAT-02), list orgs. Org admin can update settings (ORG-05). Dashboard stats endpoint returns employee/department counts (ORG-04). All actions audit logged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Organisation UI pages, dashboard, and components</name>
  <files>
    app/(authenticated)/organisations/page.tsx
    app/(authenticated)/organisations/new/page.tsx
    app/(authenticated)/organisations/[slug]/page.tsx
    app/(authenticated)/organisations/[slug]/settings/page.tsx
    app/(authenticated)/dashboard/page.tsx
    components/organisation-list/index.tsx
    components/organisation-form/index.tsx
  </files>
  <action>
    **Pages:**

    Create `app/(authenticated)/organisations/page.tsx`:
    - Platform admin only page
    - Table listing all organisations: name, slug, status, employee count, created date (PLAT-03)
    - "New Organisation" button
    - Use TanStack Table for the list (per CLAUDE.md)

    Create `app/(authenticated)/organisations/new/page.tsx`:
    - Form: name, slug (auto-generated from name, editable), initial admin email (optional — can assign later)
    - Uses React Hook Form + Zod validation
    - On success: redirect to organisation detail page

    Create `app/(authenticated)/organisations/[slug]/page.tsx`:
    - Organisation detail/dashboard: name, status, stats (employee count, departments)
    - Admin list with add/remove
    - Link to settings
    - For org admin: this IS their dashboard (ORG-04)

    Create `app/(authenticated)/organisations/[slug]/settings/page.tsx`:
    - Organisation settings form (ORG-05): absence trigger thresholds, notification preferences
    - Org admin only

    Create `app/(authenticated)/dashboard/page.tsx`:
    - Role-aware dashboard router:
      - Platform admin: redirect to /organisations
      - Org admin/HR: show org dashboard (employee count, department breakdown, placeholder for active absences)
      - Manager: show "My Team" summary (direct reports list, placeholder for team absences)
      - Employee: show dashboard shell with profile link, placeholder cards for "My Absences", "My Documents", "My Wellbeing" (per user decision: feel like a real product, not placeholder)

    **Components:**

    Create `components/organisation-list/index.tsx`:
    - Named export OrganisationList
    - Props: organisations: Organisation[]
    - TanStack Table with columns: Name (link), Slug, Status (badge), Employees, Created
    - Sortable columns, pagination

    Create `components/organisation-form/index.tsx`:
    - Named export OrganisationForm
    - Props: onSubmit, defaultValues?, isLoading
    - React Hook Form with CreateOrganisationSchema
    - Auto-slug generation from name (slugify: lowercase, replace spaces with hyphens, remove special chars)
    - shadcn Input, Button, Label components
  </action>
  <verify>
    - `yarn tsc --noEmit` passes
    - Organisation list page renders with table
    - New organisation form creates and redirects
    - Organisation detail page shows stats and admin list
    - Settings page saves and loads correctly
    - Dashboard page renders appropriately for each role
  </verify>
  <done>
    Platform admin can view org list (PLAT-03), create orgs via form, view org detail with admin management. Org admin sees dashboard with stats (ORG-04) and can configure settings (ORG-05). Role-appropriate dashboards render for all user types with employee dashboard showing placeholder sections.
  </done>
</task>

</tasks>

<verification>
1. Platform admin can create org, assign admin, view org list (PLAT-01, PLAT-02, PLAT-03)
2. Org admin sees dashboard with employee count and metrics (ORG-04)
3. Org admin can configure settings (ORG-05)
4. Role-appropriate dashboards render for all user types
5. Employee sees dashboard shell with profile and placeholders
6. All data mutations audit logged (COMP-01)
</verification>

<success_criteria>
- PLAT-01/02/03: Organisation CRUD and admin assignment working
- ORG-04: Org dashboard with real stats
- ORG-05: Organisation settings configurable
- Role-appropriate dashboards for all roles
- All mutations audit logged
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-access/01-03-SUMMARY.md`
</output>
