---
phase: 01-foundation-and-access
plan: 04
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - providers/repositories/employee.repository.ts
  - providers/services/employee.service.ts
  - schemas/employee.ts
  - actions/employees.ts
  - app/api/employees/route.ts
  - app/api/employees/[id]/route.ts
  - app/api/employees/[id]/invite/route.ts
  - app/(authenticated)/employees/page.tsx
  - app/(authenticated)/employees/new/page.tsx
  - app/(authenticated)/employees/[id]/page.tsx
  - app/(authenticated)/my-profile/page.tsx
  - components/employee-table/index.tsx
  - components/employee-form/index.tsx
autonomous: true

must_haves:
  truths:
    - "Org admin can manually add, edit, and deactivate employee records (ORG-02)"
    - "Org admin can assign roles (manager, HR, employee) to users within their org (ORG-03)"
    - "Employee list shows all employees with filters for department and status"
    - "Employee detail page allows role assignment, editing, deactivation, and invitation"
    - "Employee profile page shows current user their own info"
    - "Data visibility is role-appropriate: managers see only their team, org admin sees all (COMP-04)"
  artifacts:
    - path: "providers/repositories/employee.repository.ts"
      provides: "Employee CRUD data access (extends partial from Plan 02)"
      exports: ["EmployeeRepository"]
    - path: "providers/services/employee.service.ts"
      provides: "Employee business logic"
      exports: ["EmployeeService"]
    - path: "components/employee-table/index.tsx"
      provides: "Employee list with TanStack Table"
    - path: "components/employee-form/index.tsx"
      provides: "Employee creation/edit form"
    - path: "app/(authenticated)/employees/page.tsx"
      provides: "Employee list page"
  key_links:
    - from: "app/api/employees/route.ts"
      to: "providers/services/employee.service.ts"
      via: "service method calls"
      pattern: "EmployeeService\\."
    - from: "providers/services/employee.service.ts"
      to: "providers/repositories/employee.repository.ts"
      via: "repository queries"
      pattern: "EmployeeRepository\\."
    - from: "providers/services/employee.service.ts"
      to: "providers/services/tenant.service.ts"
      via: "withTenant for RLS"
      pattern: "TenantService\\.withTenant"
---

<objective>
Build employee CRUD (create, read, update, deactivate), role assignment, employee list/detail pages, and employee profile page.

Purpose: After organisations are created (Plan 03), org admins need to manually manage employee records and assign roles. This plan delivers the core employee management that CSV import (Plan 05) builds upon.

Output: Full employee CRUD API + UI, role assignment, invitation trigger, employee list with filters, and employee profile page.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-access/01-CONTEXT.md
@.planning/phases/01-foundation-and-access/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-access/01-02-SUMMARY.md
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Employee repository, service, schemas, and API routes</name>
  <files>
    providers/repositories/employee.repository.ts
    providers/services/employee.service.ts
    schemas/employee.ts
    actions/employees.ts
    app/api/employees/route.ts
    app/api/employees/[id]/route.ts
    app/api/employees/[id]/invite/route.ts
  </files>
  <action>
    **Repository (extend from Plan 02 partial):**

    Extend `providers/repositories/employee.repository.ts` -- add to existing file:
    - `findByOrganisation(organisationId: string, options?: { status?: string; departmentId?: string; managerId?: string }): Promise<Employee[]>` -- with optional filters, JOIN users for name/email
    - `findById(id: string): Promise<Employee | null>` -- JOIN users and departments
    - `create(params: CreateEmployeeParams): Promise<Employee>` -- INSERT employee + create user record if needed
    - `update(id: string, params: UpdateEmployeeParams): Promise<Employee>`
    - `deactivate(id: string): Promise<void>` -- set status = DEACTIVATED, deactivate linked user
    - `findByEmail(email: string, organisationId: string): Promise<Employee | null>` -- for duplicate detection (used by Plan 05 CSV import too)
    - All queries use pool.query() with parameterised SQL, snake_case AS "camelCase"

    **Services:**

    Create `providers/services/employee.service.ts`:
    - Static class EmployeeService:
      - `list(organisationId: string, filters?: EmployeeFilters): Promise<Employee[]>` -- delegates to repo, uses TenantService.withTenant()
      - `getById(id: string, organisationId: string): Promise<Employee>` -- with tenant context
      - `create(params: CreateEmployeeInput, organisationId: string): Promise<Employee>` -- creates user record, creates employee, optionally assigns department, links manager. Audit logs creation. Does NOT auto-invite (per user decision)
      - `update(id: string, params: UpdateEmployeeInput, organisationId: string): Promise<Employee>` -- audit logs changes
      - `deactivate(id: string, organisationId: string): Promise<void>` -- audit logs
      - `assignRole(employeeId: string, role: UserRole, organisationId: string): Promise<void>` -- assign role to employee's user, audit log (ORG-03)
      - `removeRole(employeeId: string, role: UserRole, organisationId: string): Promise<void>`

    **Schemas:**

    Create `schemas/employee.ts`:
    - CreateEmployeeSchema: firstName (required), lastName (required), email (valid email, required), jobTitle (optional), departmentName (optional), managerEmail (optional)
    - UpdateEmployeeSchema: partial of above + status

    **API Routes:**

    Create `app/api/employees/route.ts`:
    - GET: list employees for current org (org admin, HR see all; manager gets only their team -- server-side filtering)
    - POST: create employee (org admin only)
    - Permission checks + audit logging on both

    Create `app/api/employees/[id]/route.ts`:
    - GET: get employee detail (org admin, HR, or manager-of-this-employee)
    - PATCH: update employee (org admin only)
    - DELETE: deactivate employee (org admin only -- soft delete)

    Create `app/api/employees/[id]/invite/route.ts`:
    - POST: trigger invitation for a single employee (generates magic link via InvitationService from Plan 02)
    - Org admin only
    - Returns the invitation URL (email delivery deferred)

    **Actions (client fetch wrappers):**

    Create `actions/employees.ts`:
    - `fetchEmployees(filters?: EmployeeFilters): Promise<Employee[]>`
    - `fetchEmployee(id: string): Promise<Employee>`
    - `fetchCreateEmployee(data: CreateEmployeeInput): Promise<Employee>`
    - `fetchUpdateEmployee(id: string, data: UpdateEmployeeInput): Promise<Employee>`
    - `fetchDeactivateEmployee(id: string): Promise<void>`
    - `fetchSendInvitation(employeeId: string): Promise<{ invitationUrl: string }>`
  </action>
  <verify>
    - `yarn tsc --noEmit` passes
    - POST /api/employees creates employee record
    - GET /api/employees returns employees for org
    - PATCH /api/employees/[id] updates employee
    - DELETE /api/employees/[id] deactivates (soft delete)
    - POST /api/employees/[id]/invite generates invitation link
  </verify>
  <done>
    Employee CRUD API works end-to-end. Org admin can create, read, update, and deactivate employees (ORG-02). Role assignment works via service method (ORG-03). Invitation trigger generates magic links. All actions audit logged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Employee UI pages and components</name>
  <files>
    app/(authenticated)/employees/page.tsx
    app/(authenticated)/employees/new/page.tsx
    app/(authenticated)/employees/[id]/page.tsx
    app/(authenticated)/my-profile/page.tsx
    components/employee-table/index.tsx
    components/employee-form/index.tsx
  </files>
  <action>
    **Pages:**

    Create `app/(authenticated)/employees/page.tsx`:
    - Employee list page with TanStack Table
    - Columns: Name, Email, Job Title, Department, Manager, Status, Actions
    - Filter by department, status
    - "Add Employee" and "Import CSV" buttons (org admin only -- Import CSV links to import page built in Plan 05)
    - "Send Invitation" action per row (for un-invited employees)
    - Managers see only their team (filtered server-side)

    Create `app/(authenticated)/employees/new/page.tsx`:
    - Employee creation form with React Hook Form + Zod
    - Fields: first name, last name, email, job title, department (autocomplete from existing), manager (select from employee list per user decision)
    - Org admin only

    Create `app/(authenticated)/employees/[id]/page.tsx`:
    - Employee detail page: personal info, role assignment, status management
    - Role assignment section: checkboxes for Manager, HR, Employee roles (ORG-03)
    - Deactivate button with confirmation dialog
    - Invite/reinvite button if not yet accepted
    - Edit form for details

    Create `app/(authenticated)/my-profile/page.tsx`:
    - Current user's profile: name, email, role(s), organisation
    - Read-only for most fields (admin-managed)

    **Components:**

    Create `components/employee-table/index.tsx`:
    - Named export EmployeeTable
    - Props: employees, onInvite?, onEdit?, onDeactivate?
    - TanStack Table with sorting, pagination
    - Status badges (Active, Invited, Deactivated)
    - Action menu per row

    Create `components/employee-form/index.tsx`:
    - Named export EmployeeForm
    - Props: onSubmit, defaultValues?, departments, managers (for selects), isLoading
    - React Hook Form with CreateEmployeeSchema
    - Department: combobox/select from existing departments or type new
    - Manager: searchable select from employee list
  </action>
  <verify>
    - `yarn tsc --noEmit` passes
    - Employee list page renders with table, filters, actions
    - New employee form creates and redirects
    - Employee detail page shows info, role checkboxes, deactivate button
    - My profile page renders current user's info
  </verify>
  <done>
    Org admin can view employee list with filters, create employees via form, view/edit employee details, assign roles via checkboxes (ORG-03), deactivate employees, and trigger invitations. Employees can view their own profile. Data visibility is role-appropriate (COMP-04).
  </done>
</task>

</tasks>

<verification>
1. Org admin can add/edit/deactivate employees (ORG-02)
2. Org admin can assign roles to users (ORG-03)
3. Employee list renders with TanStack Table, filters, and actions
4. Employee detail page supports role assignment and invitation
5. Employee profile page shows current user's info
6. Data visibility is role-appropriate (COMP-04)
7. All data mutations audit logged (COMP-01)
</verification>

<success_criteria>
- ORG-02: Manual employee CRUD with deactivation
- ORG-03: Role assignment UI (manager, HR, employee roles)
- COMP-04: Role-appropriate data visibility
- Employee list, detail, form, and profile pages working
- All mutations audit logged
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-access/01-04-SUMMARY.md`
</output>
