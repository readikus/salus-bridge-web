---
phase: 01-foundation-and-access
plan: 05
type: execute
wave: 4
depends_on: ["01-03", "01-04"]
files_modified:
  - providers/services/csv-import.service.ts
  - schemas/csv-import.ts
  - app/api/employees/import/route.ts
  - app/api/me/data/route.ts
  - app/(authenticated)/employees/import/page.tsx
  - app/(authenticated)/my-data/page.tsx
  - components/csv-import-wizard/index.tsx
  - components/data-subject-view/index.tsx
  - providers/repositories/employee.repository.ts
  - providers/services/employee.service.ts
  - actions/employees.ts
autonomous: true

must_haves:
  truths:
    - "Org admin can import employees via CSV with validation, duplicate detection, and error summary (ORG-01)"
    - "CSV import links manager email column to existing employees and flags unmatched references"
    - "CSV import skips duplicates and shows them in post-import summary"
    - "Employee can view what data is held about them -- SAR readiness (COMP-05)"
    - "Managers see only direct reports and their full reporting chain (AUTH-06)"
  artifacts:
    - path: "providers/services/csv-import.service.ts"
      provides: "CSV parsing, validation, duplicate detection, import"
      exports: ["CsvImportService"]
    - path: "components/csv-import-wizard/index.tsx"
      provides: "CSV import UI with validation preview"
    - path: "components/data-subject-view/index.tsx"
      provides: "SAR readiness data view"
    - path: "app/api/me/data/route.ts"
      provides: "SAR readiness endpoint -- employee's own data"
    - path: "app/api/employees/import/route.ts"
      provides: "CSV import endpoint"
  key_links:
    - from: "app/api/employees/import/route.ts"
      to: "providers/services/csv-import.service.ts"
      via: "CSV processing pipeline"
      pattern: "CsvImportService\\."
    - from: "components/csv-import-wizard/index.tsx"
      to: "app/api/employees/import/route.ts"
      via: "file upload + fetch"
      pattern: "fetch.*employees/import"
    - from: "providers/services/employee.service.ts"
      to: "providers/repositories/employee.repository.ts"
      via: "getReportingChain recursive CTE"
      pattern: "getReportingChain"
---

<objective>
Build CSV employee import with validation/duplicate detection/manager linking, SAR data view for employees, and manager reporting chain scope.

Purpose: CSV import is the primary bulk onboarding mechanism (ORG-01). SAR readiness (COMP-05) and manager reporting chain scope (AUTH-06) complete the Phase 1 compliance and access control requirements.

Output: CSV import wizard with full validation pipeline, employee SAR data view, and manager scope filtering via recursive reporting chain query.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-access/01-CONTEXT.md
@.planning/phases/01-foundation-and-access/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-access/01-02-SUMMARY.md
@.planning/phases/01-foundation-and-access/01-03-SUMMARY.md
@.planning/phases/01-foundation-and-access/01-04-SUMMARY.md
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: CSV import service, manager reporting chain, and SAR data endpoint</name>
  <files>
    providers/services/csv-import.service.ts
    schemas/csv-import.ts
    app/api/employees/import/route.ts
    app/api/me/data/route.ts
    providers/repositories/employee.repository.ts
    providers/services/employee.service.ts
    actions/employees.ts
  </files>
  <action>
    **CSV Import Service:**

    Create `providers/services/csv-import.service.ts`:
    - Static class CsvImportService:
      - `parseAndValidate(csvContent: string, organisationId: string): Promise<CsvValidationResult>` -- parse CSV, validate required columns (first_name, last_name, email, job_title, department, manager_email per user decision on fields)
      - Validation: check email format, required fields present, flag rows with issues
      - Duplicate detection: check email against existing employees in org via EmployeeRepository.findByEmail(), mark duplicates for skip (per user decision: skip duplicates, show in summary, do NOT update)
      - Manager linking: look up manager_email column against existing employees, flag unmatched references (per user decision)
      - Department handling: auto-create departments that don't exist via DepartmentRepository.findOrCreate()
      - `importValidRows(validRows: ValidatedRow[], organisationId: string): Promise<ImportResult>` -- bulk create valid rows via EmployeeRepository.bulkCreate(), return: created count, skipped duplicates, error rows, unmatched managers
      - ImportResult: { created: Employee[], skippedDuplicates: SkippedRow[], errors: ErrorRow[], unmatchedManagers: UnmatchedManager[] }
    - Parse CSV using built-in string splitting (no external library needed for MVP CSV -- simple split on comma/newline with quote handling). Or use papaparse if already available.

    **Schemas:**

    Create `schemas/csv-import.ts`:
    - CsvImportSchema: file validation (must be .csv, max 5MB)
    - CsvRowSchema: per-row validation matching employee fields

    **Repository additions (extend existing employee.repository.ts):**

    Add to `providers/repositories/employee.repository.ts`:
    - `bulkCreate(employees: CreateEmployeeParams[]): Promise<{ created: Employee[]; skipped: SkippedEmployee[] }>` -- batch insert, skip duplicates (email within org)
    - `getReportingChain(managerId: string): Promise<Employee[]>` -- recursive CTE query to get all reports (direct + indirect) per user decision: manager sees full chain
    - `getDataSubjectRecord(employeeId: string): Promise<DataSubjectRecord>` -- all data held about employee, for COMP-05 SAR readiness. Includes: personal info, roles, department, manager, audit log entries about them.

    **Service additions (extend existing employee.service.ts):**

    Add to `providers/services/employee.service.ts`:
    - `getTeamForManager(managerId: string, organisationId: string): Promise<Employee[]>` -- uses getReportingChain for full hierarchy (AUTH-06)
    - `getMyData(employeeId: string): Promise<DataSubjectRecord>` -- COMP-05

    **API Routes:**

    Create `app/api/employees/import/route.ts`:
    - POST: accepts multipart form data with CSV file
    - Org admin only
    - Pipeline: parse CSV -> validate -> detect duplicates -> import valid rows -> return ImportResult
    - Audit logs the import action with metadata (row counts)

    Create `app/api/me/data/route.ts`:
    - GET: returns all data held about the authenticated user (COMP-05 SAR readiness)
    - Any authenticated user can access their own data
    - Returns: personal info, roles, audit log entries about them, any employee records
    - Audit logs this access

    **Actions additions (extend existing employees.ts):**

    Add to `actions/employees.ts`:
    - `fetchImportEmployees(file: File): Promise<ImportResult>`
    - `fetchMyData(): Promise<DataSubjectRecord>`

    **Update GET /api/employees (in existing route from Plan 04):**

    Modify the GET handler in `app/api/employees/route.ts` to use getTeamForManager() when the caller is a manager -- so managers see only their reporting chain (AUTH-06). Org admin and HR continue to see all employees.
  </action>
  <verify>
    - `yarn tsc --noEmit` passes
    - POST /api/employees/import with CSV file returns import results with created/skipped/errors
    - CSV with duplicate emails skips them and includes in summary
    - CSV with unknown manager emails flags them
    - GET /api/me/data returns user's own data
    - GET /api/employees as manager returns only reporting chain
    - Recursive CTE returns full chain (manager -> direct report -> their reports)
  </verify>
  <done>
    CSV import service parses, validates, detects duplicates, links managers, and imports valid rows (ORG-01). SAR data endpoint returns all data held about a user (COMP-05). Manager reporting chain query returns full hierarchy (AUTH-06). All actions audit logged.
  </done>
</task>

<task type="auto">
  <name>Task 2: CSV import wizard UI and SAR data view page</name>
  <files>
    app/(authenticated)/employees/import/page.tsx
    app/(authenticated)/my-data/page.tsx
    components/csv-import-wizard/index.tsx
    components/data-subject-view/index.tsx
  </files>
  <action>
    **Pages:**

    Create `app/(authenticated)/employees/import/page.tsx`:
    - CSV import wizard page
    - Step-by-step or single-page upload (Claude's discretion on UX)
    - Upload CSV -> show validation results -> confirm import -> show results summary
    - Results summary shows: created count, skipped duplicates (listed), errors (listed with row numbers), unmatched manager references (listed)
    - Org admin only

    Create `app/(authenticated)/my-data/page.tsx`:
    - SAR readiness view (COMP-05): shows all data held about the user
    - Personal information, roles, activity log (from audit trail)
    - Clean, readable layout -- not a raw data dump

    **Components:**

    Create `components/csv-import-wizard/index.tsx`:
    - Named export CsvImportWizard
    - Props: organisationId, onComplete
    - File upload drop zone (accepts .csv)
    - Shows parsing progress
    - Validation results: valid rows count, error rows with details, duplicate rows
    - Confirm import button
    - Results summary after import with all categories (created, skipped, errors, unmatched)

    Create `components/data-subject-view/index.tsx`:
    - Named export DataSubjectView
    - Props: data: DataSubjectRecord
    - Sections: Personal Information, Roles & Access, Activity Log
    - Clean card layout
  </action>
  <verify>
    - `yarn tsc --noEmit` passes
    - CSV import wizard completes full flow: upload -> validate -> confirm -> results
    - Import results page shows created, skipped duplicates, errors, unmatched managers
    - My Data page renders user's personal info, roles, and activity log
  </verify>
  <done>
    CSV import wizard provides full upload-validate-confirm-results flow for org admins (ORG-01). SAR data view shows employees all data held about them in a clean, readable layout (COMP-05). Manager scope is enforced on employee list via reporting chain (AUTH-06).
  </done>
</task>

</tasks>

<verification>
1. Org admin can import CSV with validation preview, duplicate skip, manager linking (ORG-01)
2. CSV import results show created, skipped duplicates, errors, unmatched managers
3. Managers see only their reporting chain (AUTH-06)
4. Employees can view their own data -- SAR readiness (COMP-05)
5. All data mutations audit logged (COMP-01)
</verification>

<success_criteria>
- ORG-01: CSV import with validation, duplicate detection, manager linking, error summary
- AUTH-06: Manager scoped to reporting chain
- COMP-05: Employee SAR data view
- Full import wizard UI with results summary
- All mutations audit logged
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-access/01-05-SUMMARY.md`
</output>
