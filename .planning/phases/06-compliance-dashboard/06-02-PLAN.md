---
phase: 06-compliance-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - app/(authenticated)/compliance/page.tsx
  - components/compliance-table/index.tsx
  - components/risk-badge/index.tsx
  - components/compliance-summary-cards/index.tsx
autonomous: true

must_haves:
  truths:
    - "Manager/HR can view a single page at /compliance showing all active cases with their compliance status"
    - "Each case row shows a red/amber/green risk badge based on overdue, upcoming, or completed milestone actions"
    - "Dashboard shows escalating deadline alerts: overdue actions highlighted in red, upcoming-within-3-days in amber"
    - "Table is sortable by risk level, employee name, absence start date, and next deadline"
    - "Table is filterable by risk level (RED/AMBER/GREEN)"
    - "Summary cards at top show total active cases and red/amber/green counts"
  artifacts:
    - path: "app/(authenticated)/compliance/page.tsx"
      provides: "Compliance dashboard page with server-side auth and client-side data"
      min_lines: 20
    - path: "components/compliance-table/index.tsx"
      provides: "TanStack Table for compliance case listing with sorting, filtering, and risk indicators"
      min_lines: 80
    - path: "components/risk-badge/index.tsx"
      provides: "Colour-coded risk level badge component (red/amber/green)"
      min_lines: 15
    - path: "components/compliance-summary-cards/index.tsx"
      provides: "Summary stat cards showing total cases and risk breakdown"
      min_lines: 30
  key_links:
    - from: "app/(authenticated)/compliance/page.tsx"
      to: "components/compliance-table/index.tsx"
      via: "component import and render"
      pattern: "ComplianceTable"
    - from: "components/compliance-table/index.tsx"
      to: "actions/compliance.ts"
      via: "fetch call on mount"
      pattern: "fetchComplianceSummary"
    - from: "components/compliance-table/index.tsx"
      to: "components/risk-badge/index.tsx"
      via: "cell renderer for risk column"
      pattern: "RiskBadge"
---

<objective>
Create the compliance dashboard UI: a page at /compliance with summary cards and a sortable/filterable table showing all active sickness cases with their risk indicators and deadline alerts.

Purpose: This is the user-facing compliance dashboard (COMP-06, COMP-07, COMP-08). HR and managers land on a single page showing real-time compliance risk across all active cases. Red/amber/green badges give instant visual status. Upcoming deadline alerts surface cases needing attention. Sorting and filtering let users focus on the highest-risk cases first.

Output: Compliance page, table component with TanStack Table, risk badge component, summary cards component.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-compliance-dashboard/06-01-SUMMARY.md

Key existing code to reference:
@app/(authenticated)/sickness/history/page.tsx (TanStack Table page pattern)
@components/sidebar/nav-items.ts (nav already updated in plan 01)
@types/compliance.ts (ComplianceCaseView, ComplianceSummary, RiskLevel from plan 01)
@actions/compliance.ts (fetchComplianceSummary from plan 01)
@app/(authenticated)/dashboard/page.tsx (Card layout pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create risk badge and summary cards components</name>
  <files>
    components/risk-badge/index.tsx
    components/compliance-summary-cards/index.tsx
  </files>
  <action>
**components/risk-badge/index.tsx** -- RiskBadge component:

Named export. Props: `{ level: RiskLevel }` where RiskLevel is imported from types/compliance.

Render a Badge (from @/components/ui/badge) with colour-coded variants:
- RED: `className="bg-red-100 text-red-800 border-red-200"` with text "At Risk"
- AMBER: `className="bg-amber-100 text-amber-800 border-amber-200"` with text "Attention"
- GREEN: `className="bg-green-100 text-green-800 border-green-200"` with text "On Track"

Small size, no icon needed. Use the existing Badge component with `variant="outline"` and the className overrides above.

**components/compliance-summary-cards/index.tsx** -- ComplianceSummaryCards component:

Named export. Props: `{ summary: ComplianceSummary }` (imported from types/compliance).

"use client" component. Render 4 Card components (from @/components/ui/card) in a responsive grid:

```
<div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
```

Cards:
1. **Total Active Cases** -- summary.totalActiveCases count, ShieldCheck icon (gray), subtitle "Across all employees"
2. **At Risk** -- summary.redCount count, text-red-600 for count, AlertTriangle icon (red), subtitle "Overdue milestone actions"
3. **Attention Needed** -- summary.amberCount count, text-amber-600 for count, Clock icon (amber), subtitle "Deadlines within 3 days"
4. **On Track** -- summary.greenCount count, text-green-600 for count, CheckCircle2 icon (green), subtitle "All milestones on schedule"

Follow the exact Card/CardHeader/CardTitle/CardContent pattern from the dashboard page. Use lucide-react icons: ShieldCheck, AlertTriangle, Clock, CheckCircle2.
  </action>
  <verify>`npx tsc --noEmit --pretty 2>&1 | head -30` passes. Verify RiskBadge renders different colors for RED/AMBER/GREEN. Verify ComplianceSummaryCards renders 4 cards.</verify>
  <done>RiskBadge shows colour-coded risk indicators (red=At Risk, amber=Attention, green=On Track). ComplianceSummaryCards shows total cases and risk breakdown in a responsive grid.</done>
</task>

<task type="auto">
  <name>Task 2: Create compliance table and dashboard page</name>
  <files>
    components/compliance-table/index.tsx
    app/(authenticated)/compliance/page.tsx
  </files>
  <action>
**components/compliance-table/index.tsx** -- ComplianceTable component:

"use client" component. Named export.

1. On mount, call `fetchComplianceSummary()` via useState + useEffect pattern. Store ComplianceSummary in state. Show loading spinner while fetching.

2. Render ComplianceSummaryCards at the top with the summary data.

3. Below cards, render a filter bar:
   - Risk Level filter: buttons or a Select dropdown to filter by RED, AMBER, GREEN, or ALL. Use simple useState for the selected filter.
   - Apply filter client-side by filtering summary.cases before passing to table.

4. TanStack Table setup (follow pattern from absence history page):
   - Import `useReactTable, getCoreRowModel, getSortedRowModel, getFilteredRowModel, getPaginationRowModel` from @tanstack/react-table
   - Column definitions using createColumnHelper<ComplianceCaseView>():

   a. **Risk Level** column: accessor "riskLevel", cell renders `<RiskBadge level={row.original.riskLevel} />`. Sortable. Custom sort: RED=0, AMBER=1, GREEN=2 (so RED sorts first).

   b. **Employee** column: accessor combines employeeFirstName + employeeLastName. Cell renders "{firstName} {lastName}" or "Unknown" if null. Sortable.

   c. **Absence Type** column: accessor "absenceType". Sortable.

   d. **Start Date** column: accessor "absenceStartDate". Cell formats as "DD MMM YYYY" using date-fns format(). Sortable.

   e. **Status** column: accessor "status". Cell renders a Badge with the sickness case status.

   f. **Overdue** column: accessor "overdueCount". Cell renders count with red text if > 0. Sortable.

   g. **Next Deadline** column: accessor "nextDeadline". Cell renders formatted date or "-" if null. If nextDeadline is within 3 days, render in amber text. If past, render in red text. Sortable.

   h. **Alerts** column: accessor "upcomingAlerts". Cell renders:
      - If alerts.length === 0: "-"
      - If alerts exist: a small expandable section (Tooltip or inline list) showing each alert: "{milestoneLabel} - due in {daysUntilDue} day(s)" for positive days, "{milestoneLabel} - {Math.abs(daysUntilDue)} day(s) overdue" for negative days. Use red text for overdue, amber for upcoming.

   i. **Actions** column: cell renders a Link to `/sickness/{caseId}` with text "View Case" styled as a small button/link.

5. Render the table using the standard HTML table pattern with Tailwind classes (matching existing tables in the codebase):
   - `<table className="min-w-full divide-y divide-gray-200">`
   - Sortable column headers show sort indicator (chevron up/down)
   - Pagination at bottom using table.getCanPreviousPage(), table.getCanNextPage(), etc.
   - Page size: 20 rows

6. Empty state: If no active cases, show "No active sickness cases" centered message.

**app/(authenticated)/compliance/page.tsx** -- Compliance dashboard page:

Server component (no "use client"). Pattern follows other authenticated pages:

1. Import getAuthenticatedUser from supabase auth-helpers
2. Check auth, redirect to /login if not authenticated
3. Check roles: only ORG_ADMIN, HR, MANAGER should access. If user has none of these roles, redirect to /dashboard.
4. Render page layout:

```tsx
<div>
  <div className="mb-6">
    <h1 className="text-2xl font-semibold text-gray-900">Compliance Dashboard</h1>
    <p className="mt-1 text-sm text-gray-500">
      Real-time compliance risk across all active sickness cases.
    </p>
  </div>
  <ComplianceTable />
</div>
```

The ComplianceTable component handles all data fetching client-side (it's a "use client" component that calls the API).
  </action>
  <verify>`npx tsc --noEmit --pretty 2>&1 | head -30` passes. Verify /compliance page exists at app/(authenticated)/compliance/page.tsx. Verify ComplianceTable imports and uses TanStack Table with sorting. Verify RiskBadge is used in the risk level column. Verify Link to /sickness/{caseId} exists in the actions column.</verify>
  <done>Compliance dashboard at /compliance shows summary cards (total, red, amber, green counts) and a sortable/filterable TanStack Table with risk badges, deadline alerts, overdue counts, and links to individual cases. Accessible to ORG_ADMIN, HR, and MANAGER roles.</done>
</task>

</tasks>

<verification>
- Page loads at /compliance for ORG_ADMIN, HR, MANAGER roles
- Summary cards show correct red/amber/green counts from API
- Table sorts by risk level (RED first by default)
- Risk level filter works to show only RED, AMBER, or GREEN cases
- Each row shows colour-coded risk badge
- Overdue counts show in red text
- Next deadline shows amber/red warning colours when approaching/past
- Alerts column shows escalating deadline information
- "View Case" links navigate to correct sickness case detail
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Single page at /compliance shows all active cases with compliance status (COMP-08)
- Red/amber/green risk indicators visible per case based on milestone action status (COMP-06)
- Escalating deadline alerts shown for approaching milestones (COMP-07)
- Table is sortable by risk level, employee name, start date, next deadline
- Table is filterable by risk level
- Summary cards provide at-a-glance risk breakdown
</success_criteria>

<output>
After completion, create `.planning/phases/06-compliance-dashboard/06-02-SUMMARY.md`
</output>
