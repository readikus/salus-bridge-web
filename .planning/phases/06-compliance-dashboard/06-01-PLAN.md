---
phase: 06-compliance-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - providers/services/compliance.service.ts
  - app/api/compliance/route.ts
  - actions/compliance.ts
  - types/compliance.ts
  - constants/permissions.ts
  - components/sidebar/nav-items.ts
autonomous: true

must_haves:
  truths:
    - "Each active sickness case has a computed risk level (RED/AMBER/GREEN) based on milestone action statuses"
    - "RED means at least one milestone action is OVERDUE for that case"
    - "AMBER means at least one milestone action is PENDING with due date within 3 days"
    - "GREEN means all milestone actions are COMPLETED/SKIPPED or not yet approaching due date"
    - "Dashboard API returns all active cases with their risk level, overdue count, upcoming count, and next deadline"
    - "Manager sees only their team's cases; HR/admin sees all org cases"
  artifacts:
    - path: "types/compliance.ts"
      provides: "ComplianceCaseView, RiskLevel, ComplianceSummary interfaces"
    - path: "providers/services/compliance.service.ts"
      provides: "ComplianceService with risk computation and case aggregation"
      exports: ["ComplianceService"]
    - path: "app/api/compliance/route.ts"
      provides: "GET endpoint returning compliance data for active cases"
      exports: ["GET"]
    - path: "actions/compliance.ts"
      provides: "Client-side fetch wrapper for compliance API"
  key_links:
    - from: "providers/services/compliance.service.ts"
      to: "providers/repositories/milestone-action.repository.ts"
      via: "queries milestone actions per case for risk computation"
      pattern: "MilestoneActionRepository"
    - from: "providers/services/compliance.service.ts"
      to: "providers/services/sickness-case.service.ts"
      via: "gets active cases for org or manager team"
      pattern: "SicknessCaseService"
    - from: "app/api/compliance/route.ts"
      to: "providers/services/compliance.service.ts"
      via: "service call"
      pattern: "ComplianceService"
---

<objective>
Create the compliance data layer: a service that computes per-case risk levels from milestone action statuses, an API route that serves compliance data for all active cases, and supporting types/actions.

Purpose: This plan builds the data foundation for the compliance dashboard. ComplianceService aggregates milestone action data per active sickness case to compute a red/amber/green risk indicator. RED = overdue actions exist. AMBER = actions due within 3 days. GREEN = all clear. The API route serves this data scoped by role (manager sees team, HR/admin sees all).

Output: ComplianceService, GET /api/compliance endpoint, client action, TypeScript types, permission + nav updates.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-milestone-actions-and-communication-log/05-01-SUMMARY.md

Key existing code to reference:
@providers/repositories/milestone-action.repository.ts (findBySicknessCase, findOverdue, findByOrgAndStatus)
@providers/services/sickness-case.service.ts (getForOrganisation, getForManagerTeam -- active case queries)
@providers/services/tenant.service.ts (TenantService.withTenant pattern)
@app/api/sickness-cases/route.ts (API route pattern with auth + tenant context)
@app/(authenticated)/dashboard/page.tsx (role-based data scoping pattern)
@constants/permissions.ts (PERMISSIONS, ROLE_PERMISSIONS)
@components/sidebar/nav-items.ts (NAV_ITEMS)
@types/database.ts (SicknessCase, MilestoneAction interfaces)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create compliance types, service, and permission updates</name>
  <files>
    types/compliance.ts
    providers/services/compliance.service.ts
    constants/permissions.ts
    components/sidebar/nav-items.ts
  </files>
  <action>
**types/compliance.ts** -- Create compliance-specific interfaces:

```ts
export type RiskLevel = 'RED' | 'AMBER' | 'GREEN';

export interface ComplianceCaseView {
  caseId: string;
  employeeId: string;
  employeeFirstName: string | null;
  employeeLastName: string | null;
  absenceType: string;
  absenceStartDate: string;
  status: string;
  isLongTerm: boolean;
  riskLevel: RiskLevel;
  overdueCount: number;
  pendingCount: number;
  completedCount: number;
  upcomingAlerts: ComplianceAlert[];
  nextDeadline: string | null; // earliest pending due date
}

export interface ComplianceAlert {
  milestoneKey: string;
  milestoneLabel: string;
  dueDate: string;
  daysUntilDue: number; // negative = overdue
  actionType: string;
}

export interface ComplianceSummary {
  totalActiveCases: number;
  redCount: number;
  amberCount: number;
  greenCount: number;
  cases: ComplianceCaseView[];
}
```

**providers/services/compliance.service.ts** -- ComplianceService:

Static class with methods:

- `getComplianceSummary(organisationId: string, caseIds?: string[])`:
  1. Call `SicknessCaseService.getForOrganisation(organisationId)` to get all cases
  2. Filter to active statuses only: REPORTED, TRACKING, FIT_NOTE_RECEIVED, RTW_SCHEDULED (same ACTIVE_STATUSES from dashboard page)
  3. If caseIds provided, further filter to only those case IDs (used for manager team scoping)
  4. For each active case, call `computeCaseRisk(case, organisationId)`
  5. Build ComplianceSummary: count red/amber/green totals, return all ComplianceCaseView items sorted by riskLevel (RED first, then AMBER, then GREEN)

- `computeCaseRisk(sicknessCase: SicknessCase, organisationId: string)`: Returns ComplianceCaseView.
  1. Use TenantService.withTenant to get milestone actions: `MilestoneActionRepository.findBySicknessCaseWithDetails(sicknessCase.id, client)`
  2. BUT first, lazily mark overdue: for any PENDING action where dueDate < today, call `MilestoneActionRepository.updateStatus(action.id, 'OVERDUE')`
  3. Compute counts: overdueCount (OVERDUE status), pendingCount (PENDING status), completedCount (COMPLETED + SKIPPED)
  4. Compute upcomingAlerts: PENDING actions with dueDate within 7 days from today. Include daysUntilDue = differenceInCalendarDays(dueDate, today). Sort by dueDate ascending.
  5. Determine riskLevel:
     - RED if overdueCount > 0
     - AMBER if any PENDING action has dueDate within 3 days (daysUntilDue <= 3 AND daysUntilDue >= 0)
     - GREEN otherwise
  6. nextDeadline = earliest PENDING action's dueDate, or null if no pending actions
  7. Return ComplianceCaseView with all fields populated from the sickness case + computed risk data

- `getComplianceForManager(managerId: string, organisationId: string)`:
  1. Call `SicknessCaseService.getForManagerTeam(managerId, organisationId)` to get team cases
  2. Extract case IDs
  3. Call `getComplianceSummary(organisationId, caseIds)`

Use `date-fns` differenceInCalendarDays and parseISO for date math (already in project).

**constants/permissions.ts** -- Add new permission:
- Add `VIEW_COMPLIANCE: "view:compliance"` to PERMISSIONS object
- Add to PLATFORM_ADMIN, ORG_ADMIN, HR, and MANAGER role permission arrays

**components/sidebar/nav-items.ts** -- Add nav item:
- Import `ShieldCheck` from lucide-react (compliance icon)
- Add nav item: `{ label: "Compliance", href: "/compliance", icon: ShieldCheck, roles: [UserRole.ORG_ADMIN, UserRole.HR, UserRole.MANAGER] }`
- Place it after the "Analytics" item and before "Settings"
  </action>
  <verify>`npx tsc --noEmit --pretty 2>&1 | head -30` passes. Verify ComplianceService has getComplianceSummary and computeCaseRisk methods. Verify VIEW_COMPLIANCE permission exists in PERMISSIONS and is assigned to ORG_ADMIN, HR, MANAGER. Verify ShieldCheck icon imported and nav item added.</verify>
  <done>ComplianceService computes RED/AMBER/GREEN risk per active case based on milestone action overdue/pending/completed status. Risk levels correctly prioritize: RED (overdue) > AMBER (due within 3 days) > GREEN. Permission and nav item added for HR, managers, and org admins.</done>
</task>

<task type="auto">
  <name>Task 2: Create compliance API route and client action</name>
  <files>
    app/api/compliance/route.ts
    actions/compliance.ts
  </files>
  <action>
**app/api/compliance/route.ts** -- GET endpoint:

Follow the established API route pattern (see app/api/sickness-cases/route.ts):

1. Get session user via getAuthenticatedUser(), return 401 if not authenticated
2. Check VIEW_COMPLIANCE permission via hasPermission(), return 403 if unauthorized
3. Get organisationId from sessionUser.currentOrganisationId, return 400 if missing
4. Determine scope by role:
   - If user has ORG_ADMIN or HR role: call `ComplianceService.getComplianceSummary(organisationId)` (all org cases)
   - If user has MANAGER role only: find employee record via `EmployeeRepository.findByUserId(sessionUser.id)`, then call `ComplianceService.getComplianceForManager(employee.id, organisationId)` (team cases only)
5. Return JSON response: `{ summary: ComplianceSummary }`
6. Wrap in try/catch, return 500 on error with `{ error: "Failed to load compliance data" }`

**actions/compliance.ts** -- Client-side fetch wrapper:

```ts
import { ComplianceSummary } from "@/types/compliance";

export async function fetchComplianceSummary(): Promise<ComplianceSummary> {
  const response = await fetch("/api/compliance");
  if (!response.ok) {
    throw new Error("Failed to fetch compliance data");
  }
  const data = await response.json();
  return data.summary;
}
```
  </action>
  <verify>`npx tsc --noEmit --pretty 2>&1 | head -30` passes. Verify GET handler in app/api/compliance/route.ts exists. Verify role-based scoping: HR/admin gets all org cases, manager gets team cases only. Verify actions/compliance.ts exports fetchComplianceSummary.</verify>
  <done>GET /api/compliance returns ComplianceSummary with role-based scoping. HR/admin sees all org cases, managers see team only. Client action provides typed fetch wrapper.</done>
</task>

</tasks>

<verification>
- ComplianceService correctly marks overdue actions before computing risk
- Risk levels follow priority: RED (overdue) > AMBER (due within 3 days) > GREEN
- API route enforces VIEW_COMPLIANCE permission
- Manager scoping uses team visibility (not all org cases)
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
- ComplianceService.getComplianceSummary returns red/amber/green counts and per-case risk data
- Each ComplianceCaseView has riskLevel, overdueCount, pendingCount, upcomingAlerts, nextDeadline
- API route scopes data by role: HR/admin = all org, manager = team only
- VIEW_COMPLIANCE permission gates the endpoint
- Compliance nav item visible to ORG_ADMIN, HR, MANAGER
</success_criteria>

<output>
After completion, create `.planning/phases/06-compliance-dashboard/06-01-SUMMARY.md`
</output>
