---
phase: 03-monitoring-and-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/migrations/20260216000001_create_trigger_configs.ts
  - database/migrations/20260216000002_create_trigger_alerts.ts
  - types/database.ts
  - types/enums.ts
  - constants/permissions.ts
  - constants/bradford-factor.ts
  - schemas/trigger-config.ts
  - providers/repositories/trigger-config.repository.ts
  - providers/repositories/trigger-alert.repository.ts
  - providers/services/bradford-factor.service.ts
  - providers/services/trigger.service.ts
  - app/api/organisations/[slug]/triggers/route.ts
  - app/api/organisations/[slug]/triggers/[id]/route.ts
  - app/api/organisations/[slug]/bradford-factor/route.ts
  - app/api/employees/[id]/bradford-factor/route.ts
  - emails/trigger-alert.tsx
  - app/(authenticated)/organisations/[slug]/triggers/page.tsx
  - components/trigger-config-form/index.tsx
  - components/bradford-factor-badge/index.tsx
  - actions/triggers.ts
  - actions/bradford-factor.ts
autonomous: true

must_haves:
  truths:
    - "Org admin can configure absence trigger thresholds (frequency count, period, Bradford Factor score)"
    - "System alerts manager/HR when an employee hits a configured trigger point"
    - "Bradford Factor is calculated per employee and visible to managers and HR"
  artifacts:
    - path: "providers/services/bradford-factor.service.ts"
      provides: "Bradford Factor calculation from sickness case history"
      exports: ["BradfordFactorService"]
    - path: "providers/services/trigger.service.ts"
      provides: "Trigger evaluation and alert dispatch"
      exports: ["TriggerService"]
    - path: "database/migrations/20260216000001_create_trigger_configs.ts"
      provides: "trigger_configs table for org-level threshold configuration"
      contains: "CREATE TABLE trigger_configs"
    - path: "database/migrations/20260216000002_create_trigger_alerts.ts"
      provides: "trigger_alerts table for tracking fired alerts"
      contains: "CREATE TABLE trigger_alerts"
    - path: "app/api/organisations/[slug]/triggers/route.ts"
      provides: "CRUD API for trigger configurations"
      exports: ["GET", "POST"]
    - path: "app/(authenticated)/organisations/[slug]/triggers/page.tsx"
      provides: "Trigger configuration UI for org admins"
  key_links:
    - from: "providers/services/trigger.service.ts"
      to: "providers/services/bradford-factor.service.ts"
      via: "BradfordFactorService.calculate() call during trigger evaluation"
      pattern: "BradfordFactorService\\.calculate"
    - from: "providers/services/trigger.service.ts"
      to: "providers/services/notification.service.ts"
      via: "Fire-and-forget notification on trigger breach"
      pattern: "NotificationService\\.send"
    - from: "providers/services/sickness-case.service.ts"
      to: "providers/services/trigger.service.ts"
      via: "TriggerService.evaluate() called after case creation/transition"
      pattern: "TriggerService\\.evaluate"
---

<objective>
Create the trigger points and Bradford Factor system for absence monitoring.

Purpose: Org admins need to define when absence patterns require intervention. The Bradford Factor (S x S x D, where S = spell count and D = total days) quantifies short, frequent absences. Trigger rules let orgs define thresholds that fire alerts to manager/HR when breached.

Output: Database tables for trigger configs and alerts, Bradford Factor calculation service, trigger evaluation engine with notification integration, configuration UI, and Bradford Factor visibility for managers/HR.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sickness-lifecycle/02-01-SUMMARY.md
@.planning/phases/02-sickness-lifecycle/02-05-SUMMARY.md
@providers/repositories/sickness-case.repository.ts
@providers/services/notification.service.ts
@providers/services/tenant.service.ts
@providers/services/organisation.service.ts
@schemas/organisation.ts
@constants/permissions.ts
@types/database.ts
@types/enums.ts
@database/migrations/20260215000001_create_sickness_cases.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database schema, types, constants, and Bradford Factor service</name>
  <files>
    database/migrations/20260216000001_create_trigger_configs.ts
    database/migrations/20260216000002_create_trigger_alerts.ts
    types/database.ts
    types/enums.ts
    constants/permissions.ts
    constants/bradford-factor.ts
    schemas/trigger-config.ts
    providers/repositories/trigger-config.repository.ts
    providers/repositories/trigger-alert.repository.ts
    providers/services/bradford-factor.service.ts
  </files>
  <action>
    **Migration 1 -- trigger_configs table:**
    ```sql
    CREATE TABLE trigger_configs (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      organisation_id UUID NOT NULL REFERENCES organisations(id) ON DELETE CASCADE,
      name VARCHAR(100) NOT NULL,
      trigger_type VARCHAR(30) NOT NULL, -- 'FREQUENCY', 'BRADFORD_FACTOR', 'DURATION'
      threshold_value INTEGER NOT NULL,  -- e.g., 3 absences, 200 Bradford score, 28 days
      period_days INTEGER,               -- lookback period (NULL for Bradford which is rolling 52 weeks)
      is_active BOOLEAN DEFAULT true,
      created_by UUID NOT NULL REFERENCES users(id),
      created_at TIMESTAMPTZ DEFAULT now(),
      updated_at TIMESTAMPTZ DEFAULT now()
    )
    ```
    Add indexes on organisation_id and (organisation_id, is_active). Add RLS policies matching Phase 1/2 pattern: org_isolation + platform_admin_bypass.

    **Migration 2 -- trigger_alerts table:**
    ```sql
    CREATE TABLE trigger_alerts (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      organisation_id UUID NOT NULL REFERENCES organisations(id) ON DELETE CASCADE,
      trigger_config_id UUID NOT NULL REFERENCES trigger_configs(id) ON DELETE CASCADE,
      employee_id UUID NOT NULL REFERENCES employees(id) ON DELETE CASCADE,
      sickness_case_id UUID REFERENCES sickness_cases(id) ON DELETE SET NULL,
      triggered_value INTEGER NOT NULL,  -- actual value that breached threshold
      acknowledged_by UUID REFERENCES users(id),
      acknowledged_at TIMESTAMPTZ,
      created_at TIMESTAMPTZ DEFAULT now()
    )
    ```
    Add indexes on organisation_id, employee_id, and (organisation_id, acknowledged_at) for unacknowledged alert queries. Add RLS policies.

    **types/database.ts:** Add TriggerConfig and TriggerAlert interfaces following existing camelCase pattern.

    **types/enums.ts:** Add `TRIGGER_CONFIG = "TRIGGER_CONFIG"` and `TRIGGER_ALERT = "TRIGGER_ALERT"` to AuditEntity. Add `ALERT = "ALERT"` to AuditAction.

    **constants/permissions.ts:** Add `MANAGE_TRIGGERS: "manage:triggers"` and `VIEW_TRIGGERS: "view:triggers"` permissions. MANAGE_TRIGGERS granted to PLATFORM_ADMIN, ORG_ADMIN. VIEW_TRIGGERS granted to PLATFORM_ADMIN, ORG_ADMIN, HR, MANAGER.

    **constants/bradford-factor.ts:** Export `BRADFORD_LOOKBACK_WEEKS = 52` and `BRADFORD_RISK_LEVELS` as:
    ```ts
    export const BRADFORD_RISK_LEVELS = [
      { min: 0, max: 49, label: 'Low', color: 'green' },
      { min: 50, max: 199, label: 'Medium', color: 'amber' },
      { min: 200, max: 499, label: 'High', color: 'orange' },
      { min: 500, max: Infinity, label: 'Critical', color: 'red' },
    ] as const;
    ```
    Export helper `getBradfordRiskLevel(score: number)` that returns the matching level.

    **schemas/trigger-config.ts:** Zod schema for creating/updating trigger configs. Fields: name (string 3-100), triggerType (enum: FREQUENCY, BRADFORD_FACTOR, DURATION), thresholdValue (int, min 1), periodDays (int, min 1, optional -- required for FREQUENCY and DURATION types, ignored for BRADFORD_FACTOR). Add `.refine()` to enforce periodDays presence when type is FREQUENCY or DURATION.

    **providers/repositories/trigger-config.repository.ts:** Static class with:
    - `findByOrganisation(orgId, client?)` -- returns all configs, ordered by created_at
    - `findById(id, client?)` -- single config
    - `findActiveByOrganisation(orgId, client?)` -- active configs only
    - `create(data, client?)` -- insert and return
    - `update(id, data, client?)` -- partial update, return updated
    - `delete(id, client?)` -- hard delete
    Follow existing pattern: parameterised SQL, snake_case AS "camelCase".

    **providers/repositories/trigger-alert.repository.ts:** Static class with:
    - `findByOrganisation(orgId, filters?, client?)` -- filters: employeeId, acknowledged (bool), limit/offset
    - `findByEmployee(employeeId, client?)` -- all alerts for employee
    - `create(data, client?)` -- insert alert record
    - `acknowledge(id, userId, client?)` -- set acknowledged_by and acknowledged_at
    - `existsForTriggerAndCase(triggerConfigId, sicknessCaseId, client?)` -- dedup check to prevent duplicate alerts for same trigger+case

    **providers/services/bradford-factor.service.ts:** Static class `BradfordFactorService` with:
    - `calculate(employeeId, client?)` -- Fetches all sickness cases for employee in last 52 weeks. Calculates S (number of absence spells) and D (total working days lost across all spells). Formula: score = S * S * D. Returns `{ score: number, spells: number, totalDays: number, riskLevel: string }`. Uses SicknessCaseRepository.findByEmployee, filters by date in application code (absenceStartDate within 52 weeks of today). For cases without absenceEndDate (ongoing), count working days from start to today using simple weekday count (not WorkingDaysService -- bank holidays not relevant for Bradford).
    - `calculateForTeam(employeeIds: string[], client?)` -- Calls calculate for each employee, returns Map<employeeId, result>. Used for team/department aggregation views.
  </action>
  <verify>
    `npx tsc --noEmit` compiles cleanly. Migration files exist with correct SQL. Bradford Factor service imports resolve. All new types/interfaces accessible from their modules.
  </verify>
  <done>
    Two migration files create trigger_configs and trigger_alerts tables with RLS. TriggerConfig and TriggerAlert interfaces in types/database.ts. New audit enums, permissions (MANAGE_TRIGGERS, VIEW_TRIGGERS), Bradford Factor constants with risk levels. Zod schema validates trigger config input. Repositories for both tables follow existing pattern. BradfordFactorService.calculate returns { score, spells, totalDays, riskLevel } for any employee.
  </done>
</task>

<task type="auto">
  <name>Task 2: Trigger evaluation service, alert notifications, and API routes</name>
  <files>
    providers/services/trigger.service.ts
    providers/services/sickness-case.service.ts
    emails/trigger-alert.tsx
    app/api/organisations/[slug]/triggers/route.ts
    app/api/organisations/[slug]/triggers/[id]/route.ts
    app/api/organisations/[slug]/bradford-factor/route.ts
    app/api/employees/[id]/bradford-factor/route.ts
    actions/triggers.ts
    actions/bradford-factor.ts
  </files>
  <action>
    **providers/services/trigger.service.ts:** Static class `TriggerService` with:
    - `evaluate(employeeId, organisationId, sicknessCaseId, client?)` -- Loads all active trigger configs for org. For each config:
      - FREQUENCY: Count sickness cases for employee in last `periodDays`. If count >= thresholdValue, fire alert.
      - BRADFORD_FACTOR: Calculate via BradfordFactorService. If score >= thresholdValue, fire alert.
      - DURATION: Sum working_days_lost for employee in last `periodDays`. If total >= thresholdValue, fire alert.
      Before creating alert, call TriggerAlertRepository.existsForTriggerAndCase to prevent duplicate alerts for same trigger+case combination.
    - `fireAlert(triggerConfig, employeeId, sicknessCaseId, triggeredValue, client?)` -- Creates TriggerAlert record, sends notification to employee's manager and org HR users via NotificationService (fire-and-forget pattern). Logs audit with AuditEntity.TRIGGER_ALERT.
    - `getAlerts(organisationId, filters?, client?)` -- Proxies to TriggerAlertRepository.findByOrganisation.
    - `acknowledgeAlert(alertId, userId, client?)` -- Marks alert as acknowledged. Audit logs the acknowledgement.

    **providers/services/sickness-case.service.ts:** Add fire-and-forget TriggerService.evaluate call after case creation (in the create method, after the existing notification dispatch). Also add after case status transitions in the workflow service integration point (when status changes to TRACKING or CLOSED -- CLOSED because end date is set and working_days_lost is calculated). Pattern: `try { await TriggerService.evaluate(...) } catch (e) { console.error('[TriggerService] evaluation failed:', e) }`.

    **emails/trigger-alert.tsx:** React Email template following existing pattern (SicknessReportedEmail as reference). Props: employeeName (first + last initial for privacy), triggerName, triggerType, thresholdValue, actualValue, organisationName. Subject: "Absence Trigger Alert - {employeeName}". Body: "{employeeName} has breached the '{triggerName}' threshold ({actualValue} vs threshold of {thresholdValue})." Include CTA button linking to employee's trigger alerts page. NO health details, NO specific conditions -- privacy-safe per COMP-03 pattern.

    **app/api/organisations/[slug]/triggers/route.ts:**
    - GET: List trigger configs for org. Requires VIEW_TRIGGERS permission. Returns configs array.
    - POST: Create trigger config. Requires MANAGE_TRIGGERS permission. Validates body with TriggerConfigSchema. Audit logs creation.

    **app/api/organisations/[slug]/triggers/[id]/route.ts:**
    - PUT: Update trigger config. Requires MANAGE_TRIGGERS permission.
    - DELETE: Delete trigger config. Requires MANAGE_TRIGGERS permission.

    **app/api/organisations/[slug]/bradford-factor/route.ts:**
    - GET: Returns Bradford Factor scores for all employees in org (or filtered by departmentId query param). Requires VIEW_TRIGGERS permission. Uses BradfordFactorService.calculateForTeam with employee IDs from EmployeeRepository.findByOrganisation. Returns array of { employeeId, firstName, lastName, departmentName, score, spells, totalDays, riskLevel }.

    **app/api/employees/[id]/bradford-factor/route.ts:**
    - GET: Returns Bradford Factor for a single employee. Manager can view for direct reports, HR/admin for any in org. Uses BradfordFactorService.calculate.

    **actions/triggers.ts:** Client-side fetch wrappers: fetchTriggerConfigs(slug), createTriggerConfig(slug, data), updateTriggerConfig(slug, id, data), deleteTriggerConfig(slug, id), fetchTriggerAlerts(slug, filters?), acknowledgeTriggerAlert(slug, alertId).

    **actions/bradford-factor.ts:** Client-side fetch wrappers: fetchOrgBradfordFactors(slug, departmentId?), fetchEmployeeBradfordFactor(employeeId).

    All API routes follow existing pattern: session check -> AuthService permission validation -> TenantService.withTenant -> service call -> audit log -> JSON response.
  </action>
  <verify>
    `npx tsc --noEmit` compiles cleanly. API route files export correct HTTP method handlers. Actions use correct API paths. TriggerService.evaluate is called from sickness-case.service.ts creation flow.
  </verify>
  <done>
    TriggerService evaluates all active org triggers when a sickness case is created or transitions. Duplicate alerts prevented via existsForTriggerAndCase check. Manager and HR receive fire-and-forget privacy-safe email on trigger breach. Full CRUD API for trigger configs with proper RBAC. Bradford Factor API returns per-employee and org-wide scores. Client actions wrap all API calls.
  </done>
</task>

<task type="auto">
  <name>Task 3: Trigger configuration UI and Bradford Factor display</name>
  <files>
    app/(authenticated)/organisations/[slug]/triggers/page.tsx
    components/trigger-config-form/index.tsx
    components/bradford-factor-badge/index.tsx
    components/sidebar/nav-items.ts
  </files>
  <action>
    **components/trigger-config-form/index.tsx:** 'use client' component. React Hook Form + Zod resolver using TriggerConfigSchema. Fields:
    - Name (text input)
    - Trigger Type (select: Frequency, Bradford Factor, Duration)
    - Threshold Value (number input, label changes based on type: "Number of absences" / "Bradford Factor score" / "Working days lost")
    - Period (number input for days, hidden when type is Bradford Factor since it's always 52 weeks)
    - Active toggle (switch)
    Props: onSubmit, initialValues (for edit mode), isLoading. Use shadcn/ui form components (Input, Select, Switch, Button, Label).

    **components/bradford-factor-badge/index.tsx:** Small presentational component. Props: score (number), showLabel (boolean, default true). Uses getBradfordRiskLevel to determine color. Renders as a colored badge/pill with the score and risk level label. Colors: green for Low, amber for Medium, orange for High, red for Critical. Use tailwind classes with cn() from tailwind-merge.

    **app/(authenticated)/organisations/[slug]/triggers/page.tsx:** 'use client' page with two tabs (shadcn Tabs component):
    - **Tab 1: "Trigger Rules"** -- Lists existing trigger configs in a table (name, type, threshold, period, active status, actions). "Add Trigger" button opens the form in a dialog/sheet. Edit/delete actions per row. Uses TanStack Query for data fetching via actions/triggers.ts. useMutation for create/update/delete with optimistic updates or query invalidation.
    - **Tab 2: "Alerts"** -- Lists recent trigger alerts in a table (employee name, trigger name, value, date, acknowledged status). "Acknowledge" button per row for unacknowledged alerts. Filter: show all / unacknowledged only.

    Add Bradford Factor badge to the alerts table rows where trigger type is BRADFORD_FACTOR.

    **components/sidebar/nav-items.ts:** Add "Triggers" nav item under the organisation section, visible to roles with VIEW_TRIGGERS permission. Icon: AlertTriangle from lucide-react. Path: `/organisations/{slug}/triggers`.
  </action>
  <verify>
    `npx tsc --noEmit` compiles. Page renders without errors (check for missing imports). Nav item appears in sidebar configuration. Form validates correctly per Zod schema (type-dependent period field visibility).
  </verify>
  <done>
    Org admins can view, create, edit, and delete trigger configurations via a tabbed UI. Trigger type selection dynamically adjusts the form fields. Alerts tab shows all triggered alerts with acknowledge functionality. Bradford Factor badge component renders risk-level-colored scores. Triggers nav item visible in sidebar for authorised roles.
  </done>
</task>

</tasks>

<verification>
- Trigger configs CRUD: Create a FREQUENCY trigger (3 absences in 90 days), verify it appears in the list, edit threshold to 5, delete it
- Bradford Factor calculation: For an employee with 3 absence spells totaling 10 working days, score should be 3*3*10 = 90 (Medium risk)
- Alert deduplication: Creating the same sickness case should not produce duplicate alerts for the same trigger
- Privacy: Trigger alert email contains no health details, only employee name (first + last initial), trigger name, and threshold info
- Permission enforcement: EMPLOYEE role cannot access /triggers routes, MANAGER can view but not manage
</verification>

<success_criteria>
TRIG-01: Org admin can create, edit, and delete trigger threshold configurations (frequency, Bradford Factor, duration types)
TRIG-02: System evaluates triggers on case creation/transition and sends privacy-safe email alerts to manager/HR on breach
TRIG-03: Bradford Factor calculated per employee with risk level, visible via API and UI badge component
</success_criteria>

<output>
After completion, create `.planning/phases/03-monitoring-and-intelligence/03-01-SUMMARY.md`
</output>
