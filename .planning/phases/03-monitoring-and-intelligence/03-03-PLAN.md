---
phase: 03-monitoring-and-intelligence
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - database/migrations/20260216000003_create_oh_providers.ts
  - database/migrations/20260216000004_create_oh_referrals.ts
  - types/database.ts
  - types/enums.ts
  - constants/permissions.ts
  - constants/referral-statuses.ts
  - schemas/oh-provider.ts
  - schemas/oh-referral.ts
  - providers/repositories/oh-provider.repository.ts
  - providers/repositories/oh-referral.repository.ts
  - providers/services/oh-referral.service.ts
  - app/api/organisations/[slug]/oh-providers/route.ts
  - app/api/organisations/[slug]/oh-providers/[id]/route.ts
  - app/api/organisations/[slug]/oh-referrals/route.ts
  - app/api/organisations/[slug]/oh-referrals/[id]/route.ts
  - app/api/organisations/[slug]/oh-referrals/[id]/communications/route.ts
  - app/(authenticated)/organisations/[slug]/oh-providers/page.tsx
  - app/(authenticated)/organisations/[slug]/oh-referrals/page.tsx
  - app/(authenticated)/organisations/[slug]/oh-referrals/[id]/page.tsx
  - components/oh-provider-form/index.tsx
  - components/oh-referral-form/index.tsx
  - components/referral-status-badge/index.tsx
  - components/communication-log/index.tsx
  - actions/oh-providers.ts
  - actions/oh-referrals.ts
autonomous: true

must_haves:
  truths:
    - "Organisation admin can link external occupational health providers to their organisation"
    - "HR or manager can create an OH referral for a sickness case"
    - "Referral status is tracked through submitted, in progress, and report received stages"
    - "Communication between organisation and provider is logged"
  artifacts:
    - path: "database/migrations/20260216000003_create_oh_providers.ts"
      provides: "oh_providers table for linked external providers"
      contains: "CREATE TABLE oh_providers"
    - path: "database/migrations/20260216000004_create_oh_referrals.ts"
      provides: "oh_referrals and oh_referral_communications tables"
      contains: "CREATE TABLE oh_referrals"
    - path: "providers/services/oh-referral.service.ts"
      provides: "Referral lifecycle management with status transitions and communication logging"
      exports: ["OhReferralService"]
    - path: "app/(authenticated)/organisations/[slug]/oh-referrals/[id]/page.tsx"
      provides: "Referral detail page with status tracking and communication log"
  key_links:
    - from: "providers/services/oh-referral.service.ts"
      to: "providers/repositories/oh-referral.repository.ts"
      via: "Repository for referral CRUD and status transitions"
      pattern: "OhReferralRepository\\."
    - from: "app/api/organisations/[slug]/oh-referrals/[id]/communications/route.ts"
      to: "providers/services/oh-referral.service.ts"
      via: "OhReferralService.addCommunication for logging messages"
      pattern: "OhReferralService\\.addCommunication"
---

<objective>
Build the occupational health provider integration -- linking providers to organisations, creating referrals for sickness cases, tracking referral status, and logging communication.

Purpose: When an employee's absence requires occupational health assessment, HR or managers need to create a referral, track its progress through defined stages, and maintain a communication log with the provider. This closes the loop between absence monitoring and professional health support.

Output: Database tables for OH providers, referrals, and communications. Service layer for referral lifecycle. Provider management UI, referral creation/tracking UI, and communication log.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sickness-lifecycle/02-01-SUMMARY.md
@providers/repositories/sickness-case.repository.ts
@providers/services/tenant.service.ts
@constants/permissions.ts
@constants/sickness-states.ts
@types/database.ts
@types/enums.ts
@database/migrations/20260215000001_create_sickness_cases.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database schema, types, repositories, and referral service</name>
  <files>
    database/migrations/20260216000003_create_oh_providers.ts
    database/migrations/20260216000004_create_oh_referrals.ts
    types/database.ts
    types/enums.ts
    constants/permissions.ts
    constants/referral-statuses.ts
    schemas/oh-provider.ts
    schemas/oh-referral.ts
    providers/repositories/oh-provider.repository.ts
    providers/repositories/oh-referral.repository.ts
    providers/services/oh-referral.service.ts
  </files>
  <action>
    **Migration 3 -- oh_providers table:**
    ```sql
    CREATE TABLE oh_providers (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      organisation_id UUID NOT NULL REFERENCES organisations(id) ON DELETE CASCADE,
      name VARCHAR(200) NOT NULL,
      contact_email VARCHAR(255),
      contact_phone VARCHAR(50),
      address TEXT,
      notes TEXT,
      is_active BOOLEAN DEFAULT true,
      created_by UUID NOT NULL REFERENCES users(id),
      created_at TIMESTAMPTZ DEFAULT now(),
      updated_at TIMESTAMPTZ DEFAULT now()
    )
    ```
    Add index on organisation_id. Add RLS policies: org_isolation + platform_admin_bypass.

    **Migration 4 -- oh_referrals and oh_referral_communications tables:**
    ```sql
    CREATE TABLE oh_referrals (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      organisation_id UUID NOT NULL REFERENCES organisations(id) ON DELETE CASCADE,
      sickness_case_id UUID NOT NULL REFERENCES sickness_cases(id) ON DELETE CASCADE,
      employee_id UUID NOT NULL REFERENCES employees(id) ON DELETE CASCADE,
      provider_id UUID NOT NULL REFERENCES oh_providers(id) ON DELETE CASCADE,
      referred_by UUID NOT NULL REFERENCES users(id),
      status VARCHAR(30) NOT NULL DEFAULT 'SUBMITTED',
      reason TEXT NOT NULL,
      urgency VARCHAR(20) DEFAULT 'STANDARD',  -- 'URGENT', 'STANDARD'
      report_received_at TIMESTAMPTZ,
      report_notes_encrypted TEXT,
      created_at TIMESTAMPTZ DEFAULT now(),
      updated_at TIMESTAMPTZ DEFAULT now()
    )
    ```
    Add indexes on organisation_id, sickness_case_id, employee_id, provider_id, and status.

    ```sql
    CREATE TABLE oh_referral_communications (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      referral_id UUID NOT NULL REFERENCES oh_referrals(id) ON DELETE CASCADE,
      author_id UUID NOT NULL REFERENCES users(id),
      direction VARCHAR(10) NOT NULL,  -- 'INBOUND' (from provider), 'OUTBOUND' (to provider)
      message TEXT NOT NULL,
      created_at TIMESTAMPTZ DEFAULT now()
    )
    ```
    Add index on referral_id. Add RLS policies for both tables using join through oh_referrals -> organisation_id pattern (same as case_transitions pattern from Phase 2).

    **types/database.ts:** Add OhProvider, OhReferral, and OhReferralCommunication interfaces following existing camelCase pattern.

    **types/enums.ts:** Add `OH_PROVIDER = "OH_PROVIDER"`, `OH_REFERRAL = "OH_REFERRAL"` to AuditEntity. Add `REFER = "REFER"` to AuditAction.

    **constants/permissions.ts:** Add:
    - `MANAGE_OH_PROVIDERS: "manage:oh_providers"` -- PLATFORM_ADMIN, ORG_ADMIN
    - `VIEW_OH_PROVIDERS: "view:oh_providers"` -- PLATFORM_ADMIN, ORG_ADMIN, HR
    - `CREATE_REFERRAL: "create:oh_referral"` -- PLATFORM_ADMIN, ORG_ADMIN, HR, MANAGER
    - `VIEW_REFERRALS: "view:oh_referrals"` -- PLATFORM_ADMIN, ORG_ADMIN, HR, MANAGER

    **constants/referral-statuses.ts:** Export ReferralStatus enum and VALID_REFERRAL_TRANSITIONS:
    ```ts
    export enum ReferralStatus {
      SUBMITTED = 'SUBMITTED',
      IN_PROGRESS = 'IN_PROGRESS',
      REPORT_RECEIVED = 'REPORT_RECEIVED',
      CLOSED = 'CLOSED',
    }
    export const VALID_REFERRAL_TRANSITIONS: Record<ReferralStatus, ReferralStatus[]> = {
      [ReferralStatus.SUBMITTED]: [ReferralStatus.IN_PROGRESS, ReferralStatus.CLOSED],
      [ReferralStatus.IN_PROGRESS]: [ReferralStatus.REPORT_RECEIVED, ReferralStatus.CLOSED],
      [ReferralStatus.REPORT_RECEIVED]: [ReferralStatus.CLOSED],
      [ReferralStatus.CLOSED]: [],
    };
    ```
    Export REFERRAL_STATUS_LABELS with human-readable names.

    **schemas/oh-provider.ts:** Zod schema: name (string 3-200), contactEmail (email, optional), contactPhone (string, optional), address (string, optional), notes (string, optional).

    **schemas/oh-referral.ts:** Zod schemas:
    - CreateOhReferralSchema: sicknessCaseId (UUID), providerId (UUID), reason (string, min 10 chars), urgency (enum: URGENT, STANDARD, default STANDARD).
    - UpdateReferralStatusSchema: status (ReferralStatus enum), reportNotesEncrypted (optional string, for REPORT_RECEIVED status).
    - AddCommunicationSchema: direction (enum: INBOUND, OUTBOUND), message (string, min 1 char).

    **providers/repositories/oh-provider.repository.ts:** Static class:
    - `findByOrganisation(orgId, client?)` -- all providers, ordered by name
    - `findById(id, client?)` -- single provider
    - `create(data, client?)` -- insert and return
    - `update(id, data, client?)` -- partial update
    - `delete(id, client?)` -- hard delete (cascade will remove referrals)

    **providers/repositories/oh-referral.repository.ts:** Static class:
    - `findByOrganisation(orgId, filters?, client?)` -- filters: status, employeeId, providerId. Joins sickness_cases for case info, employees+users for employee name, oh_providers for provider name.
    - `findById(id, client?)` -- with joins for related names
    - `findBySicknessCase(sicknessCaseId, client?)` -- all referrals for a case
    - `create(data, client?)` -- insert with organisation_id, employee_id derived from sickness case
    - `updateStatus(id, status, reportNotesEncrypted?, client?)` -- update status + report_received_at if REPORT_RECEIVED
    - `addCommunication(data, client?)` -- insert into oh_referral_communications
    - `getCommunications(referralId, client?)` -- all comms for a referral, ordered by created_at ASC

    **providers/services/oh-referral.service.ts:** Static class:
    - `create(params, userId, organisationId, client?)` -- Validates sickness case exists and belongs to org. Creates referral with employee_id from the sickness case. Audit logs with AuditEntity.OH_REFERRAL, AuditAction.REFER.
    - `updateStatus(referralId, newStatus, reportNotesEncrypted?, userId, client?)` -- Validates transition via VALID_REFERRAL_TRANSITIONS. If REPORT_RECEIVED, encrypt reportNotes via EncryptionService before storing. Audit logs status change.
    - `addCommunication(referralId, direction, message, userId, client?)` -- Creates communication record. Audit logs.
    - `getById(referralId, client?)` -- Returns referral with communications.
    - `listByOrganisation(orgId, filters?, client?)` -- Proxies to repository.
  </action>
  <verify>
    `npx tsc --noEmit` compiles cleanly. Migration files have correct SQL. Referral status transitions validated (SUBMITTED can go to IN_PROGRESS but not REPORT_RECEIVED). All interfaces in types/database.ts. Permissions added to constants.
  </verify>
  <done>
    Four migration files create oh_providers, oh_referrals, and oh_referral_communications tables with RLS policies. Type interfaces, audit enums, permissions (MANAGE_OH_PROVIDERS, VIEW_OH_PROVIDERS, CREATE_REFERRAL, VIEW_REFERRALS), referral status state machine with valid transitions. Zod schemas for all input validation. Repositories for both providers and referrals with full CRUD. OhReferralService manages referral lifecycle with status validation, encrypted report notes, and communication logging.
  </done>
</task>

<task type="auto">
  <name>Task 2: OH provider management UI and referral tracking UI</name>
  <files>
    app/(authenticated)/organisations/[slug]/oh-providers/page.tsx
    app/(authenticated)/organisations/[slug]/oh-referrals/page.tsx
    app/(authenticated)/organisations/[slug]/oh-referrals/[id]/page.tsx
    components/oh-provider-form/index.tsx
    components/oh-referral-form/index.tsx
    components/referral-status-badge/index.tsx
    components/communication-log/index.tsx
    app/api/organisations/[slug]/oh-providers/route.ts
    app/api/organisations/[slug]/oh-providers/[id]/route.ts
    app/api/organisations/[slug]/oh-referrals/route.ts
    app/api/organisations/[slug]/oh-referrals/[id]/route.ts
    app/api/organisations/[slug]/oh-referrals/[id]/communications/route.ts
    actions/oh-providers.ts
    actions/oh-referrals.ts
    components/sidebar/nav-items.ts
  </files>
  <action>
    **API Routes:**

    **app/api/organisations/[slug]/oh-providers/route.ts:**
    - GET: List providers. Requires VIEW_OH_PROVIDERS. Returns providers array.
    - POST: Create provider. Requires MANAGE_OH_PROVIDERS. Validates with OhProviderSchema.

    **app/api/organisations/[slug]/oh-providers/[id]/route.ts:**
    - PUT: Update provider. Requires MANAGE_OH_PROVIDERS.
    - DELETE: Delete provider. Requires MANAGE_OH_PROVIDERS.

    **app/api/organisations/[slug]/oh-referrals/route.ts:**
    - GET: List referrals. Requires VIEW_REFERRALS. Query params: status, employeeId, providerId. For MANAGER role, scope to their direct reports via recursive CTE employee IDs.
    - POST: Create referral. Requires CREATE_REFERRAL. Validates with CreateOhReferralSchema.

    **app/api/organisations/[slug]/oh-referrals/[id]/route.ts:**
    - GET: Get referral detail with communications. Requires VIEW_REFERRALS.
    - PATCH: Update referral status. Requires CREATE_REFERRAL (same users who can create can update status). Validates with UpdateReferralStatusSchema.

    **app/api/organisations/[slug]/oh-referrals/[id]/communications/route.ts:**
    - GET: List communications for referral. Requires VIEW_REFERRALS.
    - POST: Add communication. Requires CREATE_REFERRAL. Validates with AddCommunicationSchema.

    All routes follow existing pattern: session check -> permission validation -> TenantService.withTenant -> service call -> audit log -> JSON response.

    **actions/oh-providers.ts:** fetchOhProviders(slug), createOhProvider(slug, data), updateOhProvider(slug, id, data), deleteOhProvider(slug, id).

    **actions/oh-referrals.ts:** fetchOhReferrals(slug, filters?), fetchOhReferral(slug, id), createOhReferral(slug, data), updateReferralStatus(slug, id, data), fetchReferralCommunications(slug, id), addReferralCommunication(slug, id, data).

    **UI Components:**

    **components/oh-provider-form/index.tsx:** 'use client'. React Hook Form + Zod. Fields: name, contactEmail, contactPhone, address (textarea), notes (textarea). shadcn/ui Input, Textarea, Button. Props: onSubmit, initialValues?, isLoading.

    **components/oh-referral-form/index.tsx:** 'use client'. React Hook Form + Zod. Fields: sicknessCaseId (select, populated from active sickness cases for the employee or org), providerId (select, populated from org's OH providers), reason (textarea, min 10 chars), urgency (radio: Standard, Urgent). Props: onSubmit, providers (for select), sicknessCases (for select), isLoading.

    **components/referral-status-badge/index.tsx:** Presentational. Props: status (ReferralStatus). Colored badge: SUBMITTED=blue, IN_PROGRESS=amber, REPORT_RECEIVED=green, CLOSED=gray. Uses cn() from tailwind-merge.

    **components/communication-log/index.tsx:** 'use client'. Props: communications (array), onAddCommunication (callback). Renders a timeline-style list: each entry shows direction icon (ArrowRight for outbound, ArrowLeft for inbound from lucide-react), author name, message text, timestamp (formatted with date-fns). At bottom: form with direction select (Inbound/Outbound) and message textarea + "Add" button.

    **Pages:**

    **app/(authenticated)/organisations/[slug]/oh-providers/page.tsx:** 'use client'. Lists providers in a card grid. Each card: provider name, contact email, phone, address. Edit/Delete buttons for MANAGE_OH_PROVIDERS permission. "Add Provider" button opens form in a Dialog. TanStack Query for data. useMutation for CRUD.

    **app/(authenticated)/organisations/[slug]/oh-referrals/page.tsx:** 'use client'. Table listing all referrals. Columns: Employee Name, Provider, Status (ReferralStatusBadge), Urgency, Created Date, Actions (View). Filter by status (dropdown). "New Referral" button opens form in Dialog. TanStack Query for data.

    **app/(authenticated)/organisations/[slug]/oh-referrals/[id]/page.tsx:** 'use client'. Referral detail page. Top section: referral info card (employee, provider, status badge, urgency, reason, dates). Status transition buttons: Show valid next states from VALID_REFERRAL_TRANSITIONS. When transitioning to REPORT_RECEIVED, show a textarea for report notes. Below: CommunicationLog component with full message history and add form. TanStack Query for referral detail + communications.

    **components/sidebar/nav-items.ts:** Add two nav items under org section:
    - "OH Providers" -- visible to VIEW_OH_PROVIDERS roles. Icon: Building2 from lucide-react. Path: `/organisations/{slug}/oh-providers`.
    - "Referrals" -- visible to VIEW_REFERRALS roles. Icon: FileText from lucide-react. Path: `/organisations/{slug}/oh-referrals`.
  </action>
  <verify>
    `npx tsc --noEmit` compiles. All page files exist at correct paths. API routes export correct HTTP method handlers. Nav items added to sidebar. Referral status transitions validated in UI (only valid next states shown as buttons).
  </verify>
  <done>
    Full CRUD API for OH providers with RBAC. Referral creation linked to sickness cases with provider selection. Referral status tracked through SUBMITTED -> IN_PROGRESS -> REPORT_RECEIVED -> CLOSED with validated transitions. Communication log captures bidirectional messages with timestamps. Provider management in card grid with add/edit/delete. Referral list with status filtering. Referral detail page with status progression buttons, report notes on completion, and timeline communication log. Nav items for OH Providers and Referrals visible in sidebar.
  </done>
</task>

</tasks>

<verification>
- Provider CRUD: Create provider with name/email/phone, verify it appears, edit contact info, delete it
- Referral creation: Create referral for an active sickness case, selecting a provider, verify status is SUBMITTED
- Status transitions: Advance referral SUBMITTED -> IN_PROGRESS -> REPORT_RECEIVED (with notes) -> CLOSED. Verify invalid transitions are blocked (e.g., SUBMITTED -> REPORT_RECEIVED)
- Communication log: Add outbound message, add inbound message, verify both appear in timeline order
- MANAGER scoping: Manager sees only referrals for their direct reports
- Report notes encryption: When transitioning to REPORT_RECEIVED with notes, verify notes are stored encrypted via EncryptionService
</verification>

<success_criteria>
PROV-01: Org admin can add, edit, and remove OH providers linked to their organisation
PROV-02: HR or manager can create an OH referral for a sickness case, selecting provider and urgency
PROV-03: Referral status transitions through SUBMITTED -> IN_PROGRESS -> REPORT_RECEIVED -> CLOSED with validation
PROV-04: Communication log records bidirectional messages with author, direction, timestamp, and message content
</success_criteria>

<output>
After completion, create `.planning/phases/03-monitoring-and-intelligence/03-03-SUMMARY.md`
</output>
