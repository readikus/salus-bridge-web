---
phase: 03-monitoring-and-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - providers/repositories/analytics.repository.ts
  - providers/services/analytics.service.ts
  - schemas/analytics.ts
  - app/api/organisations/[slug]/analytics/route.ts
  - app/api/organisations/[slug]/analytics/export/route.ts
  - app/(authenticated)/organisations/[slug]/analytics/page.tsx
  - components/analytics-dashboard/index.tsx
  - components/analytics-dashboard/absence-rate-chart.tsx
  - components/analytics-dashboard/trend-chart.tsx
  - components/analytics-dashboard/bradford-table.tsx
  - components/analytics-dashboard/cohort-guard.tsx
  - actions/analytics.ts
autonomous: true

must_haves:
  truths:
    - "Organisation dashboard shows absence rates by team, department, and whole organisation"
    - "Trend reporting shows month-over-month absence patterns"
    - "Bradford Factor scores displayed per employee and aggregated by team"
    - "Analytics enforce minimum cohort size (5+ people) to prevent re-identification"
    - "Reports exportable as CSV and PDF"
  artifacts:
    - path: "providers/repositories/analytics.repository.ts"
      provides: "Aggregation SQL queries for absence rates, trends, and Bradford scores"
      exports: ["AnalyticsRepository"]
    - path: "providers/services/analytics.service.ts"
      provides: "Analytics business logic with cohort size enforcement"
      exports: ["AnalyticsService"]
    - path: "app/api/organisations/[slug]/analytics/route.ts"
      provides: "Analytics data API endpoint"
      exports: ["GET"]
    - path: "app/api/organisations/[slug]/analytics/export/route.ts"
      provides: "CSV and PDF export endpoint"
      exports: ["GET"]
    - path: "app/(authenticated)/organisations/[slug]/analytics/page.tsx"
      provides: "Analytics dashboard page"
    - path: "components/analytics-dashboard/cohort-guard.tsx"
      provides: "Minimum cohort size enforcement UI component"
  key_links:
    - from: "providers/services/analytics.service.ts"
      to: "providers/services/bradford-factor.service.ts"
      via: "BradfordFactorService.calculateForTeam for team Bradford aggregation"
      pattern: "BradfordFactorService\\.calculateForTeam"
    - from: "providers/services/analytics.service.ts"
      to: "providers/repositories/analytics.repository.ts"
      via: "Repository queries for absence rate and trend data"
      pattern: "AnalyticsRepository\\."
    - from: "components/analytics-dashboard/index.tsx"
      to: "actions/analytics.ts"
      via: "TanStack Query fetching analytics data"
      pattern: "fetchAnalytics|fetchAnalyticsExport"
---

<objective>
Build the analytics dashboard with absence rate reporting, trend analysis, Bradford Factor visibility, cohort privacy enforcement, and CSV/PDF export.

Purpose: HR and org admins need to understand absence patterns across their organisation to make data-driven decisions. The dashboard aggregates sickness data by team/department/org with month-over-month trends. Privacy is enforced by suppressing data for groups smaller than 5 people.

Output: Analytics repository with aggregation queries, analytics service with cohort enforcement, dashboard UI with charts and tables, CSV and PDF export functionality.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-monitoring-and-intelligence/03-01-SUMMARY.md
@providers/repositories/sickness-case.repository.ts
@providers/repositories/employee.repository.ts
@providers/services/bradford-factor.service.ts
@constants/bradford-factor.ts
@types/database.ts
@constants/permissions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analytics repository, service, and API routes with cohort enforcement</name>
  <files>
    providers/repositories/analytics.repository.ts
    providers/services/analytics.service.ts
    schemas/analytics.ts
    app/api/organisations/[slug]/analytics/route.ts
    app/api/organisations/[slug]/analytics/export/route.ts
    actions/analytics.ts
    constants/permissions.ts
  </files>
  <action>
    **constants/permissions.ts:** Add `VIEW_ANALYTICS: "view:analytics"` and `EXPORT_ANALYTICS: "export:analytics"`. VIEW_ANALYTICS granted to PLATFORM_ADMIN, ORG_ADMIN, HR. EXPORT_ANALYTICS granted to PLATFORM_ADMIN, ORG_ADMIN, HR. MANAGER gets VIEW_ANALYTICS (scoped to their team in service layer).

    **schemas/analytics.ts:** Zod schema for analytics query params: period (enum: '3m', '6m', '12m', default '12m'), departmentId (optional UUID string), groupBy (enum: 'team', 'department', 'organisation', default 'department').

    **providers/repositories/analytics.repository.ts:** Static class with:
    - `getAbsenceRates(organisationId, periodMonths, groupBy, client?)` -- SQL query joining sickness_cases with employees and departments. Groups by the specified dimension. Returns array of `{ groupId, groupName, employeeCount, absenceCount, totalDaysLost, absenceRate }` where absenceRate = (employees with at least 1 absence / total employees) * 100. Uses date filter: absence_start_date >= NOW() - interval '{periodMonths} months'.
    - `getMonthlyTrends(organisationId, periodMonths, client?)` -- SQL query that groups sickness cases by month (date_trunc('month', absence_start_date)). Returns array of `{ month (YYYY-MM), absenceCount, uniqueEmployees, totalDaysLost }`. Order by month ASC.
    - `getDepartmentEmployeeCounts(organisationId, client?)` -- Returns `{ departmentId, departmentName, employeeCount }` for cohort size checking.

    **providers/services/analytics.service.ts:** Static class with:
    - `getAnalytics(organisationId, params, userId, userRole, client?)` -- Orchestrates: calls AnalyticsRepository.getAbsenceRates, getMonthlyTrends, and BradfordFactorService.calculateForTeam. For MANAGER role, scope to their direct reports only (get employee IDs from EmployeeRepository recursive CTE, then filter results). **Cohort enforcement (ANAL-04):** Before returning any group's data, check if employeeCount >= 5. If < 5, replace the group's data with `{ suppressed: true, reason: 'Fewer than 5 employees' }`. The whole-organisation level is never suppressed.
    - `exportAnalytics(organisationId, format, params, client?)` -- Calls getAnalytics, then formats:
      - CSV: Use simple string concatenation (no library needed). Headers row + data rows. Escape commas in values. Set Content-Type: text/csv, Content-Disposition: attachment.
      - PDF: Generate a simple HTML table, then use the built-in approach of returning HTML with print-optimized CSS (media print styles). The client-side will use window.print() for PDF generation (no server-side PDF library needed -- keeps dependencies minimal). Return HTML string with `@media print` styles for clean output.
    - `MINIMUM_COHORT_SIZE = 5` as a constant.

    **app/api/organisations/[slug]/analytics/route.ts:**
    - GET: Query params: period, departmentId, groupBy. Requires VIEW_ANALYTICS permission. Validates params with AnalyticsQuerySchema. Returns { absenceRates, trends, bradfordScores, generatedAt }.

    **app/api/organisations/[slug]/analytics/export/route.ts:**
    - GET: Query params: format (csv|pdf), period, departmentId, groupBy. Requires EXPORT_ANALYTICS permission. For CSV: returns text/csv response. For PDF: returns text/html with print styles. Audit logs the export with AuditAction.EXPORT, AuditEntity.ANALYTICS (add ANALYTICS to AuditEntity enum in types/enums.ts).

    **actions/analytics.ts:** Client-side fetch wrappers: fetchAnalytics(slug, params?), exportAnalyticsCSV(slug, params?), exportAnalyticsPDF(slug, params?). CSV action triggers browser download. PDF action opens in new window for printing.
  </action>
  <verify>
    `npx tsc --noEmit` compiles cleanly. API route files export GET handlers. Analytics repository SQL is syntactically valid. Cohort size constant is 5. AuditEntity.ANALYTICS added to enums.
  </verify>
  <done>
    AnalyticsRepository provides absence rates by group, monthly trends, and department counts via parameterised SQL. AnalyticsService enforces minimum cohort size of 5 on all group-level data, scopes MANAGER view to direct reports. CSV export generates downloadable file. PDF export generates print-ready HTML. API routes enforce VIEW_ANALYTICS and EXPORT_ANALYTICS permissions. Export actions are audit-logged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Analytics dashboard UI with charts, Bradford table, and export buttons</name>
  <files>
    app/(authenticated)/organisations/[slug]/analytics/page.tsx
    components/analytics-dashboard/index.tsx
    components/analytics-dashboard/absence-rate-chart.tsx
    components/analytics-dashboard/trend-chart.tsx
    components/analytics-dashboard/bradford-table.tsx
    components/analytics-dashboard/cohort-guard.tsx
    components/sidebar/nav-items.ts
  </files>
  <action>
    **components/analytics-dashboard/cohort-guard.tsx:** Presentational component. Props: suppressed (boolean), reason (string), children. If suppressed, renders a muted card with a lock icon (lucide-react Lock) and the reason text ("Data suppressed: fewer than 5 employees in this group"). Otherwise renders children. Used to wrap any group-level data display.

    **components/analytics-dashboard/absence-rate-chart.tsx:** 'use client' component. Props: data (array of { groupName, employeeCount, absenceCount, absenceRate, suppressed? }). Renders a horizontal bar chart showing absence rate per group. Use simple Tailwind-based bar chart (colored div with width as percentage, no charting library). Each bar: group name label, bar fill (green < 5%, amber 5-10%, red > 10%), percentage label. Wrap each group in CohortGuard.

    **components/analytics-dashboard/trend-chart.tsx:** 'use client' component. Props: data (array of { month, absenceCount, uniqueEmployees, totalDaysLost }). Renders a simple line-style visualization using Tailwind. Show a table with monthly data: Month, New Absences, Unique Employees Absent, Days Lost. Add a visual sparkline-style row of bars (one per month, height proportional to absenceCount) above the table. Use CSS grid for the bar row.

    **components/analytics-dashboard/bradford-table.tsx:** 'use client' component. Props: data (array of { employeeId, firstName, lastName, departmentName, score, spells, totalDays, riskLevel }). Renders a sortable table (useState for sort column/direction, not TanStack Table -- simpler for this read-only view). Columns: Employee Name, Department, Bradford Score (with BradfordFactorBadge from 03-01), Spells, Days Lost. Default sort by score descending. Allow sort by score, spells, totalDays columns.

    **components/analytics-dashboard/index.tsx:** 'use client' component. The main dashboard layout. Props: slug (string). Uses TanStack Query with fetchAnalytics action. State: period selector (3m/6m/12m via select), groupBy selector (team/department/organisation), departmentId filter (select populated from data). Layout:
    - Top bar: Period selector, Group By selector, Department filter, Export CSV button, Export PDF button
    - Section 1: "Absence Rates" heading + AbsenceRateChart
    - Section 2: "Monthly Trends" heading + TrendChart
    - Section 3: "Bradford Factor Scores" heading + BradfordTable
    Export CSV button calls exportAnalyticsCSV action (triggers download). Export PDF button calls exportAnalyticsPDF action (opens print window).

    **app/(authenticated)/organisations/[slug]/analytics/page.tsx:** Server component wrapper. Renders AnalyticsDashboard with slug from params. Page title "Analytics" with description "Absence patterns and reporting".

    **components/sidebar/nav-items.ts:** Add "Analytics" nav item under the organisation section, visible to roles with VIEW_ANALYTICS permission. Icon: BarChart3 from lucide-react. Path: `/organisations/{slug}/analytics`. Position it after the Triggers nav item.
  </action>
  <verify>
    `npx tsc --noEmit` compiles. All component files exist and export named components. Nav item references correct path and permission. CohortGuard properly suppresses data for small groups.
  </verify>
  <done>
    Analytics dashboard page accessible at /organisations/{slug}/analytics. Shows absence rates as horizontal bar charts grouped by team/department/org. Monthly trend table with visual bar row. Bradford Factor scores in sortable table with risk-level badges. Cohort guard suppresses data for groups under 5 employees. Period and groupBy filters control data view. CSV and PDF export buttons functional. Analytics nav item visible in sidebar for authorised roles.
  </done>
</task>

</tasks>

<verification>
- Absence rates: With 10 employees in "Engineering" dept and 3 having absences, rate should show 30%
- Cohort enforcement: A department with 4 employees shows "Data suppressed" instead of absence rate data
- Trends: Monthly data shows correct counts when sickness cases span multiple months
- Bradford display: Scores sorted descending by default, risk level badges match threshold colors
- CSV export: Downloads a .csv file with headers and data rows, commas in values escaped
- PDF export: Opens print-friendly HTML in new window with clean table formatting
- MANAGER scoping: Manager only sees analytics for their direct reports, not entire org
</verification>

<success_criteria>
ANAL-01: Dashboard shows absence rates by team, department, and whole organisation with bar chart visualization
ANAL-02: Monthly trend data shows absence patterns over configurable 3/6/12 month periods
ANAL-03: Bradford Factor scores displayed per employee in sortable table with risk-level badges, aggregatable by team
ANAL-04: Groups with fewer than 5 employees show suppressed placeholder instead of real data
ANAL-05: Reports downloadable as CSV (direct download) and PDF (print-ready HTML)
</success_criteria>

<output>
After completion, create `.planning/phases/03-monitoring-and-intelligence/03-02-SUMMARY.md`
</output>
