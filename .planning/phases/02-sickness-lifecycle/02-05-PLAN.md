---
phase: 02-sickness-lifecycle
plan: 05
type: execute
wave: 4
depends_on: ["02-03", "02-04"]
files_modified:
  - providers/repositories/notification.repository.ts
  - providers/services/notification.service.ts
  - emails/layout.tsx
  - emails/sickness-reported.tsx
  - emails/fit-note-expiring.tsx
  - emails/rtw-meeting-scheduled.tsx
  - app/api/cron/fit-note-expiry/route.ts
  - app/(authenticated)/calendar/page.tsx
  - app/(authenticated)/dashboard/page.tsx
  - components/absence-calendar/index.tsx
  - components/sidebar/nav-items.ts
autonomous: true
user_setup:
  - service: sendgrid
    why: "Email delivery for notifications"
    env_vars:
      - name: SENDGRID_API_KEY
        source: "SendGrid Dashboard -> Settings -> API Keys -> Create API Key (Full Access)"
      - name: SENDGRID_FROM_EMAIL
        source: "Verified sender email in SendGrid (e.g. noreply@salusbridge.com)"
    dashboard_config:
      - task: "Verify sender identity"
        location: "SendGrid Dashboard -> Settings -> Sender Authentication"

must_haves:
  truths:
    - "Manager receives email notification when a direct report reports sick (without health details in content)"
    - "Manager/HR receives notification when a fit note is approaching expiry"
    - "Employee receives notification when a RTW meeting is scheduled for them"
    - "All notifications pass privacy validation before sending (no health details exposed)"
    - "Manager can view absence calendar showing team absences at a glance"
    - "Employee dashboard shows active absences summary"
  artifacts:
    - path: "providers/services/notification.service.ts"
      provides: "Email dispatch via SendGrid with privacy validation"
      exports: ["NotificationService"]
    - path: "emails/sickness-reported.tsx"
      provides: "Email template for sickness reported notification"
    - path: "emails/fit-note-expiring.tsx"
      provides: "Email template for fit note expiry alert"
    - path: "emails/rtw-meeting-scheduled.tsx"
      provides: "Email template for RTW meeting notification"
    - path: "app/(authenticated)/calendar/page.tsx"
      provides: "Absence calendar page for managers"
    - path: "components/absence-calendar/index.tsx"
      provides: "Month-view calendar grid showing team absences"
  key_links:
    - from: "providers/services/notification.service.ts"
      to: "constants/notification-privacy.ts"
      via: "Validates all notifications before dispatch"
      pattern: "validateNotificationPayload"
    - from: "app/api/cron/fit-note-expiry/route.ts"
      to: "providers/services/notification.service.ts"
      via: "Sends expiry alerts for fit notes expiring within threshold"
      pattern: "NotificationService\\.send"
    - from: "providers/services/notification.service.ts"
      to: "emails/"
      via: "Renders React Email templates to HTML"
      pattern: "render.*sickness-reported|fit-note-expiring|rtw-meeting-scheduled"
---

<objective>
Build notification system with email delivery, absence calendar, and dashboard integration.

Purpose: Deliver NOTF-01 through NOTF-04 (privacy-safe notifications at each workflow step), SICK-06 (absence calendar), and dashboard updates. Completes the Phase 2 feature set by connecting all workflow events to email notifications and providing the team visibility view.
Output: Notification service with SendGrid, React Email templates, cron integration, absence calendar component, and updated dashboard.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sickness-lifecycle/02-RESEARCH.md
@.planning/phases/02-sickness-lifecycle/02-02-SUMMARY.md
@.planning/phases/02-sickness-lifecycle/02-03-SUMMARY.md
@.planning/phases/02-sickness-lifecycle/02-04-SUMMARY.md

@providers/services/workflow.service.ts
@providers/services/sickness-case.service.ts
@constants/notification-privacy.ts
@constants/permissions.ts
@app/(authenticated)/dashboard/page.tsx
@components/sidebar/nav-items.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification service, email templates, and integrate with workflow</name>
  <files>
    providers/repositories/notification.repository.ts
    providers/services/notification.service.ts
    emails/layout.tsx
    emails/sickness-reported.tsx
    emails/fit-note-expiring.tsx
    emails/rtw-meeting-scheduled.tsx
  </files>
  <action>
    Install dependencies: `yarn add @sendgrid/mail @react-email/components` and `yarn add -D react-email`

    **notification.repository.ts:** Static class methods for an optional notifications log table. Create a simple log record (we can track what was sent without a full notifications table -- use audit_logs with AuditEntity.NOTIFICATION for now):
    - No new table needed. NotificationService logs sends via AuditLogService.

    Actually, skip the repository. Notifications are logged via AuditLogService with AuditEntity.NOTIFICATION. Delete this file from plan -- the service handles everything.

    **providers/services/notification.service.ts:** Email dispatch with privacy enforcement:
    - `send(params: { to, subject, html, organisationId, notificationType, recipientUserId })`:
      1. Call validateNotificationPayload({ subject, body: html }) from notification-privacy.ts
      2. If validation fails: throw Error with violation details (NEVER send invalid notification)
      3. Set sgMail API key from process.env.SENDGRID_API_KEY
      4. Call sgMail.send({ to, from: process.env.SENDGRID_FROM_EMAIL, subject, html })
      5. Log via AuditLogService with AuditAction.SEND, AuditEntity.NOTIFICATION, metadata: { notificationType, recipientEmail: to }
      6. If SENDGRID_API_KEY is not set: log warning and skip send (don't crash in dev)

    - `notifySicknessReported(sicknessCase, manager, organisationName)` (NOTF-01):
      1. Render SicknessReportedEmail template to HTML (using React Email render())
      2. Subject: "Action required: A team member has reported an absence" (NO employee name, NO condition)
      3. Body includes: organisation name, date reported, link to case (authenticated URL, no health details)
      4. Call this.send() to manager's email

    - `notifyFitNoteExpiring(fitNote, recipients: { email, userId }[], organisationName)` (NOTF-02):
      1. Render FitNoteExpiringEmail template
      2. Subject: "Reminder: Action needed - document expiring soon"
      3. Body: organisation name, expiry date, link to case
      4. Send to each recipient (manager + HR contacts)

    - `notifyRtwScheduled(meeting, employee, organisationName)` (NOTF-03):
      1. Render RtwMeetingScheduledEmail template
      2. Subject: "Update: A meeting has been scheduled"
      3. Body: organisation name, scheduled date/time, link to case
      4. Send to employee's email

    **emails/layout.tsx:** Shared email layout using React Email components:
    - Html, Head, Body, Container, Section, Text, Link, Hr
    - SalusBridge branding: logo placeholder, footer with "This is an automated message from SalusBridge"
    - Responsive design, clean typography

    **emails/sickness-reported.tsx:** Template for NOTF-01:
    - Props: { organisationName, dateReported, caseUrl }
    - Heading: "A team member has reported an absence"
    - Body: brief, no health details. "A member of your team has reported that they are unable to work. Please review the details and consider reaching out."
    - CTA button: "View in SalusBridge" linking to caseUrl
    - MUST NOT include: employee name, absence type, diagnosis, condition

    **emails/fit-note-expiring.tsx:** Template for NOTF-02:
    - Props: { organisationName, expiryDate, caseUrl }
    - Heading: "A document is expiring soon"
    - Body: "A document related to an ongoing case requires attention before {expiryDate}."
    - CTA: "Review in SalusBridge"

    **emails/rtw-meeting-scheduled.tsx:** Template for NOTF-03:
    - Props: { organisationName, scheduledDate, caseUrl }
    - Heading: "A meeting has been scheduled"
    - Body: "A return-to-work meeting has been scheduled for {scheduledDate}. Please review the details."
    - CTA: "View Details"

    **Integration with WorkflowService:** Update workflow.service.ts to dispatch notifications AFTER successful transitions:
    - REPORTED → TRACKING (acknowledge): Send notifySicknessReported to manager (if reporter is employee)
    - Actually, notifications should fire when case is CREATED (sickness reported), not on acknowledge. Update SicknessCaseService.create to call NotificationService.notifySicknessReported after case creation if the reporter is the employee (send to their manager).
    - SCHEDULE_RTW transition: Call NotificationService.notifyRtwScheduled to the employee.
    - Fit note expiry: Handled by cron endpoint (see Task 2).

    Notifications are fire-and-forget (wrapped in try/catch). A failed notification must NOT roll back the workflow transition.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify all email templates import from @react-email/components. Verify NotificationService.send calls validateNotificationPayload before sgMail.send. Verify templates do NOT contain employee names or health details.</verify>
  <done>Notification service sends privacy-validated emails via SendGrid. Three email templates created with generic, safe language. Sickness reporting triggers manager notification. RTW scheduling triggers employee notification. Failed notifications don't break workflows.</done>
</task>

<task type="auto">
  <name>Task 2: Update fit note expiry cron and create absence calendar</name>
  <files>
    app/api/cron/fit-note-expiry/route.ts
    app/(authenticated)/calendar/page.tsx
    components/absence-calendar/index.tsx
    app/(authenticated)/dashboard/page.tsx
    components/sidebar/nav-items.ts
    actions/sickness-cases.ts
  </files>
  <action>
    **Update app/api/cron/fit-note-expiry/route.ts** (created in 02-03 as stub):
    - Now integrates with NotificationService
    - For each expiring fit note found:
      1. Find the case manager (via employee.manager_id → user email)
      2. Find HR users for the organisation
      3. Call NotificationService.notifyFitNoteExpiring to manager and HR recipients
    - Return { processed: N, notificationsSent: M }

    **components/absence-calendar/index.tsx:** 'use client' component (SICK-06).
    - Props: { absences: { employeeName: string; startDate: string; endDate?: string; status: string; absenceType: string; caseId: string }[]; month: number; year: number }
    - Build a CSS grid month calendar (7 columns for days of week)
    - Each day cell shows coloured bars for active absences (horizontal bar spanning the absence duration)
    - Colour coding by status: REPORTED (amber), TRACKING (blue), FIT_NOTE_RECEIVED (purple), RTW_SCHEDULED (teal), CLOSED (grey)
    - Click on an absence bar → navigate to case detail
    - Month navigation: prev/next buttons updating month/year state
    - Legend showing status colours
    - For privacy: show employee first name + initial only (not full name) in calendar bars
    - Mobile: list view fallback showing absences grouped by date
    - No heavy calendar library -- build with Tailwind grid. Use date-fns for month iteration (getDaysInMonth, startOfMonth, getDay).

    **app/(authenticated)/calendar/page.tsx:** Server component.
    - Requires VIEW_ABSENCE_CALENDAR permission (MANAGER, HR, ORG_ADMIN)
    - Accept query params: month, year (default to current)
    - Fetch active sickness cases for the month range:
      - If MANAGER: only their team's absences
      - If HR/ORG_ADMIN: all org absences
    - Transform cases into absence calendar data shape
    - Render AbsenceCalendar component

    **actions/sickness-cases.ts:** Add:
    - `fetchAbsenceCalendar(month, year)`: GET /api/sickness-cases with date range filter (add support for startDateFrom/startDateTo query params to the existing GET endpoint)

    **Update GET /api/sickness-cases** (in existing route from 02-02): Add query param support for date filtering: startDateFrom, startDateTo. These filter absences that overlap with the specified month (absence_start_date <= endOfMonth AND (absence_end_date >= startOfMonth OR absence_end_date IS NULL)).

    **Update app/(authenticated)/dashboard/page.tsx:**
    - For EMPLOYEE role: add "Active Absences" card showing count of open sickness cases and link to history
    - For MANAGER role: add "Team Absences" card showing count of active team absences and link to calendar
    - For HR/ORG_ADMIN: add "Organisation Absences" summary card with active count and link to calendar
    - Fetch counts via existing sickness case API with status filter

    **Update components/sidebar/nav-items.ts:**
    - Add "Absence Calendar" → /calendar (visible to MANAGER, HR, ORG_ADMIN) with Calendar icon from lucide-react
  </action>
  <verify>Run `npx tsc --noEmit`. Navigate to /calendar and verify month grid renders. Verify absence bars span correct dates. Verify dashboard cards show absence counts. Verify cron endpoint sends notifications for expiring fit notes.</verify>
  <done>Fit note expiry cron sends notifications to manager and HR. Absence calendar shows month grid with colour-coded absence bars. Dashboard updated with absence summary cards per role. Calendar navigation works. Sidebar link added.</done>
</task>

</tasks>

<verification>
- Create a sickness case → manager receives email notification (no health details in email)
- Schedule RTW meeting → employee receives email notification
- Fit note approaching expiry → cron sends alert to manager and HR
- All notification subjects/bodies pass validateNotificationPayload
- Absence calendar shows team absences with correct date spans
- Dashboard shows absence count cards appropriate to user role
- Calendar accessible to managers, HR, org admins only
</verification>

<success_criteria>
- NotificationService validates all content against notification-privacy.ts before sending
- Three email templates render clean HTML with no health details
- Cron endpoint processes expiring fit notes and dispatches notifications
- Absence calendar renders month grid with coloured absence bars
- Dashboard cards show active absence counts per role
- Sidebar has Absence Calendar link for managers/HR/admins
- SENDGRID_API_KEY absence gracefully handled (warn + skip, don't crash)
</success_criteria>

<output>
After completion, create `.planning/phases/02-sickness-lifecycle/02-05-SUMMARY.md`
</output>
