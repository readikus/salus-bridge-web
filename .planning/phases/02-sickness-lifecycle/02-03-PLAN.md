---
phase: 02-sickness-lifecycle
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - providers/repositories/fit-note.repository.ts
  - providers/services/fit-note.service.ts
  - providers/services/storage.service.ts
  - app/api/sickness-cases/[id]/fit-notes/route.ts
  - app/api/sickness-cases/[id]/fit-notes/[fitNoteId]/download/route.ts
  - app/api/cron/fit-note-expiry/route.ts
  - app/(authenticated)/sickness/[id]/fit-notes/page.tsx
  - components/fit-note-upload/index.tsx
  - components/fit-note-list/index.tsx
  - actions/fit-notes.ts
  - schemas/fit-note.ts
autonomous: true
user_setup:
  - service: supabase-storage
    why: "Secure document storage for fit note PDFs/images"
    dashboard_config:
      - task: "Create private bucket named 'fit-notes' in Supabase Storage"
        location: "Supabase Dashboard -> Storage -> New bucket -> Name: fit-notes, Public: OFF"

must_haves:
  truths:
    - "Employee or HR user can upload a fit note document (PDF/image) linked to a sickness case"
    - "Fit note metadata is captured: status (not fit / may be fit), duration dates, functional effects"
    - "Fit note documents are accessible only via short-lived signed URLs to authorised roles (HR, employee -- not managers)"
    - "System tracks fit note expiry and a cron endpoint identifies notes expiring within 3 days"
    - "Uploading a fit note transitions the sickness case to FIT_NOTE_RECEIVED state"
  artifacts:
    - path: "providers/services/storage.service.ts"
      provides: "Supabase Storage upload and signed URL generation"
      exports: ["StorageService"]
    - path: "providers/services/fit-note.service.ts"
      provides: "Fit note business logic with access control"
      exports: ["FitNoteService"]
    - path: "app/api/sickness-cases/[id]/fit-notes/route.ts"
      provides: "Fit note list and upload endpoints"
      exports: ["GET", "POST"]
    - path: "app/api/cron/fit-note-expiry/route.ts"
      provides: "Cron endpoint for expiry checking"
      exports: ["GET"]
  key_links:
    - from: "providers/services/fit-note.service.ts"
      to: "providers/services/workflow.service.ts"
      via: "Triggers RECEIVE_FIT_NOTE transition after upload"
      pattern: "WorkflowService\\.transition.*RECEIVE_FIT_NOTE"
    - from: "providers/services/storage.service.ts"
      to: "providers/supabase/client.ts"
      via: "Uses Supabase server client for storage operations"
      pattern: "createServerClient"
    - from: "app/api/sickness-cases/[id]/fit-notes/[fitNoteId]/download/route.ts"
      to: "providers/services/storage.service.ts"
      via: "Generates signed URL for authorised download"
      pattern: "StorageService\\.getSignedUrl"
---

<objective>
Build fit note upload, secure storage, access control, and expiry tracking.

Purpose: Deliver FIT-01 through FIT-04 -- the complete fit note management feature. Fit notes are uploaded to Supabase Storage (private bucket), metadata captured in PostgreSQL, documents accessible only via short-lived signed URLs to authorised roles, and expiry tracked with a cron endpoint.
Output: Storage service, fit note service/repository, API routes, upload UI, download endpoint, and expiry cron.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sickness-lifecycle/02-RESEARCH.md
@.planning/phases/02-sickness-lifecycle/02-02-SUMMARY.md

@providers/services/workflow.service.ts
@providers/services/encryption.service.ts
@providers/services/audit-log.service.ts
@providers/services/tenant.service.ts
@providers/supabase/client.ts
@schemas/fit-note.ts
@constants/sickness-states.ts
@constants/permissions.ts
@constants/notification-privacy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage service, fit note repository and service</name>
  <files>
    providers/services/storage.service.ts
    providers/repositories/fit-note.repository.ts
    providers/services/fit-note.service.ts
  </files>
  <action>
    **storage.service.ts:** Supabase Storage wrapper as shown in 02-RESEARCH.md:
    - `upload(organisationId, caseId, fileName, fileBuffer, contentType)`: Upload to private 'fit-notes' bucket with path `{organisationId}/{caseId}/{Date.now()}-{fileName}`. Validate content type is PDF or image (application/pdf, image/jpeg, image/png). Validate file size <= 10MB. Return storage path string.
    - `getSignedUrl(storagePath)`: Generate signed URL with 5-minute (300 second) expiry. Return signed URL string.
    - `delete(storagePath)`: Remove file from storage. Used for cleanup.
    - Import createServerClient from `@/providers/supabase/client`.
    - BUCKET_NAME = "fit-notes", SIGNED_URL_EXPIRY_SECONDS = 300, MAX_FILE_SIZE_BYTES = 10 * 1024 * 1024.

    **fit-note.repository.ts:** Static class methods:
    - `create(data, client?)`: INSERT into fit_notes RETURNING * with camelCase aliases.
    - `findById(id, client?)`: SELECT by id.
    - `findByCaseId(caseId)`: SELECT WHERE sickness_case_id = $1 ORDER BY created_at DESC.
    - `findExpiringWithinDays(days: number)`: SELECT WHERE end_date IS NOT NULL AND end_date BETWEEN CURRENT_DATE AND CURRENT_DATE + interval '$1 days'. JOIN employees and sickness_cases to get employee name and organisation_id. Return array with case, employee, and org context.

    **fit-note.service.ts:** Business logic with access control:
    - `upload(caseId, file: { buffer, name, contentType, size }, metadata: FitNoteSchema, userId, organisationId)`:
      1. Validate content type and size
      2. Call StorageService.upload to store file
      3. Encrypt notes if provided (EncryptionService)
      4. Create fit_notes record via repository within TenantService.withTenant
      5. Trigger WorkflowService.transition(caseId, SicknessAction.RECEIVE_FIT_NOTE, userId, organisationId) -- this moves case to FIT_NOTE_RECEIVED state
      6. Log audit with AuditAction.UPLOAD, AuditEntity.FIT_NOTE
      7. Return created fit note record
    - `getForCase(caseId, userId, organisationId, userRoles)`:
      - FIT-04 enforcement: Check that user is EMPLOYEE (own case only), HR, or ORG_ADMIN. MANAGERS CANNOT access fit notes.
      - If user is employee: verify the case belongs to them
      - Return fit notes (metadata only, no signed URLs)
    - `getSignedDownloadUrl(fitNoteId, userId, organisationId, userRoles)`:
      - Same role check as getForCase (NO manager access)
      - Fetch fit note, generate signed URL via StorageService
      - Log audit with AuditAction.DOWNLOAD, AuditEntity.FIT_NOTE
      - Return signed URL
    - `getExpiringFitNotes(days: number)`: Delegate to repository. Used by cron.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify FitNoteService.upload calls both StorageService.upload and WorkflowService.transition. Verify getForCase rejects MANAGER role.</verify>
  <done>Storage service handles upload/download/delete with file validation. Fit note service enforces FIT-04 role restrictions (no manager access to documents). Upload triggers state transition to FIT_NOTE_RECEIVED. Audit logged for all operations.</done>
</task>

<task type="auto">
  <name>Task 2: Create fit note API routes, cron endpoint, and actions</name>
  <files>
    app/api/sickness-cases/[id]/fit-notes/route.ts
    app/api/sickness-cases/[id]/fit-notes/[fitNoteId]/download/route.ts
    app/api/cron/fit-note-expiry/route.ts
    actions/fit-notes.ts
  </files>
  <action>
    **GET /api/sickness-cases/[id]/fit-notes:**
    - Requires VIEW_FIT_NOTES permission
    - Validate user has access to this case
    - Call FitNoteService.getForCase (which enforces FIT-04 -- rejects managers)
    - Return fit note metadata (NOT signed URLs -- those are on-demand)
    - Return 403 if manager tries to access

    **POST /api/sickness-cases/[id]/fit-notes:**
    - Requires UPLOAD_FIT_NOTES permission (HR, ORG_ADMIN) OR is the employee who owns the case
    - Parse multipart form data: file (the document) + metadata fields (fitNoteStatus, startDate, endDate, functionalEffects, notes)
    - Validate metadata with FitNoteSchema
    - Read file from FormData as Buffer
    - Call FitNoteService.upload
    - Return 201 with created fit note

    **GET /api/sickness-cases/[id]/fit-notes/[fitNoteId]/download:**
    - Requires VIEW_FIT_NOTES permission
    - Call FitNoteService.getSignedDownloadUrl (enforces role check)
    - Return { signedUrl } with 5-minute expiry
    - Return 403 for managers

    **GET /api/cron/fit-note-expiry:**
    - FIT-03: Check for fit notes expiring within configurable days (default 3, read from org settings absenceTriggerThresholds if available)
    - Protected by a CRON_SECRET environment variable (check Authorization header)
    - Call FitNoteService.getExpiringFitNotes(3)
    - For each expiring note: log the finding (do NOT send notifications yet -- that's plan 02-05)
    - Return { expiringCount, notes: [...] } for monitoring
    - This is designed to be called by Vercel Cron Jobs or external cron

    **actions/fit-notes.ts:**
    - `fetchFitNotes(caseId)`: GET /api/sickness-cases/[caseId]/fit-notes
    - `fetchUploadFitNote(caseId, formData)`: POST /api/sickness-cases/[caseId]/fit-notes (send as FormData, not JSON)
    - `fetchFitNoteDownloadUrl(caseId, fitNoteId)`: GET /api/sickness-cases/[caseId]/fit-notes/[fitNoteId]/download
  </action>
  <verify>Run `npx tsc --noEmit`. Test upload with curl using multipart form data. Verify 403 returned for manager access. Verify cron endpoint returns expiring notes.</verify>
  <done>Fit note upload accepts PDF/images via multipart form. Download returns signed URL with 5-min expiry. Manager access blocked with 403. Cron endpoint identifies expiring fit notes. All audit logged.</done>
</task>

<task type="auto">
  <name>Task 3: Create fit note upload and list UI</name>
  <files>
    components/fit-note-upload/index.tsx
    components/fit-note-list/index.tsx
    app/(authenticated)/sickness/[id]/fit-notes/page.tsx
  </files>
  <action>
    **components/fit-note-upload/index.tsx:** 'use client' component.
    - Props: { caseId: string; onUploadComplete: () => void }
    - File input accepting PDF and images (accept=".pdf,.jpg,.jpeg,.png")
    - Drag-and-drop zone (reuse pattern from CSV import wizard)
    - Form fields (React Hook Form + zodResolver with FitNoteSchema):
      - Fit note status: radio buttons for "Not fit for work" / "May be fit for work"
      - Start date (type="date")
      - End date / expiry date (type="date", optional)
      - Functional effects: checkboxes for PHASED_RETURN, ALTERED_HOURS, AMENDED_DUTIES, ADAPTED_WORKPLACE (only visible when status is MAY_BE_FIT)
      - Notes textarea (optional)
    - On submit: build FormData with file + metadata fields, call fetchUploadFitNote
    - Show upload progress indicator (isLoading)
    - On success: call onUploadComplete callback, show success toast
    - File validation: max 10MB, PDF or image only. Show inline error for invalid files.

    **components/fit-note-list/index.tsx:** 'use client' component.
    - Props: { fitNotes: FitNote[]; caseId: string }
    - Render list/cards for each fit note showing: file name, upload date, fit note status badge, start/end dates, functional effects tags, expiry warning if end_date within 3 days
    - Each fit note has a "Download" button that calls fetchFitNoteDownloadUrl then opens the signed URL in a new tab
    - Expiry badge: green (>7 days), amber (3-7 days), red (<3 days or expired)
    - If no fit notes: show empty state message

    **app/(authenticated)/sickness/[id]/fit-notes/page.tsx:** Server component.
    - Verify user has VIEW_FIT_NOTES access and is NOT a manager (redirect managers to case detail instead)
    - Fetch fit notes for the case via server-side call
    - Render FitNoteList + FitNoteUpload components
    - Title: "Fit Notes" with breadcrumb back to case detail
    - Show upload form only if user has UPLOAD_FIT_NOTES permission or is the case employee
  </action>
  <verify>Run `npx tsc --noEmit`. Navigate to /sickness/[id]/fit-notes and verify upload form renders. Upload a test file and verify it creates a fit note record. Verify download button opens signed URL. Verify managers cannot access this page.</verify>
  <done>Fit note upload form accepts PDF/images with metadata. Fit note list shows all notes with expiry badges and download buttons. Manager access blocked. Upload triggers case state transition.</done>
</task>

</tasks>

<verification>
- Upload a PDF â†’ fit_notes record created, file in Supabase Storage
- Download returns signed URL that expires after 5 minutes
- Manager receives 403 when accessing fit notes
- Employee can upload and view their own fit notes
- HR can upload and view all fit notes in org
- Upload triggers case transition to FIT_NOTE_RECEIVED
- Cron endpoint returns fit notes expiring within 3 days
- Expiry badges show correct colour coding
</verification>

<success_criteria>
- POST /api/sickness-cases/[id]/fit-notes accepts multipart upload
- GET .../download returns signed URL with 300s expiry
- Role check blocks managers from fit note access (403)
- Fit note upload triggers WorkflowService.transition(RECEIVE_FIT_NOTE)
- Cron endpoint at /api/cron/fit-note-expiry identifies expiring notes
- UI shows upload form, fit note cards, download buttons, and expiry warnings
</success_criteria>

<output>
After completion, create `.planning/phases/02-sickness-lifecycle/02-03-SUMMARY.md`
</output>
