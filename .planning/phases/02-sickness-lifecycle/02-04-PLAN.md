---
phase: 02-sickness-lifecycle
plan: 04
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - providers/repositories/rtw-meeting.repository.ts
  - providers/repositories/guidance.repository.ts
  - providers/services/rtw-meeting.service.ts
  - providers/services/guidance.service.ts
  - constants/guidance-content.ts
  - app/api/sickness-cases/[id]/rtw-meeting/route.ts
  - app/api/guidance/[caseId]/route.ts
  - app/(authenticated)/sickness/[id]/rtw/page.tsx
  - components/rtw-meeting-form/index.tsx
  - components/rtw-questionnaire/index.tsx
  - components/guidance-panel/index.tsx
  - actions/rtw-meetings.ts
  - actions/guidance.ts
autonomous: true

must_haves:
  truths:
    - "Manager or HR can schedule a return-to-work meeting linked to a sickness case"
    - "RTW meeting form provides a structured questionnaire for the meeting"
    - "RTW outcomes and agreed workplace adjustments are recorded and stored"
    - "Completing an RTW meeting transitions the case to RTW_COMPLETED (and can then be closed)"
    - "Manager receives scripted, empathetic conversation guidance appropriate to the absence scenario"
    - "Guidance is presented as step-by-step prompts with dos and don'ts"
    - "System tracks which guidance steps a manager has engaged with"
  artifacts:
    - path: "providers/services/rtw-meeting.service.ts"
      provides: "RTW meeting scheduling, completion, and questionnaire handling"
      exports: ["RtwMeetingService"]
    - path: "providers/services/guidance.service.ts"
      provides: "Manager guidance retrieval and engagement tracking"
      exports: ["GuidanceService"]
    - path: "constants/guidance-content.ts"
      provides: "Scripted guidance for initial contact, check-in, and RTW meeting scenarios"
      exports: ["GUIDANCE_SCRIPTS", "GuidanceScript", "GuidanceStep"]
    - path: "app/api/sickness-cases/[id]/rtw-meeting/route.ts"
      provides: "RTW meeting CRUD endpoints"
      exports: ["GET", "POST", "PATCH"]
    - path: "components/guidance-panel/index.tsx"
      provides: "Step-by-step guidance display for managers"
  key_links:
    - from: "providers/services/rtw-meeting.service.ts"
      to: "providers/services/workflow.service.ts"
      via: "Scheduling triggers SCHEDULE_RTW, completion triggers COMPLETE_RTW"
      pattern: "WorkflowService\\.transition"
    - from: "providers/services/guidance.service.ts"
      to: "constants/guidance-content.ts"
      via: "Loads guidance scripts by type and absence category"
      pattern: "GUIDANCE_SCRIPTS"
    - from: "components/guidance-panel/index.tsx"
      to: "actions/guidance.ts"
      via: "Tracks engagement and fetches guidance"
      pattern: "fetchGuidance|fetchTrackEngagement"
---

<objective>
Build return-to-work meeting workflow and manager conversation guidance system.

Purpose: Deliver RTW-01 through RTW-04 (scheduling, questionnaire, outcomes, case closure) and GUID-01 through GUID-04 (scripted guidance, step-by-step prompts, engagement tracking). This completes the manager-facing workflow support.
Output: RTW meeting service, guidance service with scripted content, API routes, RTW form with questionnaire, and guidance panel component.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sickness-lifecycle/02-RESEARCH.md
@.planning/phases/02-sickness-lifecycle/02-02-SUMMARY.md

@providers/services/workflow.service.ts
@providers/services/encryption.service.ts
@providers/services/audit-log.service.ts
@providers/services/tenant.service.ts
@constants/sickness-states.ts
@constants/absence-types.ts
@schemas/rtw-meeting.ts
@types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RTW meeting and guidance repositories, services, and guidance content</name>
  <files>
    providers/repositories/rtw-meeting.repository.ts
    providers/repositories/guidance.repository.ts
    providers/services/rtw-meeting.service.ts
    providers/services/guidance.service.ts
    constants/guidance-content.ts
  </files>
  <action>
    **rtw-meeting.repository.ts:** Static class methods:
    - `create(data, client?)`: INSERT into rtw_meetings RETURNING * with camelCase aliases. Fields: organisationId, sicknessCaseId, employeeId, scheduledBy, scheduledDate, status (default SCHEDULED).
    - `findById(id, client?)`: SELECT by id.
    - `findByCaseId(caseId)`: SELECT WHERE sickness_case_id = $1. Typically one meeting per case but allow multiple.
    - `update(id, data, client?)`: UPDATE with dynamic fields (completedDate, status, questionnaireResponses, outcomesEncrypted, adjustments). RETURNING *.

    **guidance.repository.ts:** Static class methods:
    - `createEngagement(data, client?)`: INSERT into guidance_engagement. Fields: organisationId, sicknessCaseId, userId, guidanceType, guidanceStep.
    - `findEngagementByCaseAndUser(caseId, userId)`: SELECT engaged guidance steps for a specific manager on a specific case.
    - `findEngagementByCase(caseId)`: SELECT all engagement records for a case.

    **rtw-meeting.service.ts:**
    - `schedule(caseId, scheduledDate, userId, organisationId)`:
      1. Verify case exists and is in a state that allows SCHEDULE_RTW (TRACKING, FIT_NOTE_RECEIVED)
      2. Create rtw_meetings record within TenantService.withTenant
      3. Trigger WorkflowService.transition(caseId, SCHEDULE_RTW, userId, organisationId)
      4. Log audit with AuditAction.SCHEDULE, AuditEntity.RTW_MEETING
      5. Return meeting record
    - `complete(meetingId, data: { questionnaireResponses, outcomes, adjustments }, userId, organisationId)`:
      1. Fetch meeting, verify it's SCHEDULED status
      2. Encrypt outcomes (EncryptionService)
      3. Update meeting: status = COMPLETED, completedDate = now(), questionnaireResponses, outcomesEncrypted, adjustments
      4. Trigger WorkflowService.transition(caseId, COMPLETE_RTW, userId, organisationId)
      5. Log audit
      6. Return updated meeting
    - `cancel(meetingId, userId, organisationId)`: Update status to CANCELLED. Does NOT trigger state transition (case stays in current state).
    - `getForCase(caseId, organisationId)`: Fetch meetings for a case.

    **guidance.service.ts:**
    - `getGuidanceForCase(caseId, organisationId, userId)`:
      1. Fetch the sickness case to determine absence type and current state
      2. Determine guidance type based on state: REPORTED/TRACKING → 'initial_contact', FIT_NOTE_RECEIVED → 'check_in', RTW_SCHEDULED/RTW_COMPLETED → 'rtw_meeting'
      3. Find matching GuidanceScript from GUIDANCE_SCRIPTS (match by type and absenceType, fall back to 'general')
      4. Fetch engagement records for this user+case to mark which steps are completed
      5. Return { script, engagedSteps: string[] }
    - `trackEngagement(caseId, userId, organisationId, guidanceType, guidanceStep)`:
      1. Create engagement record via repository
      2. Log audit with AuditAction.VIEW, AuditEntity.GUIDANCE

    **constants/guidance-content.ts:** Create the full guidance content structure. Export GuidanceStep and GuidanceScript interfaces plus GUIDANCE_SCRIPTS array.

    Create guidance scripts for ALL combinations of type x absenceType:
    - **initial_contact** (3 types): mental_health, musculoskeletal, general (covers respiratory, surgical, other)
    - **check_in** (1 type): general (applies to all)
    - **rtw_meeting** (1 type): general

    Each script has 3-5 steps. Each step has: id, title, prompt (what to say), rationale (why), doList (3-4 items), dontList (3-4 items).

    Content must be empathetic, action-oriented, compliant with UK employment best practice (GUID-03). Key themes:
    - Psychological safety: no pressure to disclose diagnosis
    - Supportive tone: "we" language, focus on support not absence policing
    - Practical: specific actions, not vague advice
    - Compliant: do not ask for medical details, do not suggest return dates, do not share with team

    Total: ~5 scripts x ~4 steps = ~20 guidance steps. This is a content-heavy file (~200-300 lines).
  </action>
  <verify>Run `npx tsc --noEmit`. Verify GUIDANCE_SCRIPTS covers initial_contact (mental_health, musculoskeletal, general), check_in (general), rtw_meeting (general). Verify each step has all required fields. Verify RtwMeetingService.schedule triggers SCHEDULE_RTW transition.</verify>
  <done>RTW meeting service handles scheduling, completion, and cancellation with state machine integration. Guidance service retrieves context-appropriate scripts and tracks engagement. 5 guidance scripts with ~20 total steps of empathetic, UK-compliant content.</done>
</task>

<task type="auto">
  <name>Task 2: Create RTW and guidance API routes with client actions</name>
  <files>
    app/api/sickness-cases/[id]/rtw-meeting/route.ts
    app/api/guidance/[caseId]/route.ts
    actions/rtw-meetings.ts
    actions/guidance.ts
  </files>
  <action>
    **GET /api/sickness-cases/[id]/rtw-meeting:**
    - Requires SCHEDULE_RTW or COMPLETE_RTW permission
    - Fetch meetings for this case
    - Return { meetings }

    **POST /api/sickness-cases/[id]/rtw-meeting:**
    - Requires SCHEDULE_RTW permission (MANAGER, HR, ORG_ADMIN)
    - Parse body with RtwMeetingSchema: { scheduledDate }
    - Call RtwMeetingService.schedule
    - Return 201 with meeting

    **PATCH /api/sickness-cases/[id]/rtw-meeting:**
    - Requires COMPLETE_RTW permission
    - Parse body: { meetingId, questionnaireResponses?, outcomes?, adjustments?, action: 'complete' | 'cancel' }
    - If action = 'complete': call RtwMeetingService.complete
    - If action = 'cancel': call RtwMeetingService.cancel
    - Return updated meeting

    **GET /api/guidance/[caseId]:**
    - Requires VIEW_GUIDANCE permission (MANAGER, HR, ORG_ADMIN)
    - Call GuidanceService.getGuidanceForCase
    - Return { script, engagedSteps }

    **POST /api/guidance/[caseId]:** (engagement tracking)
    - Requires VIEW_GUIDANCE permission
    - Parse body: { guidanceType, guidanceStep }
    - Call GuidanceService.trackEngagement
    - Return 200

    **actions/rtw-meetings.ts:**
    - `fetchRtwMeetings(caseId)`: GET
    - `fetchScheduleRtwMeeting(caseId, scheduledDate)`: POST
    - `fetchCompleteRtwMeeting(caseId, meetingId, data)`: PATCH with action 'complete'
    - `fetchCancelRtwMeeting(caseId, meetingId)`: PATCH with action 'cancel'

    **actions/guidance.ts:**
    - `fetchGuidance(caseId)`: GET /api/guidance/[caseId]
    - `fetchTrackEngagement(caseId, guidanceType, guidanceStep)`: POST /api/guidance/[caseId]
  </action>
  <verify>Run `npx tsc --noEmit`. Test: POST schedule meeting → case transitions to RTW_SCHEDULED. PATCH complete meeting → case transitions to RTW_COMPLETED. GET guidance returns script with engaged steps.</verify>
  <done>RTW meeting API supports scheduling, completing, and cancelling meetings. Guidance API returns context-appropriate scripts and tracks engagement. All state transitions validated. Client actions provide typed wrappers.</done>
</task>

<task type="auto">
  <name>Task 3: Create RTW meeting form, questionnaire, and guidance panel UI</name>
  <files>
    components/rtw-meeting-form/index.tsx
    components/rtw-questionnaire/index.tsx
    components/guidance-panel/index.tsx
    app/(authenticated)/sickness/[id]/rtw/page.tsx
  </files>
  <action>
    **components/rtw-meeting-form/index.tsx:** 'use client' component.
    - Props: { caseId: string; existingMeeting?: RtwMeeting; canComplete: boolean }
    - If no existing meeting: show scheduling form with date/time picker (input type="datetime-local"), submit calls fetchScheduleRtwMeeting
    - If meeting exists and status SCHEDULED: show meeting details with "Start Meeting" button that navigates to questionnaire, and "Cancel" button
    - If meeting COMPLETED: show read-only summary of outcomes and adjustments
    - Loading/error states per convention

    **components/rtw-questionnaire/index.tsx:** 'use client' component.
    - Props: { caseId: string; meetingId: string; onComplete: () => void }
    - Structured questionnaire with sections (RTW-02):
      1. "How are you feeling about returning?" - textarea
      2. "Is there anything we should be aware of to support your return?" - textarea
      3. "Do you have any concerns about your workload or duties?" - textarea
      4. "Would any of these adjustments help?" - checkboxes for each FunctionalEffect plus free text
      5. "Is there anything else you'd like to discuss?" - textarea
    - Meeting outcomes section: textarea for manager to summarise key points
    - Agreed adjustments: dynamic list builder (type dropdown from FunctionalEffect, description text, optional review date)
    - Submit button calls fetchCompleteRtwMeeting with all data
    - On completion: call onComplete, show success message, redirect to case detail

    **components/guidance-panel/index.tsx:** 'use client' component.
    - Props: { caseId: string }
    - Fetches guidance on mount via fetchGuidance
    - Displays as an expandable sidebar panel or accordion
    - Shows script title and type badge (Initial Contact, Check-in, RTW Meeting)
    - Each step rendered as an expandable card:
      - Step title and number
      - "What to say" section with the prompt text in a styled quote block
      - "Why this matters" section (collapsed by default)
      - Do/Don't lists with green check / red X icons (lucide-react Check, X)
      - "Mark as reviewed" checkbox button
    - When user expands a step or clicks "Mark as reviewed": call fetchTrackEngagement
    - Previously engaged steps show a checkmark badge
    - Overall progress indicator: "3 of 5 steps reviewed"

    **app/(authenticated)/sickness/[id]/rtw/page.tsx:** Server component.
    - Verify user has SCHEDULE_RTW or COMPLETE_RTW permission
    - Fetch case and existing RTW meeting(s)
    - Layout: two-column on desktop
      - Left (main): RtwMeetingForm or RtwQuestionnaire (depending on meeting state)
      - Right (sidebar): GuidancePanel (always visible for managers)
    - Single column on mobile with guidance below
    - Title: "Return to Work" with breadcrumb to case detail
    - If meeting status is SCHEDULED and user clicks "Start Meeting": show RtwQuestionnaire
  </action>
  <verify>Run `npx tsc --noEmit`. Navigate to /sickness/[id]/rtw. Verify scheduling form appears for new meetings. Verify questionnaire has all 5 sections. Verify guidance panel loads with expandable steps. Verify completing questionnaire transitions case.</verify>
  <done>RTW page shows scheduling form, structured questionnaire, and guidance panel. Questionnaire captures all responses and adjustments. Guidance panel shows step-by-step prompts with engagement tracking. Two-column layout on desktop.</done>
</task>

</tasks>

<verification>
- Schedule RTW meeting → case transitions to RTW_SCHEDULED
- Complete RTW questionnaire → case transitions to RTW_COMPLETED
- Close case action available after RTW_COMPLETED
- Guidance panel shows appropriate script for case state and absence type
- Engagement tracking records which steps manager reviewed
- Mental health absence shows mental-health-specific initial contact guidance
- RTW questionnaire captures all 5 sections plus adjustments
</verification>

<success_criteria>
- POST /api/sickness-cases/[id]/rtw-meeting creates meeting and transitions to RTW_SCHEDULED
- PATCH with action 'complete' transitions to RTW_COMPLETED
- GET /api/guidance/[caseId] returns correct script for case context
- Guidance panel displays dos/don'ts with engagement tracking
- RTW questionnaire has 5 structured sections
- Adjustments recorded as typed array with review dates
- Full RTW workflow: schedule → complete questionnaire → close case
</success_criteria>

<output>
After completion, create `.planning/phases/02-sickness-lifecycle/02-04-SUMMARY.md`
</output>
