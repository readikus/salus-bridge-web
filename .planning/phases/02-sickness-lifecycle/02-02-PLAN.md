---
phase: 02-sickness-lifecycle
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - providers/repositories/sickness-case.repository.ts
  - providers/repositories/case-transition.repository.ts
  - providers/services/sickness-case.service.ts
  - providers/services/workflow.service.ts
  - providers/services/working-days.service.ts
  - app/api/sickness-cases/route.ts
  - app/api/sickness-cases/[id]/route.ts
  - app/api/sickness-cases/[id]/transition/route.ts
  - app/(authenticated)/sickness/report/page.tsx
  - app/(authenticated)/sickness/[id]/page.tsx
  - app/(authenticated)/sickness/history/page.tsx
  - actions/sickness-cases.ts
  - components/sickness-report-form/index.tsx
  - components/sickness-case-detail/index.tsx
  - components/absence-history/index.tsx
autonomous: true

must_haves:
  truths:
    - "Employee can report their own sickness with absence type, start date, and optional notes via a form"
    - "Manager can report sickness on behalf of a direct report by selecting an employee"
    - "Sickness cases follow the validated state machine from REPORTED through to CLOSED with only valid transitions allowed"
    - "Every state transition is logged with timestamp, actor, from-state, to-state, and notes"
    - "Working days lost is auto-calculated excluding weekends and UK bank holidays"
    - "Employee and manager can view chronological absence history with search and filter"
  artifacts:
    - path: "providers/services/workflow.service.ts"
      provides: "State machine transition validation and execution"
      exports: ["WorkflowService"]
    - path: "providers/services/working-days.service.ts"
      provides: "UK bank holiday and working day calculation"
      exports: ["WorkingDaysService"]
    - path: "app/api/sickness-cases/route.ts"
      provides: "List and create sickness cases"
      exports: ["GET", "POST"]
    - path: "app/api/sickness-cases/[id]/transition/route.ts"
      provides: "State transition endpoint"
      exports: ["POST"]
    - path: "app/(authenticated)/sickness/report/page.tsx"
      provides: "Sickness report form page"
    - path: "app/(authenticated)/sickness/history/page.tsx"
      provides: "Absence history with search and filter"
  key_links:
    - from: "providers/services/workflow.service.ts"
      to: "constants/sickness-states.ts"
      via: "Imports VALID_TRANSITIONS for state validation"
      pattern: "VALID_TRANSITIONS"
    - from: "app/api/sickness-cases/[id]/transition/route.ts"
      to: "providers/services/workflow.service.ts"
      via: "Calls WorkflowService.transition()"
      pattern: "WorkflowService\\.transition"
    - from: "components/sickness-report-form/index.tsx"
      to: "app/api/sickness-cases/route.ts"
      via: "POST via action wrapper"
      pattern: "fetchCreateSicknessCase"
---

<objective>
Build sickness case reporting, state machine workflow, and absence history.

Purpose: Deliver the core sickness reporting flow (SICK-01 through SICK-05, WRKF-01 through WRKF-04). Employee reports sick, case is created, state machine validates transitions, working days calculated, history viewable.
Output: Repositories, services, API routes, form UI, case detail page, and absence history page.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sickness-lifecycle/02-RESEARCH.md
@.planning/phases/02-sickness-lifecycle/02-01-SUMMARY.md

@providers/services/tenant.service.ts
@providers/services/audit-log.service.ts
@providers/services/encryption.service.ts
@providers/services/employee.service.ts
@providers/repositories/employee.repository.ts
@app/api/employees/route.ts
@constants/sickness-states.ts
@constants/absence-types.ts
@schemas/sickness-case.ts
@types/database.ts
@types/enums.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sickness case repositories, workflow service, and working days service</name>
  <files>
    providers/repositories/sickness-case.repository.ts
    providers/repositories/case-transition.repository.ts
    providers/services/sickness-case.service.ts
    providers/services/workflow.service.ts
    providers/services/working-days.service.ts
  </files>
  <action>
    **sickness-case.repository.ts:** Static class methods following existing repository pattern (pool.query with parameterised SQL, snake_case columns aliased to camelCase):
    - `findById(id: string, client?)`: SELECT with all columns aliased. Accept optional client for transaction use.
    - `findByOrganisation(organisationId: string, filters?: { status?, employeeId?, search? })`: SELECT with optional WHERE clauses for status, employeeId, and ILIKE search on employee name (JOIN employees). ORDER BY created_at DESC.
    - `findByEmployee(employeeId: string)`: SELECT WHERE employee_id = $1 ORDER BY created_at DESC.
    - `findByManagerTeam(managerId: string, organisationId: string)`: Use recursive CTE from employee.repository.ts pattern to find all employees in reporting chain, then SELECT cases for those employees.
    - `create(data: { organisationId, employeeId, reportedBy, absenceType, absenceStartDate, absenceEndDate?, notesEncrypted? }, client?)`: INSERT RETURNING *. Default status is 'REPORTED'.
    - `updateStatus(id: string, status: string, client?)`: UPDATE status, updated_at WHERE id = $1 RETURNING *. This is ONLY called by WorkflowService -- NOT exposed as a public service method.
    - `updateEndDate(id: string, endDate: string, workingDaysLost: number, client?)`: UPDATE absence_end_date, working_days_lost, updated_at RETURNING *.
    - `updateLongTermFlag(id: string, isLongTerm: boolean, client?)`: UPDATE is_long_term WHERE id = $1.

    **case-transition.repository.ts:** Static class methods:
    - `create(data: { sicknessCaseId, fromStatus, toStatus, action, performedBy, notes? }, client?)`: INSERT RETURNING *.
    - `findByCaseId(caseId: string)`: SELECT ORDER BY created_at ASC (chronological).

    **workflow.service.ts:** The single entry point for all state changes (WRKF-01, WRKF-02, WRKF-03):
    - `transition(caseId, action, userId, organisationId, notes?)`: Wraps in TenantService.withTenant(). Fetches current case, validates transition against VALID_TRANSITIONS, calls SicknessCaseRepository.updateStatus, creates CaseTransition record, calls AuditLogService.log with AuditAction.TRANSITION and AuditEntity.SICKNESS_CASE, checks long-term threshold (WRKF-04) from org settings and updates is_long_term flag. Returns updated case.
    - `getAvailableActions(caseStatus: SicknessState)`: Returns array of valid SicknessAction values for the current state (derived from VALID_TRANSITIONS).

    **working-days.service.ts:** Follows pattern from 02-RESEARCH.md exactly:
    - `getBankHolidays()`: Fetch from GOV.UK API with 24h in-memory cache. Wrap in try/catch with static fallback for 2026 UK bank holidays if API fails. Only use "england-and-wales" events.
    - `calculateWorkingDaysLost(startDate, endDate)`: Use date-fns eachDayOfInterval, isWeekend, format. Filter out weekends and bank holidays. Return count.
    - Install `date-fns` if not already present: `yarn add date-fns`

    **sickness-case.service.ts:** Business logic orchestration:
    - `create(data, userId, organisationId)`: Validate with SicknessCaseSchema. Encrypt notes if provided (EncryptionService.encrypt). Call SicknessCaseRepository.create within TenantService.withTenant. If absenceEndDate provided, calculate working days. Log with AuditLogService. Return case.
    - `getById(id, organisationId)`: Fetch case, decrypt notes if present, return.
    - `getForOrganisation(organisationId, filters)`: Delegate to repository with filters.
    - `getForEmployee(employeeId, organisationId)`: Fetch employee's own cases.
    - `getForManagerTeam(managerId, organisationId)`: Delegate to repository team query.
    - `updateEndDate(id, endDate, organisationId, userId)`: Calculate working days via WorkingDaysService, update case, log audit.
  </action>
  <verify>Run `npx tsc --noEmit` to verify types compile. Verify WorkflowService.transition validates against VALID_TRANSITIONS by checking the code logic. Verify working-days.service.ts has try/catch fallback.</verify>
  <done>All repositories and services exist with correct method signatures. WorkflowService validates transitions against state machine. WorkingDaysService calculates working days with bank holiday exclusion and fallback. Audit logging integrated in all mutations.</done>
</task>

<task type="auto">
  <name>Task 2: Create sickness case API routes</name>
  <files>
    app/api/sickness-cases/route.ts
    app/api/sickness-cases/[id]/route.ts
    app/api/sickness-cases/[id]/transition/route.ts
    actions/sickness-cases.ts
  </files>
  <action>
    Follow existing API route pattern: Auth session check -> permission validation -> service call -> response. Use AuthService pattern from existing routes (e.g., app/api/employees/route.ts).

    **GET /api/sickness-cases (route.ts):**
    - Requires VIEW_SICKNESS_CASES permission
    - Query params: status, employeeId, search, page, pageSize
    - If user is EMPLOYEE role only: return only their own cases (filter by their employee record)
    - If user is MANAGER: return cases for their direct report team only (SicknessCaseService.getForManagerTeam)
    - If user is HR/ORG_ADMIN: return all org cases
    - Return { cases, total }

    **POST /api/sickness-cases (route.ts):**
    - Requires REPORT_SICKNESS permission
    - Parse body with SicknessCaseSchema (from schemas/sickness-case.ts)
    - For employee self-reporting: employeeId must match the requesting user's employee record
    - For manager reporting (SICK-02): validate the target employee is in their reporting chain
    - Call SicknessCaseService.create
    - Return 201 with created case

    **GET /api/sickness-cases/[id] (route.ts):**
    - Requires VIEW_SICKNESS_CASES permission
    - Fetch case by ID, verify the requesting user has access (own case, team member, or HR/admin)
    - Include case transitions (chronological timeline)
    - Return case with transitions

    **PATCH /api/sickness-cases/[id] (route.ts):**
    - Requires MANAGE_SICKNESS_CASES permission
    - Allows updating absenceEndDate (which triggers working days recalculation)
    - Does NOT allow direct status changes (must use transition endpoint)

    **POST /api/sickness-cases/[id]/transition (route.ts):**
    - Requires MANAGE_SICKNESS_CASES permission (or REPORT_SICKNESS for specific actions like ACKNOWLEDGE by employee)
    - Parse body: { action: SicknessAction, notes?: string }
    - Delegate to WorkflowService.transition
    - Returns updated case with new status
    - Returns 400 if transition is invalid (not in VALID_TRANSITIONS)

    **actions/sickness-cases.ts:** Client-side fetch wrappers:
    - `fetchSicknessCases(filters?)`: GET /api/sickness-cases with query params
    - `fetchSicknessCase(id)`: GET /api/sickness-cases/[id]
    - `fetchCreateSicknessCase(data)`: POST /api/sickness-cases
    - `fetchTransitionCase(id, action, notes?)`: POST /api/sickness-cases/[id]/transition
    - `fetchUpdateSicknessCase(id, data)`: PATCH /api/sickness-cases/[id]
    All return typed responses. Follow pattern from existing actions/ files.
  </action>
  <verify>Run `npx tsc --noEmit`. Test with curl: POST to create a case, GET to list, POST transition to move state, verify 400 on invalid transition. Check audit_logs table has entries.</verify>
  <done>All API routes return correct status codes. POST creates sickness case with REPORTED status. State transitions validate against VALID_TRANSITIONS (400 on invalid). Manager can only see team cases. Employee can only see own cases. Actions file provides typed client wrappers.</done>
</task>

<task type="auto">
  <name>Task 3: Create sickness reporting UI and absence history page</name>
  <files>
    components/sickness-report-form/index.tsx
    components/sickness-case-detail/index.tsx
    components/absence-history/index.tsx
    app/(authenticated)/sickness/report/page.tsx
    app/(authenticated)/sickness/[id]/page.tsx
    app/(authenticated)/sickness/history/page.tsx
    components/sidebar/nav-items.ts
  </files>
  <action>
    **components/sickness-report-form/index.tsx:** 'use client' component.
    - React Hook Form with zodResolver using SicknessCaseSchema
    - Absence type select using shadcn Select component with ABSENCE_TYPE_LABELS
    - Start date input (type="date")
    - Optional end date input
    - Optional notes textarea (max 2000 chars)
    - If user is MANAGER or HR: show employee select dropdown (populated from team/org employees). Use existing employee fetch pattern.
    - If user is EMPLOYEE: hide employee select, auto-fill with own employee ID
    - Submit calls fetchCreateSicknessCase, redirects to case detail page on success
    - Loading state with isLoading, error display with hasError pattern
    - Props interface: { employees?: Employee[]; currentEmployeeId?: string; isManagerReporting?: boolean }

    **components/sickness-case-detail/index.tsx:** 'use client' component.
    - Displays case status badge (colour-coded by state), absence type label, dates, working days lost
    - Shows chronological timeline of state transitions (from case_transitions)
    - Shows available actions as buttons (from WorkflowService.getAvailableActions mapped on client side)
    - Each action button triggers fetchTransitionCase with optional notes modal
    - If status has end date: show working days lost count
    - For managers: show guidance prompt link (placeholder for 02-04)
    - Props: { sicknessCase: SicknessCase; transitions: CaseTransition[]; canManage: boolean }

    **components/absence-history/index.tsx:** 'use client' component.
    - TanStack Table with columns: Employee Name, Absence Type, Start Date, End Date, Working Days Lost, Status, Actions
    - Sortable columns (at minimum: start date, status)
    - Filter row: status dropdown (all states), search input (employee name)
    - Pagination matching existing employee list pattern
    - Click row to navigate to case detail
    - Props: { cases: SicknessCase[]; total: number }

    **Page files:**
    - `/sickness/report/page.tsx`: Server component. Fetch current user's employee record and (if manager/HR) team employees. Render SicknessReportForm with appropriate props. Title: "Report Sickness Absence"
    - `/sickness/[id]/page.tsx`: Server component. Fetch case detail + transitions. Check user access (own case, team, or HR/admin). Render SicknessCaseDetail. Title: case status.
    - `/sickness/history/page.tsx`: Server component. Fetch cases based on role (own, team, or org). Render AbsenceHistory table. Title: "Absence History"

    **sidebar/nav-items.ts:** Add sickness navigation items:
    - "Report Sickness" → /sickness/report (visible to EMPLOYEE, MANAGER, HR, ORG_ADMIN)
    - "Absence History" → /sickness/history (visible to EMPLOYEE, MANAGER, HR, ORG_ADMIN)
    Match existing nav item structure and permission filtering.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify pages render at /sickness/report, /sickness/history, /sickness/[id]. Verify form submits successfully and creates a case. Verify absence history table shows cases with sorting and filtering.</verify>
  <done>Report form creates sickness cases for self or team member. Case detail shows status, timeline, and available actions. Absence history shows sortable/filterable table. Sidebar links added. All pages respect role-based access.</done>
</task>

</tasks>

<verification>
- Employee can submit sickness report form → case created with REPORTED status
- Manager can select a team member and report on their behalf
- Case detail page shows status badge and transition timeline
- State transition buttons only show valid actions for current state
- Invalid transitions return 400
- Working days calculated correctly (weekends excluded)
- Absence history table supports sorting and filtering
- Audit log entries created for all mutations
</verification>

<success_criteria>
- POST /api/sickness-cases creates a case with status REPORTED
- POST /api/sickness-cases/[id]/transition validates against VALID_TRANSITIONS
- GET /api/sickness-cases filters by role (own, team, org)
- Absence history page shows TanStack Table with search and status filter
- Sidebar has Report Sickness and Absence History links
- All state transitions logged in case_transitions table
- Working days auto-calculated on end date set
</success_criteria>

<output>
After completion, create `.planning/phases/02-sickness-lifecycle/02-02-SUMMARY.md`
</output>
