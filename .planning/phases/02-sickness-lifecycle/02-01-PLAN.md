---
phase: 02-sickness-lifecycle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/migrations/20260215000001_create_sickness_cases.ts
  - database/migrations/20260215000002_create_fit_notes.ts
  - database/migrations/20260215000003_create_rtw_meetings.ts
  - database/migrations/20260215000004_create_guidance_engagement.ts
  - database/migrations/20260215000005_enable_rls_phase2.ts
  - constants/absence-types.ts
  - constants/sickness-states.ts
  - types/enums.ts
  - types/database.ts
  - constants/permissions.ts
  - schemas/sickness-case.ts
  - schemas/fit-note.ts
  - schemas/rtw-meeting.ts
autonomous: true

must_haves:
  truths:
    - "All Phase 2 database tables exist (sickness_cases, case_transitions, fit_notes, rtw_meetings, guidance_engagement) with correct columns, indexes, and foreign keys"
    - "RLS policies isolate all new tables by organisation_id with platform admin bypass"
    - "TypeScript types, enums, Zod schemas, and permission constants exist for all Phase 2 entities"
  artifacts:
    - path: "database/migrations/20260215000001_create_sickness_cases.ts"
      provides: "sickness_cases and case_transitions tables"
      contains: "CREATE TABLE sickness_cases"
    - path: "database/migrations/20260215000005_enable_rls_phase2.ts"
      provides: "RLS policies for Phase 2 tables"
      contains: "ENABLE ROW LEVEL SECURITY"
    - path: "constants/sickness-states.ts"
      provides: "State machine definition with valid transitions"
      exports: ["SicknessState", "SicknessAction", "VALID_TRANSITIONS"]
    - path: "constants/absence-types.ts"
      provides: "Absence type enum and labels"
      exports: ["AbsenceType", "ABSENCE_TYPE_LABELS"]
    - path: "types/enums.ts"
      provides: "New AuditAction and AuditEntity values for Phase 2"
      contains: "SICKNESS_CASE"
  key_links:
    - from: "constants/sickness-states.ts"
      to: "types/enums.ts"
      via: "SicknessState used in database column type"
      pattern: "SicknessState"
    - from: "constants/permissions.ts"
      to: "types/enums.ts"
      via: "New permissions reference UserRole"
      pattern: "REPORT_SICKNESS"
---

<objective>
Create all Phase 2 database schema, RLS policies, constants, types, and validation schemas.

Purpose: Establish the complete data foundation for the sickness lifecycle before any service/API/UI code. All subsequent plans depend on these tables and type definitions.
Output: 5 migrations, constants files, updated enums, Zod schemas, and updated permissions.
</objective>

<execution_context>
@/Users/ianread/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianread/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sickness-lifecycle/02-RESEARCH.md

@database/migrations/20260214000003_create_employees.ts
@database/migrations/20260214000005_enable_rls.ts
@types/enums.ts
@types/database.ts
@constants/permissions.ts
@constants/notification-privacy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migrations for all Phase 2 tables</name>
  <files>
    database/migrations/20260215000001_create_sickness_cases.ts
    database/migrations/20260215000002_create_fit_notes.ts
    database/migrations/20260215000003_create_rtw_meetings.ts
    database/migrations/20260215000004_create_guidance_engagement.ts
    database/migrations/20260215000005_enable_rls_phase2.ts
  </files>
  <action>
    Create 5 Knex migrations using `knex.raw()` for full SQL control (matching existing migration pattern):

    **Migration 1 - sickness_cases + case_transitions (20260215000001):**
    - `sickness_cases` table: id (UUID PK, gen_random_uuid), organisation_id (FK organisations, CASCADE), employee_id (FK employees, CASCADE), reported_by (FK users), status (VARCHAR(30) DEFAULT 'REPORTED'), absence_type (VARCHAR(50) NOT NULL), absence_start_date (DATE NOT NULL), absence_end_date (DATE), working_days_lost (INTEGER), notes_encrypted (TEXT), is_long_term (BOOLEAN DEFAULT false), created_at (TIMESTAMPTZ DEFAULT now()), updated_at (TIMESTAMPTZ DEFAULT now())
    - Indexes: idx_sickness_cases_org (organisation_id), idx_sickness_cases_employee (employee_id), idx_sickness_cases_status (status)
    - `case_transitions` table: id (UUID PK), sickness_case_id (FK sickness_cases, CASCADE), from_status (VARCHAR(30)), to_status (VARCHAR(30) NOT NULL), action (VARCHAR(50) NOT NULL), performed_by (FK users), notes (TEXT), created_at (TIMESTAMPTZ DEFAULT now())
    - Index: idx_case_transitions_case (sickness_case_id)
    - Down: DROP TABLE case_transitions, DROP TABLE sickness_cases (order matters for FK)

    **Migration 2 - fit_notes (20260215000002):**
    - `fit_notes` table: id (UUID PK), organisation_id (FK organisations, CASCADE), sickness_case_id (FK sickness_cases, CASCADE), employee_id (FK employees, CASCADE), uploaded_by (FK users), storage_path (TEXT NOT NULL), file_name (VARCHAR(255) NOT NULL), file_size_bytes (INTEGER), content_type (VARCHAR(100)), fit_note_status (VARCHAR(20) NOT NULL), start_date (DATE NOT NULL), end_date (DATE), functional_effects (JSONB DEFAULT '[]'), notes_encrypted (TEXT), created_at (TIMESTAMPTZ DEFAULT now())
    - Indexes: idx_fit_notes_case (sickness_case_id), idx_fit_notes_expiry (end_date) WHERE end_date IS NOT NULL

    **Migration 3 - rtw_meetings (20260215000003):**
    - `rtw_meetings` table: id (UUID PK), organisation_id (FK organisations, CASCADE), sickness_case_id (FK sickness_cases, CASCADE), employee_id (FK employees), scheduled_by (FK users), scheduled_date (TIMESTAMPTZ NOT NULL), completed_date (TIMESTAMPTZ), status (VARCHAR(20) DEFAULT 'SCHEDULED'), questionnaire_responses (JSONB), outcomes_encrypted (TEXT), adjustments (JSONB DEFAULT '[]'), created_at (TIMESTAMPTZ DEFAULT now()), updated_at (TIMESTAMPTZ DEFAULT now())

    **Migration 4 - guidance_engagement (20260215000004):**
    - `guidance_engagement` table: id (UUID PK), organisation_id (FK organisations, CASCADE), sickness_case_id (FK sickness_cases, CASCADE), user_id (FK users), guidance_type (VARCHAR(50) NOT NULL), guidance_step (VARCHAR(100) NOT NULL), engaged_at (TIMESTAMPTZ DEFAULT now())
    - Index: idx_guidance_case (sickness_case_id)

    **Migration 5 - RLS for Phase 2 tables (20260215000005):**
    - Enable RLS on: sickness_cases, case_transitions, fit_notes, rtw_meetings, guidance_engagement
    - For each table add org_isolation policy: `USING (organisation_id = current_setting('app.current_organisation_id', true)::uuid)` -- except case_transitions which needs a JOIN: `USING (sickness_case_id IN (SELECT id FROM sickness_cases WHERE organisation_id = current_setting('app.current_organisation_id', true)::uuid))`
    - For each table add platform_admin_bypass policy: `USING (current_setting('app.is_platform_admin', true)::boolean = true)`
    - Down: drop all policies then disable RLS

    Follow existing migration naming/structure exactly. All down migrations must reverse in correct FK order.
  </action>
  <verify>Run `npx knex migrate:up` for each migration in sequence and verify no SQL errors. Run `npx knex migrate:down` in reverse to verify rollback works. Check with `\dt` that all tables exist with correct columns.</verify>
  <done>5 migration files exist. All tables created with correct columns, foreign keys, indexes, and RLS policies. Rollback works cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Create constants, types, enums, permissions, and Zod schemas</name>
  <files>
    constants/absence-types.ts
    constants/sickness-states.ts
    types/enums.ts
    types/database.ts
    constants/permissions.ts
    schemas/sickness-case.ts
    schemas/fit-note.ts
    schemas/rtw-meeting.ts
  </files>
  <action>
    **constants/absence-types.ts:** Create AbsenceType enum (MUSCULOSKELETAL, MENTAL_HEALTH, RESPIRATORY, SURGICAL, OTHER) and ABSENCE_TYPE_LABELS record with human-friendly descriptions as shown in research.

    **constants/sickness-states.ts:** Create SicknessState enum (REPORTED, TRACKING, FIT_NOTE_RECEIVED, RTW_SCHEDULED, RTW_COMPLETED, CLOSED), SicknessAction enum (ACKNOWLEDGE, RECEIVE_FIT_NOTE, SCHEDULE_RTW, COMPLETE_RTW, CLOSE_CASE, REOPEN), and VALID_TRANSITIONS map exactly as in 02-RESEARCH.md. Also export FitNoteStatus enum (NOT_FIT, MAY_BE_FIT), FunctionalEffect enum (PHASED_RETURN, ALTERED_HOURS, AMENDED_DUTIES, ADAPTED_WORKPLACE), and RtwMeetingStatus enum (SCHEDULED, COMPLETED, CANCELLED).

    **types/enums.ts:** Add new values to existing enums:
    - AuditAction: add TRANSITION, UPLOAD, DOWNLOAD, SCHEDULE, SEND
    - AuditEntity: add SICKNESS_CASE, FIT_NOTE, RTW_MEETING, GUIDANCE, NOTIFICATION
    - Keep ALL existing enum values unchanged.

    **types/database.ts:** Add interfaces for new entities:
    - SicknessCase: { id, organisationId, employeeId, reportedBy, status, absenceType, absenceStartDate, absenceEndDate, workingDaysLost, notesEncrypted, isLongTerm, createdAt, updatedAt }
    - CaseTransition: { id, sicknessCaseId, fromStatus, toStatus, action, performedBy, notes, createdAt }
    - FitNote: { id, organisationId, sicknessCaseId, employeeId, uploadedBy, storagePath, fileName, fileSizeBytes, contentType, fitNoteStatus, startDate, endDate, functionalEffects, notesEncrypted, createdAt }
    - RtwMeeting: { id, organisationId, sicknessCaseId, employeeId, scheduledBy, scheduledDate, completedDate, status, questionnaireResponses, outcomesEncrypted, adjustments, createdAt, updatedAt }
    - GuidanceEngagement: { id, organisationId, sicknessCaseId, userId, guidanceType, guidanceStep, engagedAt }
    All field names camelCase (matching SQL alias convention). Keep ALL existing interfaces unchanged.

    **constants/permissions.ts:** Add new permissions to the PERMISSIONS object:
    - REPORT_SICKNESS: "report:sickness"
    - VIEW_SICKNESS_CASES: "view:sickness_cases"
    - MANAGE_SICKNESS_CASES: "manage:sickness_cases"
    - VIEW_FIT_NOTES: "view:fit_notes"
    - UPLOAD_FIT_NOTES: "upload:fit_notes"
    - SCHEDULE_RTW: "schedule:rtw"
    - COMPLETE_RTW: "complete:rtw"
    - VIEW_GUIDANCE: "view:guidance"
    - VIEW_ABSENCE_CALENDAR: "view:absence_calendar"

    Update ROLE_PERMISSIONS:
    - EMPLOYEE: add REPORT_SICKNESS, VIEW_SICKNESS_CASES (own-only enforced at API level), VIEW_FIT_NOTES (own-only)
    - MANAGER: add VIEW_SICKNESS_CASES, SCHEDULE_RTW, COMPLETE_RTW, VIEW_GUIDANCE, VIEW_ABSENCE_CALENDAR, REPORT_SICKNESS
    - HR: add all sickness permissions (REPORT_SICKNESS, VIEW_SICKNESS_CASES, MANAGE_SICKNESS_CASES, VIEW_FIT_NOTES, UPLOAD_FIT_NOTES, SCHEDULE_RTW, COMPLETE_RTW, VIEW_GUIDANCE, VIEW_ABSENCE_CALENDAR)
    - ORG_ADMIN: add all sickness permissions (same as HR)
    - PLATFORM_ADMIN: add all sickness permissions

    **schemas/sickness-case.ts:** Zod schema for creating a sickness case:
    - absenceType: z.nativeEnum(AbsenceType)
    - absenceStartDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/) (ISO date)
    - absenceEndDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional()
    - notes: z.string().max(2000).optional()
    - employeeId: z.string().uuid() (for manager-initiated reporting)

    **schemas/fit-note.ts:** Zod schema for fit note metadata:
    - fitNoteStatus: z.enum(["NOT_FIT", "MAY_BE_FIT"])
    - startDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/)
    - endDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional()
    - functionalEffects: z.array(z.enum(["phased_return", "altered_hours", "amended_duties", "adapted_workplace"])).default([])
    - notes: z.string().max(2000).optional()

    **schemas/rtw-meeting.ts:** Zod schema for RTW meeting:
    - scheduledDate: z.string().datetime()
    - questionnaireResponses: z.record(z.string(), z.any()).optional()
    - outcomes: z.string().max(5000).optional()
    - adjustments: z.array(z.object({ type: z.string(), description: z.string(), reviewDate: z.string().optional() })).default([])
  </action>
  <verify>Run `npx tsc --noEmit` to verify all types compile. Verify imports resolve correctly across files. Check that existing code (Phase 1) still compiles without errors.</verify>
  <done>All constants, types, enums, permissions, and Zod schemas exist. TypeScript compiles cleanly. Existing Phase 1 code unaffected. New permissions map correctly to roles.</done>
</task>

</tasks>

<verification>
- All 5 Phase 2 database tables exist with correct schema
- RLS policies active on all new tables
- TypeScript compiles with `npx tsc --noEmit`
- No regressions in existing Phase 1 code
- Migrations can roll forward and backward cleanly
</verification>

<success_criteria>
- 5 migration files in database/migrations/ with correct timestamps
- sickness_cases, case_transitions, fit_notes, rtw_meetings, guidance_engagement tables created
- RLS policies match existing pattern from 20260214000005
- SicknessState, SicknessAction, VALID_TRANSITIONS exported from constants
- AbsenceType enum and labels exported
- 9 new permissions mapped to appropriate roles
- Zod schemas validate sickness case, fit note, and RTW meeting input
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-sickness-lifecycle/02-01-SUMMARY.md`
</output>
